import{initializeApp as qt}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as Qt,GoogleAuthProvider as zt,onAuthStateChanged as Kt,signInWithPopup as Gt,signInWithEmailAndPassword as Wt,createUserWithEmailAndPassword as Vt,signOut as Yt}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getDatabase as Jt,ref as Be,get as lt,update as Xt,child as me,onValue as ze,off as Ke,set as $e,remove as Pe}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();const V={OFF:0,ALL:1,ONE:2},Zt=["HI_RES_LOSSLESS","LOSSLESS","HIGH","LOW"],es={HI_RES_LOSSLESS:["HI_RES_LOSSLESS","HIRES_LOSSLESS","HIRESLOSSLESS","HIFI_PLUS","HI_RES_FLAC","HI_RES","HIRES","MASTER","MASTER_QUALITY","MQA"],LOSSLESS:["LOSSLESS","HIFI"],HIGH:["HIGH","HIGH_QUALITY"],LOW:["LOW","LOW_QUALITY"]},Tt="Too Many Requests. Please wait a moment and try again.",de='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="7 3 21 12 7 21 7 3"></polygon></svg>',ts='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',ss='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>',ns='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>',fe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',as='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>',ie='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',Ce='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',is='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',Te=n=>{if(isNaN(n))return"0:00";const e=Math.floor(n/60),t=Math.floor(n%60);return`${e}:${String(t).padStart(2,"0")}`},F=(n,e=!1)=>`<div class="placeholder-text ${e?"loading":""}">${n}</div>`,O=new WeakMap,ge=n=>n?n.replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim():"Unknown",Et=n=>{switch(n){case"LOW":case"HIGH":return"m4a";default:return"flac"}},je=(n,e)=>{const t=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",s=Et(e),a=n.artist?.name||n.artists?.[0]?.name||"Unknown Artist",i={trackNumber:n.trackNumber,artist:a,title:te(n),album:n.album?.title};return qe(t,i)+"."+s},rs=n=>n?n.trim().toUpperCase().replace(/[^A-Z0-9]+/g,"_"):"",St=n=>{if(!n)return null;const e=rs(n);for(const[t,s]of Object.entries(es))if(s.includes(e))return t;return null},ct=n=>{if(!Array.isArray(n))return null;const e=[];for(const t of n){if(typeof t!="string")continue;const s=St(t);s&&!e.includes(s)&&e.push(s)}return Lt(e)},Lt=n=>{let e=null,t=1/0;for(const s of n){if(!s)continue;const a=Zt.indexOf(s),i=a===-1?1/0:a;i<t&&(e=s,t=i)}return e},os=n=>{if(!n)return null;const e=[ct(n.mediaMetadata?.tags),ct(n.album?.mediaMetadata?.tags),St(n.audioQuality)];return Lt(e)},_e=n=>new Promise(e=>setTimeout(e,n)),Ge=n=>n?.explicit===!0||n?.explicitLyrics===!0,ls=(n,e)=>{let t;return function(...a){const i=()=>{clearTimeout(t),n(...a)};clearTimeout(t),t=setTimeout(i,e)}},W=n=>typeof n!="string"?n:n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),te=(n,{fallback:e="Unknown Title"}={})=>n?.title?n?.version?`${n.title} (${n.version})`:n.title:e,ee=(n={},{fallback:e="Unknown Artist"}={})=>n?.artists?.length?n.artists.map(t=>t?.name).join(", "):e,dt=(n={},{fallback:e="Unknown Artist"}={})=>n?.artists?.length?n.artists.map(t=>`<span class="artist-link" data-artist-id="${t.id}">${t.name}</span>`).join(", "):e,qe=(n,e)=>{let t=n;return t=t.replace(/\{trackNumber\}/g,e.trackNumber?String(e.trackNumber).padStart(2,"0"):"00"),t=t.replace(/\{artist\}/g,ge(e.artist||"Unknown Artist")),t=t.replace(/\{title\}/g,ge(e.title||"Unknown Title")),t=t.replace(/\{album\}/g,ge(e.album||"Unknown Album")),t=t.replace(/\{albumArtist\}/g,ge(e.albumArtist||"Unknown Artist")),t=t.replace(/\{albumTitle\}/g,ge(e.albumTitle||"Unknown Album")),t=t.replace(/\{year\}/g,e.year||"Unknown"),t},Re=n=>!Array.isArray(n)||n.length===0?0:n.reduce((e,t)=>e+(t.duration||0),0),De=n=>{if(!n||isNaN(n))return"0 min";const e=Math.floor(n/3600),t=Math.floor(n%3600/60);return e>0?`${e} hr ${t} min`:`${t} min`},ve=new Map;async function Me(n,e){if(!e)return null;if(ve.has(e))return ve.get(e);const t=async s=>{try{const a=`https://corsproxy.io/?${encodeURIComponent(s)}`,i=await fetch(a);if(i.ok)return await i.blob()}catch(a){console.warn("Proxy fetch failed:",a)}return null};try{const s=n.getCoverUrl(e,"1280"),a=await fetch(s);if(a.ok){const i=await a.blob();return ve.set(e,i),i}else{const i=await t(s);if(i)return ve.set(e,i),i}}catch{const a=n.getCoverUrl(e,"1280"),i=await t(a);if(i)return ve.set(e,i),i}return null}class cs{constructor(e={}){this.memoryCache=new Map,this.maxSize=e.maxSize||200,this.ttl=e.ttl||1e3*60*30,this.dbName="monochrome-cache",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){if(!(typeof indexedDB>"u"))return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e(this.db)},s.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains("responses")||i.createObjectStore("responses",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})}})}generateKey(e,t){const s=typeof t=="object"?JSON.stringify(t):String(t);return`${e}:${s}`}async get(e,t){const s=this.generateKey(e,t);if(this.memoryCache.has(s)){const a=this.memoryCache.get(s);if(Date.now()-a.timestamp<this.ttl)return a.data;this.memoryCache.delete(s)}if(this.db)try{const a=await this.getFromIndexedDB(s);if(a&&Date.now()-a.timestamp<this.ttl)return this.memoryCache.set(s,a),a.data}catch(a){console.debug("IndexedDB read error:",a)}return null}async set(e,t,s){const a=this.generateKey(e,t),i={key:a,data:s,timestamp:Date.now()};if(this.memoryCache.set(a,i),this.memoryCache.size>this.maxSize){const r=this.memoryCache.keys().next().value;this.memoryCache.delete(r)}if(this.db)try{await this.setInIndexedDB(i)}catch(r){console.debug("IndexedDB write error:",r)}}getFromIndexedDB(e){return new Promise((t,s)=>{if(!this.db){t(null);return}const r=this.db.transaction(["responses"],"readonly").objectStore("responses").get(e);r.onsuccess=()=>t(r.result||null),r.onerror=()=>s(r.error)})}setInIndexedDB(e){return new Promise((t,s)=>{if(!this.db){t();return}const r=this.db.transaction(["responses"],"readwrite").objectStore("responses").put(e);r.onsuccess=()=>t(),r.onerror=()=>s(r.error)})}async clear(){if(this.memoryCache.clear(),this.db)return new Promise((e,t)=>{const i=this.db.transaction(["responses"],"readwrite").objectStore("responses").clear();i.onsuccess=()=>e(),i.onerror=()=>t(i.error)})}async clearExpired(){const e=Date.now(),t=[];for(const[s,a]of this.memoryCache.entries())e-a.timestamp>=this.ttl&&t.push(s);if(t.forEach(s=>this.memoryCache.delete(s)),this.db)try{const i=this.db.transaction(["responses"],"readwrite").objectStore("responses").index("timestamp"),r=IDBKeyRange.upperBound(e-this.ttl),l=i.openCursor(r);l.onsuccess=o=>{const c=o.target.result;c&&(c.delete(),c.continue())}}catch(s){console.debug("Failed to clear expired IndexedDB entries:",s)}}getCacheStats(){return{memoryEntries:this.memoryCache.size,maxSize:this.maxSize,ttl:this.ttl}}}const ds="Monochrome",us="Unknown Title",ut="Unknown Artist",ms="Unknown Album";async function It(n,e,t,s){const a=Et(s);return a==="flac"?await hs(n,e,t):a==="m4a"?await ws(n,e,t):n}async function hs(n,e,t){try{const s=await n.arrayBuffer(),a=new DataView(s);if(!fs(a))return console.warn("Not a valid FLAC file, returning original"),n;const i=gs(a),r=ps(e);let l=null;if(e.album?.cover)try{l=await ys(e.album.cover,t)}catch(c){console.warn("Failed to embed album art:",c)}const o=bs(a,i,r,l);return new Blob([o],{type:"audio/flac"})}catch(s){return console.error("Failed to add FLAC metadata:",s),n}}function fs(n){return n.byteLength>=4&&n.getUint8(0)===102&&n.getUint8(1)===76&&n.getUint8(2)===97&&n.getUint8(3)===67}function gs(n){const e=[];let t=4;for(;t+4<=n.byteLength;){const s=n.getUint8(t),a=(s&128)!==0,i=s&127,r=n.getUint8(t+1)<<16|n.getUint8(t+2)<<8|n.getUint8(t+3);if(t+4+r>n.byteLength){console.warn("Invalid block size detected, stopping parse");break}if(e.push({type:i,isLast:a,size:r,offset:t+4,headerOffset:t}),t+=4+r,a){e.audioDataOffset=t;break}}return e}function ps(n){const e=[];n.title&&e.push(["TITLE",n.title]),n.artist?.name&&e.push(["ARTIST",n.artist.name]),n.album?.title&&e.push(["ALBUM",n.album.title]),n.album?.artist?.name&&e.push(["ALBUMARTIST",n.album.artist.name]),n.trackNumber&&e.push(["TRACKNUMBER",String(n.trackNumber)]),n.album?.numberOfTracks&&e.push(["TRACKTOTAL",String(n.album.numberOfTracks)]);const t=n.album?.releaseDate||(n.streamStartDate?n.streamStartDate.split("T")[0]:"");if(t)try{const h=new Date(t).getFullYear();isNaN(h)||e.push(["DATE",String(h)])}catch{}n.copyright&&e.push(["COPYRIGHT",n.copyright]),n.isrc&&e.push(["ISRC",n.isrc]);const s=ds,a=new TextEncoder().encode(s);let i=4+a.length+4;const r=e.map(([h,u])=>{const m=`${h}=${u}`,f=new TextEncoder().encode(m);return i+=4+f.length,f}),l=new ArrayBuffer(i),o=new DataView(l),c=new Uint8Array(l);let d=0;o.setUint32(d,a.length,!0),d+=4,c.set(a,d),d+=a.length,o.setUint32(d,e.length,!0),d+=4;for(const h of r)o.setUint32(d,h.length,!0),d+=4,c.set(h,d),d+=h.length;return c}async function ys(n,e){try{const t=await Me(e,n);if(!t)throw new Error("Failed to fetch album art");const s=new Uint8Array(await t.arrayBuffer()),a=t.type||"image/jpeg",i=new TextEncoder().encode(a),l=new TextEncoder().encode(""),o=8+i.length+4+l.length+4+4+4+4+4+s.length,c=new ArrayBuffer(o),d=new DataView(c),h=new Uint8Array(c);let u=0;return d.setUint32(u,3,!1),u+=4,d.setUint32(u,i.length,!1),u+=4,h.set(i,u),u+=i.length,d.setUint32(u,l.length,!1),u+=4,l.length>0&&(h.set(l,u),u+=l.length),d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,s.length,!1),u+=4,h.set(s,u),h}catch(t){return console.error("Failed to create FLAC picture block:",t),null}}function bs(n,e,t,s){const a=new Uint8Array(n.buffer),i=e.filter(f=>f.type!==4&&f.type!==6);let r=4;for(const f of i)r+=4+f.size;r+=4+t.length,s&&(r+=4+s.length);const l=e.audioDataOffset;if(l===void 0)throw new Error("Invalid FLAC file structure: unable to locate audio data stream");const o=n.byteLength-l;r+=o;const c=new Uint8Array(r);let d=0;c[d++]=102,c[d++]=76,c[d++]=97,c[d++]=67;for(let f=0;f<i.length;f++){const g=i[f],y=0|g.type;c[d++]=y,c[d++]=g.size>>16&255,c[d++]=g.size>>8&255,c[d++]=g.size&255,c.set(a.subarray(g.offset,g.offset+g.size),d),d+=g.size}const h=d,u=4;c[d++]=u,c[d++]=t.length>>16&255,c[d++]=t.length>>8&255,c[d++]=t.length&255,c.set(t,d),d+=t.length;let m=h;if(s){const f=d,g=6;c[d++]=g,c[d++]=s.length>>16&255,c[d++]=s.length>>8&255,c[d++]=s.length&255,c.set(s,d),d+=s.length,m=f}return c[m]|=128,o>0&&c.set(a.subarray(l,l+o),d),c}async function ws(n,e,t){try{const s=await n.arrayBuffer(),a=new DataView(s),i=xt(a),r=vs(e);if(e.album?.cover)try{const o=await Me(t,e.album.cover);if(o){const c=new Uint8Array(await o.arrayBuffer());r.cover={type:"covr",data:c}}}catch(o){console.warn("Failed to embed album art in M4A:",o)}const l=ks(a,i,r);return new Blob([l],{type:"audio/mp4"})}catch(s){return console.error("Failed to add M4A metadata:",s),n}}function xt(n){const e=[];let t=0;for(;t+8<=n.byteLength;){let s=n.getUint32(t,!1);if(s===0)s=n.byteLength-t;else if(s===1){if(t+16>n.byteLength)break;const i=n.getUint32(t+8,!1),r=n.getUint32(t+12,!1);if(i!==0){console.warn("64-bit MP4 atoms larger than 4GB are not supported - file may be processed incompletely");break}s=r}if(s<8||t+s>n.byteLength)break;const a=String.fromCharCode(n.getUint8(t+4),n.getUint8(t+5),n.getUint8(t+6),n.getUint8(t+7));e.push({type:a,offset:t,size:s}),t+=s}return e}function vs(n){const e={"©nam":n.title||us,"©ART":n.artist?.name||ut,"©alb":n.album?.title||ms,aART:n.album?.artist?.name||ut};n.trackNumber&&(e.trkn=n.trackNumber);const t=n.album?.releaseDate||(n.streamStartDate?n.streamStartDate.split("T")[0]:"");if(t)try{const s=new Date(t).getFullYear();isNaN(s)||(e["©day"]=String(s))}catch{}return{tags:e}}function ks(n,e,t){const s=new Uint8Array(n.buffer),a=e.find(v=>v.type==="moov");if(!a)return console.warn("No moov atom found in M4A file"),s;const i=Ts(t),l=xt(new DataView(s.buffer,a.offset+8,a.size-8)).filter(v=>v.type!=="udta");let o=8;for(const v of l)o+=v.size;o+=i.length;const c=o-a.size,d=s.length+c,h=new Uint8Array(d);let u=0,m=0;const f=e.filter(v=>v.offset<a.offset);for(const v of f)h.set(s.subarray(v.offset,v.offset+v.size),u),u+=v.size,m+=v.size;h[u++]=o>>24&255,h[u++]=o>>16&255,h[u++]=o>>8&255,h[u++]=o&255,h[u++]=109,h[u++]=111,h[u++]=111,h[u++]=118;for(const v of l){a.offset+8+v.offset;const I=a.offset+8+v.offset;h.set(s.subarray(I,I+v.size),u),u+=v.size}h.set(i,u),u+=i.length,m=a.offset+a.size;const g=e.find(v=>v.type==="mdat");return g&&a.offset<g.offset&&Is(h,u-o,o,c),m<s.length&&h.set(s.subarray(m),u),h}function Ts(n){const{tags:e,cover:t}=n,s=[];for(const[y,v]of Object.entries(e))y==="trkn"?s.push(Ss(y,v)):s.push(Es(y,v));t&&s.push(Ls(t.data));const a=8+s.reduce((y,v)=>y+v.length,0),i=new Uint8Array(a);let r=0;Z(i,r,a,"ilst"),r+=8;for(const y of s)i.set(y,r),r+=y.length;const l=12+a,o=new Uint8Array(l);r=0,Z(o,r,l,"meta"),r+=8,o[r++]=0,o[r++]=0,o[r++]=0,o[r++]=0,o.set(i,r);const c=new Uint8Array([0,0,0,0,0,0,0,0,109,100,105,114,97,112,112,108,0,0,0,0,0,0,0,0,0,0]),d=8+c.length,h=new Uint8Array(d);Z(h,0,d,"hdlr"),h.set(c,8);const u=12+d+a,m=new Uint8Array(u);r=0,Z(m,r,u,"meta"),r+=8,m[r++]=0,m[r++]=0,m[r++]=0,m[r++]=0,m.set(h,r),r+=d,m.set(i,r);const f=8+u,g=new Uint8Array(f);return Z(g,0,f,"udta"),g.set(m,8),g}function Es(n,e){const t=new TextEncoder().encode(e),s=16+t.length,a=8+s,i=new Uint8Array(a);let r=0;return Z(i,r,a,n),r+=8,Z(i,r,s,"data"),r+=8,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=1,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=0,i.set(t,r),i}function Ss(n,e){const a=new Uint8Array(32);let i=0;Z(a,i,32,n),i+=8,Z(a,i,24,"data"),i+=8,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0;const r=parseInt(e)||0;return a[i++]=r>>8&255,a[i++]=r&255,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a}function Ls(n){const e=16+n.length,t=8+e,s=new Uint8Array(t);let a=0;Z(s,a,t,"covr"),a+=8,Z(s,a,e,"data"),a+=8;let i=13;return n[0]===137&&n[1]===80&&(i=14),s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=i,s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=0,s.set(n,a),s}function Z(n,e,t,s){n[e++]=t>>24&255,n[e++]=t>>16&255,n[e++]=t>>8&255,n[e++]=t&255;for(let a=0;a<4;a++)n[e++]=s.charCodeAt(a)}function Is(n,e,t,s){const a=new DataView(n.buffer,n.byteOffset,n.byteLength);let i=e+8;const r=e+t;At(a,i,r,s)}function At(n,e,t,s){let a=e;for(;a+8<=t;){const i=n.getUint32(a,!1),r=String.fromCharCode(n.getUint8(a+4),n.getUint8(a+5),n.getUint8(a+6),n.getUint8(a+7));if(i<8)break;if(r==="trak"||r==="mdia"||r==="minf"||r==="stbl")At(n,a+8,a+i,s);else if(r==="stco"){const l=n.getUint32(a+12,!1);for(let o=0;o<l;o++){const c=a+16+o*4,d=n.getUint32(c,!1);n.setUint32(c,d+s,!1)}}else if(r==="co64"){const l=n.getUint32(a+12,!1);for(let o=0;o<l;o++){const c=a+16+o*8,d=n.getUint32(c,!1);let u=n.getUint32(c+4,!1)+s,m=0;u>4294967295&&(m=Math.floor(u/4294967296),u=u>>>0);const f=d+m;n.setUint32(c,f,!1),n.setUint32(c+4,u,!1)}}a+=i}}class xs{constructor(e){this.settings=e,this.cache=new cs({maxSize:200,ttl:1e3*60*30}),this.streamCache=new Map,setInterval(()=>{this.cache.clearExpired(),this.pruneStreamCache()},1e3*60*5)}pruneStreamCache(){if(this.streamCache.size>50){const e=Array.from(this.streamCache.entries());e.slice(0,e.length-50).forEach(([s])=>this.streamCache.delete(s))}}async fetchWithRetry(e,t={}){const s=t.type||"api",a=await this.settings.getInstances(s);if(a.length===0)throw new Error(`No API instances configured for type: ${s}`);const i=3;let r=null;for(const l of a){const o=l.endsWith("/")?`${l}${e.substring(1)}`:`${l}${e}`;for(let c=1;c<=i;c++)try{const d=await fetch(o,{signal:t.signal});if(d.status===429){const h=d.headers.get("Retry-After");let u=2e3*c;if(h){const m=parseInt(h,10);isNaN(m)||(u=m*1e3)}console.warn(`Rate limit hit. Waiting ${u}ms before retry ${c}/${i}...`),await _e(u);continue}if(d.ok)return d;if(d.status===401){let h=await d.clone().json();if(h?.subStatus===11002&&(r=new Error(h?.userMessage||"Authentication failed"),c<i)){await _e(200*c);continue}}if(d.status>=500&&c<i){await _e(200*c);continue}r=new Error(`Request failed with status ${d.status}`);break}catch(d){if(d.name==="AbortError")throw d;r=d,c<i&&await _e(200*c)}}throw r||new Error(`All API instances failed for: ${e}`)}findSearchSection(e,t,s){if(!(!e||typeof e!="object")){if(Array.isArray(e)){for(const a of e){const i=this.findSearchSection(a,t,s);if(i)return i}return}if(!s.has(e)){if(s.add(e),"items"in e&&Array.isArray(e.items))return e;if(t in e){const a=this.findSearchSection(e[t],t,s);if(a)return a}for(const a of Object.values(e)){const i=this.findSearchSection(a,t,s);if(i)return i}}}}buildSearchResponse(e){const t=e?.items??[];return{items:t,limit:e?.limit??t.length,offset:e?.offset??0,totalNumberOfItems:e?.totalNumberOfItems??t.length}}normalizeSearchResponse(e,t){const s=this.findSearchSection(e,t,new Set);return this.buildSearchResponse(s)}prepareTrack(e){let t=e;!e.artist&&Array.isArray(e.artists)&&e.artists.length>0&&(t={...e,artist:e.artists[0]});const s=os(t);return s&&t.audioQuality!==s&&(t={...t,audioQuality:s}),t}prepareAlbum(e){return!e.artist&&Array.isArray(e.artists)&&e.artists.length>0?{...e,artist:e.artists[0]}:e}preparePlaylist(e){return e}prepareArtist(e){return!e.type&&Array.isArray(e.artistTypes)&&e.artistTypes.length>0?{...e,type:e.artistTypes[0]}:e}parseTrackLookup(e){const t=Array.isArray(e)?e:[e];let s,a,i;for(const r of t)if(!(!r||typeof r!="object")){if(!s&&"duration"in r){s=r;continue}if(!a&&"manifest"in r){a=r;continue}if(!i&&"OriginalTrackUrl"in r){const l=r.OriginalTrackUrl;typeof l=="string"&&(i=l)}}if(!s||!a)throw new Error("Malformed track response");return{track:s,info:a,originalTrackUrl:i}}extractStreamUrlFromManifest(e){try{const t=atob(e);try{const s=JSON.parse(t);if(s?.urls?.[0])return s.urls[0]}catch{const s=t.match(/https?:\/\/[\w\-.~:?#[@!$&'()*+,;=%/]+/);return s?s[0]:null}}catch(t){return console.error("Failed to decode manifest:",t),null}}deduplicateAlbums(e){const t=new Map;for(const s of e){const a=JSON.stringify([s.title,s.numberOfTracks||0]);if(t.has(a)){const i=t.get(a);if(s.explicit&&!i.explicit){t.set(a,s);continue}if(!s.explicit&&i.explicit)continue;const r=i.mediaMetadata?.tags?.length||0;(s.mediaMetadata?.tags?.length||0)>r&&t.set(a,s)}else t.set(a,s)}return Array.from(t.values())}async searchTracks(e,t={}){const s=await this.cache.get("search_tracks",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?s=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"tracks"),l={...r,items:r.items.map(o=>this.prepareTrack(o))};return await this.cache.set("search_tracks",e,l),l}catch(a){if(a.name==="AbortError")throw a;return console.error("Track search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchArtists(e,t={}){const s=await this.cache.get("search_artists",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?a=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"artists"),l={...r,items:r.items.map(o=>this.prepareArtist(o))};return await this.cache.set("search_artists",e,l),l}catch(a){if(a.name==="AbortError")throw a;return console.error("Artist search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchAlbums(e,t={}){const s=await this.cache.get("search_albums",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?al=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"albums"),l=r.items.map(c=>this.prepareAlbum(c)),o={...r,items:this.deduplicateAlbums(l)};return await this.cache.set("search_albums",e,o),o}catch(a){if(a.name==="AbortError")throw a;return console.error("Album search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchPlaylists(e,t={}){const s=await this.cache.get("search_playlists",e);if(s)return s;try{const i=await(await this.fetchWithRetry(`/search/?p=${encodeURIComponent(e)}`,t)).json(),r=this.normalizeSearchResponse(i,"playlists"),l={...r,items:r.items.map(o=>this.preparePlaylist(o))};return await this.cache.set("search_playlists",e,l),l}catch(a){if(a.name==="AbortError")throw a;return console.error("Playlist search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async getAlbum(e){const t=await this.cache.get("album",e);if(t)return t;const a=await(await this.fetchWithRetry(`/album/?id=${e}`)).json(),i=a.data||a;let r,l;if(i&&typeof i=="object"&&!Array.isArray(i)&&(("numberOfTracks"in i||"title"in i)&&(r=this.prepareAlbum(i)),"items"in i&&(l=i,!r&&i.items&&i.items.length>0))){const d=i.items[0],h=d.item||d;h&&h.album&&(r=this.prepareAlbum(h.album))}if(!r)throw new Error("Album not found");if(r&&!r.artist&&l?.items&&l.items.length>0){const d=l.items[0],h=d.item||d;h&&h.artist&&(r={...r,artist:h.artist})}if(r&&!r.releaseDate&&l?.items&&l.items.length>0){const d=l.items[0],h=d.item||d;h&&(h.album&&h.album.releaseDate?r={...r,releaseDate:h.album.releaseDate}:h.streamStartDate&&(r={...r,releaseDate:h.streamStartDate.split("T")[0]}))}const o=(l?.items||[]).map(d=>this.prepareTrack(d.item||d)),c={album:r,tracks:o};return await this.cache.set("album",e,c),c}async getPlaylist(e){const t=await this.cache.get("playlist",e);if(t)return t;const a=await(await this.fetchWithRetry(`/playlist/?id=${e}`)).json(),i=a.data||a;let r=null,l=null;if(i.playlist&&(r=i.playlist),i.items&&(l={items:i.items}),!r||!l){const d=Array.isArray(i)?i:[i];for(const h of d)!h||typeof h!="object"||(!r&&("uuid"in h||"numberOfTracks"in h||"title"in h&&"id"in h)&&(r=h),!l&&"items"in h&&(l=h))}if(!r&&Array.isArray(i)){for(const d of i)if(d&&typeof d=="object"&&("uuid"in d||"numberOfTracks"in d)){r=d;break}}if(!r)throw new Error("Playlist not found");let o=(l?.items||[]).map(d=>this.prepareTrack(d.item||d));if(r.numberOfTracks>o.length){let d=o.length;const h=1e4;for(;o.length<r.numberOfTracks&&o.length<h;)try{const m=await(await this.fetchWithRetry(`/playlist/?id=${e}&offset=${d}`)).json(),f=m.data||m;let g=[];if(f.items)g=f.items;else if(Array.isArray(f)){for(const v of f)if(v&&typeof v=="object"&&"items"in v&&Array.isArray(v.items)){g=v.items;break}}if(!g||g.length===0)break;const y=g.map(v=>this.prepareTrack(v.item||v));if(y.length===0||o.length>0&&y[0].id===o[0].id)break;o=o.concat(y),d+=y.length}catch(u){console.error(`Error fetching playlist tracks at offset ${d}:`,u);break}}const c={playlist:r,tracks:o};return await this.cache.set("playlist",e,c),c}async getMix(e){const t=await this.cache.get("mix",e);if(t)return t;const a=await(await this.fetchWithRetry(`/mix/?id=${e}`,{type:"api"})).json(),i=a.mix,r=a.items||[];if(!i)throw new Error("Mix metadata not found");const l=r.map(d=>this.prepareTrack(d.item||d)),c={mix:{id:i.id,title:i.title,subTitle:i.subTitle,description:i.description,mixType:i.mixType,cover:i.images?.LARGE?.url||i.images?.MEDIUM?.url||i.images?.SMALL?.url||null},tracks:l};return await this.cache.set("mix",e,c),c}async getArtist(e){const t=await this.cache.get("artist",e);if(t)return t;const[s,a]=await Promise.all([this.fetchWithRetry(`/artist/?id=${e}`),this.fetchWithRetry(`/artist/?f=${e}&skip_tracks=true`)]),i=await s.json();let r=i.data||i;const l=r.artist||(Array.isArray(r)?r[0]:r);if(!l)throw new Error("Primary artist details not found.");const o={...this.prepareArtist(l),picture:l.picture||r.cover||null,name:l.name||"Unknown Artist"},c=await a.json(),d=c.data||c,h=Array.isArray(d)?d:[d],u=new Map,m=new Map,f=k=>k?.id&&k.duration&&k.album,g=k=>k?.id&&"numberOfTracks"in k,y=(k,L=new Set)=>{if(!k||typeof k!="object"||L.has(k))return;if(L.add(k),Array.isArray(k)){k.forEach(x=>y(x,L));return}const S=k.item||k;g(S)&&u.set(S.id,this.prepareAlbum(S)),f(S)&&m.set(S.id,this.prepareTrack(S)),Object.values(k).forEach(x=>y(x,L))};h.forEach(k=>y(k));try{const k=await this.searchAlbums(o.name);if(k&&k.items){const L=Number(e);for(const S of k.items)(S.artist?.id===L||Array.isArray(S.artists)&&S.artists.some(A=>A.id===L))&&!u.has(S.id)&&u.set(S.id,S)}}catch(k){console.warn("Failed to fetch additional albums via search:",k)}const v=Array.from(u.values()),I=this.deduplicateAlbums(v).sort((k,L)=>new Date(L.releaseDate||0)-new Date(k.releaseDate||0)),p=I.filter(k=>k.type==="EP"||k.type==="SINGLE"),b=I.filter(k=>!p.includes(k)),w=Array.from(m.values()).sort((k,L)=>(L.popularity||0)-(k.popularity||0)).slice(0,15),T={...o,albums:b,eps:p,tracks:w};return await this.cache.set("artist",e,T),T}async getSimilarArtists(e){const t=await this.cache.get("similar_artists",e);if(t)return t;try{const a=await(await this.fetchWithRetry(`/artist/similar/?id=${e}`,{type:"api"})).json(),r=(a.artists||a.items||a.data||(Array.isArray(a)?a:[])).map(l=>this.prepareArtist(l));return await this.cache.set("similar_artists",e,r),r}catch(s){return console.warn("Failed to fetch similar artists:",s),[]}}async getSimilarAlbums(e){const t=await this.cache.get("similar_albums",e);if(t)return t;try{const a=await(await this.fetchWithRetry(`/album/similar/?id=${e}`,{type:"api"})).json(),r=(a.items||a.albums||a.data||(Array.isArray(a)?a:[])).map(l=>this.prepareAlbum(l));return await this.cache.set("similar_albums",e,r),r}catch(s){return console.warn("Failed to fetch similar albums:",s),[]}}normalizeTrackResponse(e){if(!e||typeof e!="object")return e;const t=e.data??e;return[{duration:t.duration??0,id:t.trackId??null},t]}async getTrack(e,t="LOSSLESS"){const s=`${e}_${t}`,a=await this.cache.get("track",s);if(a)return a;const r=await(await this.fetchWithRetry(`/track/?id=${e}&quality=${t}`,{type:"streaming"})).json(),l=this.parseTrackLookup(this.normalizeTrackResponse(r));return await this.cache.set("track",s,l),l}async getStreamUrl(e,t="LOSSLESS"){const s=`stream_${e}_${t}`;if(this.streamCache.has(s))return this.streamCache.get(s);const a=await this.getTrack(e,t);let i;if(a.originalTrackUrl)i=a.originalTrackUrl;else if(i=this.extractStreamUrlFromManifest(a.info.manifest),!i)throw new Error("Could not resolve stream URL");return this.streamCache.set(s,i),i}async downloadTrack(e,t="LOSSLESS",s,a={}){const{onProgress:i,track:r}=a;try{const l=await this.getTrack(e,t);let o;if(l.originalTrackUrl)o=l.originalTrackUrl;else if(o=this.extractStreamUrlFromManifest(l.info.manifest),!o)throw new Error("Could not resolve stream URL");const c=await fetch(o,{cache:"no-store",signal:a.signal});if(!c.ok)throw new Error(`Fetch failed: ${c.status}`);const d=c.headers.get("Content-Length"),h=d?parseInt(d,10):0;let u=0,m;if(c.body&&i){const f=c.body.getReader(),g=[];for(;;){const{done:y,value:v}=await f.read();if(y)break;v&&(g.push(v),u+=v.byteLength,i({stage:"downloading",receivedBytes:u,totalBytes:h||void 0}))}m=new Blob(g,{type:c.headers.get("Content-Type")||"audio/flac"})}else m=await c.blob(),i&&i({stage:"downloading",receivedBytes:m.size,totalBytes:m.size});r&&(i&&i({stage:"processing",message:"Adding metadata..."}),m=await It(m,r,this,t)),this.triggerDownload(m,s)}catch(l){throw l.name==="AbortError"||(console.error("Download failed:",l),l.message===Tt)?l:new Error("Download failed. The stream may require a proxy.")}}triggerDownload(e,t){const s=URL.createObjectURL(e),a=document.createElement("a");a.href=s,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}getCoverUrl(e,t="320"){return e?`https://resources.tidal.com/images/${e.replace(/-/g,"/")}/${t}x${t}.jpg`:`https://picsum.photos/seed/${Math.random()}/${t}`}getArtistPictureUrl(e,t="320"){return e?`https://resources.tidal.com/images/${e.replace(/-/g,"/")}/${t}x${t}.jpg`:`https://picsum.photos/seed/${Math.random()}/${t}`}async clearCache(){await this.cache.clear(),this.streamCache.clear()}getCacheStats(){return{...this.cache.getCacheStats(),streamUrls:this.streamCache.size}}}const As={STORAGE_KEY:"monochrome-api-instances-v2",INSTANCES_URL:"instances.json",SPEED_TEST_CACHE_KEY:"monochrome-instance-speeds",SPEED_TEST_CACHE_DURATION:1e3*60*60,defaultInstances:{api:[],streaming:[]},instancesLoaded:!1,async loadInstancesFromGitHub(){if(this.instancesLoaded)return this.defaultInstances;try{const n=await fetch(this.INSTANCES_URL);if(!n.ok)throw new Error("Failed to fetch instances");const e=await n.json();let t={api:[],streaming:[]};if(Array.isArray(e))t.api=[...e],t.streaming=[...e];else{if(e.api&&Array.isArray(e.api))if(e.api.length>0&&typeof e.api[0]=="string")t.api=[...e.api];else for(const[a,i]of Object.entries(e.api))i.cors===!1&&Array.isArray(i.urls)&&t.api.push(...i.urls);e.streaming&&Array.isArray(e.streaming)?t.streaming=[...e.streaming]:t.api.length>0&&(t.streaming=[...t.api])}return this.defaultInstances=t,this.instancesLoaded=!0,t}catch(n){return console.error("Failed to load instances from GitHub:",n),this.defaultInstances={api:["https://tidal-api.binimum.org","https://monochrome-api.samidy.com"],streaming:["https://triton.squid.wtf","https://wolf.qqdl.site","https://maus.qqdl.site","https://vogel.qqdl.site","https://katze.qqdl.site","https://hund.qqdl.site","https://tidal.kinoplus.online","https://tidal-api.binimum.org"]},this.instancesLoaded=!0,this.defaultInstances}},async speedTestInstance(n,e="api"){let t;e==="streaming"?t=n.endsWith("/")?`${n}track/?id=204567804&quality=HIGH`:`${n}/track/?id=204567804&quality=HIGH`:t=n.endsWith("/")?`${n}artist/?id=3532302`:`${n}/artist/?id=3532302`;const s=performance.now();try{const a=new AbortController,i=setTimeout(()=>a.abort(),5e3),r=await fetch(t,{signal:a.signal,cache:"no-store"});if(clearTimeout(i),!r.ok)return{url:n,type:e,speed:1/0,error:`HTTP ${r.status}`};const o=performance.now()-s;return{url:n,type:e,speed:o,error:null}}catch(a){return{url:n,type:e,speed:1/0,error:a.message}}},getCachedSpeedTests(){try{const n=localStorage.getItem(this.SPEED_TEST_CACHE_KEY);if(!n)return{speeds:{},timestamp:Date.now()};const e=JSON.parse(n);return Date.now()-e.timestamp>this.SPEED_TEST_CACHE_DURATION?{speeds:{},timestamp:Date.now()}:e}catch{return{speeds:{},timestamp:Date.now()}}},updateSpeedCache(n){const e=this.getCachedSpeedTests();n.forEach(t=>{const s=t.type==="streaming"?`${t.url}#streaming`:t.url;e.speeds[s]={speed:t.speed,error:t.error}}),e.timestamp=Date.now();try{localStorage.setItem(this.SPEED_TEST_CACHE_KEY,JSON.stringify(e))}catch{console.warn("[SpeedTest] Failed to cache results")}return e},async testSpecificUrls(n,e){if(!n||n.length===0)return[];console.log(`[SpeedTest] Testing ${n.length} instances for ${e}...`);const t=await Promise.all(n.map(a=>this.speedTestInstance(a,e))),s=t.filter(a=>a.speed!==1/0);return console.log(`[SpeedTest] ${e} Results:`,s.map(a=>`${a.url}: ${a.speed.toFixed(0)}ms`)),t},async getInstances(n="api"){let e;const t=localStorage.getItem(this.STORAGE_KEY);t&&(e=JSON.parse(t)),e||(e=await this.loadInstancesFromGitHub());const s=e[n]||e.api||[];if(s.length===0)return[];const a=this.getCachedSpeedTests(),i=c=>n==="streaming"?`${c}#streaming`:c,r=s.filter(c=>!a.speeds[i(c)]);if(r.length>0){const c=await this.testSpecificUrls(r,n);this.updateSpeedCache(c),Object.assign(a,this.getCachedSpeedTests())}const o=(c=>[...c].sort((d,h)=>{const u=a.speeds[i(d)]?.speed??1/0,m=a.speeds[i(h)]?.speed??1/0;return u-m}))(s);return e[n]=o,this.saveInstances(e),o},async refreshSpeedTests(){const n=await this.loadInstancesFromGitHub(),e=[];n.api&&n.api.length&&e.push(this.testSpecificUrls(n.api,"api")),n.streaming&&n.streaming.length&&e.push(this.testSpecificUrls(n.streaming,"streaming"));const s=(await Promise.all(e)).flat();return this.updateSpeedCache(s),this.getInstances("api")},saveInstances(n,e){if(e)try{const t=localStorage.getItem(this.STORAGE_KEY);let s=t?JSON.parse(t):{api:[],streaming:[]};s[e]=n,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}catch(t){console.error("Failed to save instances:",t)}else localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n))}},he={STORAGE_KEY:"monochrome-recent-activity",LIMIT:10,_get(){try{const n=localStorage.getItem(this.STORAGE_KEY),e=n?JSON.parse(n):{artists:[],albums:[],playlists:[],mixes:[]};return e.playlists||(e.playlists=[]),e.mixes||(e.mixes=[]),e}catch{return{artists:[],albums:[],playlists:[],mixes:[]}}},_save(n){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n))},getRecents(){return this._get()},_add(n,e){const t=this._get();t[n]=t[n].filter(s=>s.id!==e.id),t[n].unshift(e),t[n]=t[n].slice(0,this.LIMIT),this._save(t)},addArtist(n){this._add("artists",n)},addAlbum(n){this._add("albums",n)},addPlaylist(n){this._add("playlists",n)},addMix(n){this._add("mixes",n)}},re={STORAGE_KEY:"monochrome-theme",CUSTOM_THEME_KEY:"monochrome-custom-theme",defaultThemes:{light:{},dark:{},monochrome:{},ocean:{},purple:{},forest:{},mocha:{},machiatto:{},frappe:{},latte:{}},getTheme(){try{return localStorage.getItem(this.STORAGE_KEY)||"system"}catch{return"system"}},setTheme(n){if(localStorage.setItem(this.STORAGE_KEY,n),n==="system"){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",e?"dark":"light")}else document.documentElement.setAttribute("data-theme",n);if(n!=="custom"){const e=document.documentElement;["background","foreground","primary","secondary","muted","border","highlight"].forEach(t=>{e.style.removeProperty(`--${t}`)})}else{const e=this.getCustomTheme();e&&this.applyCustomTheme(e)}},getCustomTheme(){try{const n=localStorage.getItem(this.CUSTOM_THEME_KEY);return n?JSON.parse(n):null}catch{return null}},setCustomTheme(n){localStorage.setItem(this.CUSTOM_THEME_KEY,JSON.stringify(n)),this.applyCustomTheme(n),this.setTheme("custom")},applyCustomTheme(n){const e=document.documentElement;for(const[t,s]of Object.entries(n))e.style.setProperty(`--${t}`,s)}},oe={STORAGE_KEY:"lastfm-enabled",LOVE_ON_LIKE_KEY:"lastfm-love-on-like",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")},shouldLoveOnLike(){try{return localStorage.getItem(this.LOVE_ON_LIKE_KEY)==="true"}catch{return!1}},setLoveOnLike(n){localStorage.setItem(this.LOVE_ON_LIKE_KEY,n?"true":"false")}},Ye={STORAGE_KEY:"now-playing-mode",getMode(){try{return localStorage.getItem(this.STORAGE_KEY)||"cover"}catch{return"cover"}},setMode(n){localStorage.setItem(this.STORAGE_KEY,n)}},Ee={DOWNLOAD_WITH_TRACKS:"lyrics-download-with-tracks",shouldDownloadLyrics(){try{return localStorage.getItem(this.DOWNLOAD_WITH_TRACKS)==="true"}catch{return!1}},setDownloadLyrics(n){localStorage.setItem(this.DOWNLOAD_WITH_TRACKS,n?"true":"false")}},ye={STORAGE_KEY:"album-background-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)!=="false"}catch{return!0}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")}},Je={STORAGE_KEY:"track-list-actions-mode",getMode(){try{const n=localStorage.getItem(this.STORAGE_KEY)||"dropdown";return document.documentElement.setAttribute("data-track-actions-mode",n),n}catch{return"dropdown"}},setMode(n){localStorage.setItem(this.STORAGE_KEY,n),document.documentElement.setAttribute("data-track-actions-mode",n)}},ne={COMPACT_ARTIST_KEY:"card-compact-artist",COMPACT_ALBUM_KEY:"card-compact-album",isCompactArtist(){try{const n=localStorage.getItem(this.COMPACT_ARTIST_KEY);return n===null?!0:n==="true"}catch{return!0}},setCompactArtist(n){localStorage.setItem(this.COMPACT_ARTIST_KEY,n?"true":"false")},isCompactAlbum(){try{return localStorage.getItem(this.COMPACT_ALBUM_KEY)==="true"}catch{return!1}},setCompactAlbum(n){localStorage.setItem(this.COMPACT_ALBUM_KEY,n?"true":"false")}},be={STORAGE_KEY_MODE:"replay-gain-mode",STORAGE_KEY_PREAMP:"replay-gain-preamp",getMode(){return localStorage.getItem(this.STORAGE_KEY_MODE)||"track"},setMode(n){localStorage.setItem(this.STORAGE_KEY_MODE,n)},getPreamp(){const n=parseFloat(localStorage.getItem(this.STORAGE_KEY_PREAMP));return isNaN(n)?3:n},setPreamp(n){localStorage.setItem(this.STORAGE_KEY_PREAMP,n)}},ue={STORAGE_KEY:"download-quality",getQuality(){try{return localStorage.getItem(this.STORAGE_KEY)||"LOSSLESS"}catch{return"LOSSLESS"}},setQuality(n){localStorage.setItem(this.STORAGE_KEY,n)}},Xe={STORAGE_KEY:"waveform-seekbar-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")}},Ze={STORAGE_KEY:"smooth-scrolling-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(n){localStorage.setItem(this.STORAGE_KEY,n?"true":"false")}},mt={STORAGE_KEY:"monochrome-queue",getQueue(){try{const n=localStorage.getItem(this.STORAGE_KEY);return n?JSON.parse(n):null}catch{return null}},saveQueue(n){try{const e={queue:n.queue,shuffledQueue:n.shuffledQueue,originalQueueBeforeShuffle:n.originalQueueBeforeShuffle,currentQueueIndex:n.currentQueueIndex,shuffleActive:n.shuffleActive,repeatMode:n.repeatMode};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Failed to save queue to localStorage:",e)}}};typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",n=>{re.getTheme()==="system"&&document.documentElement.setAttribute("data-theme",n.matches?"dark":"light")});class Cs{constructor(){this.panel=document.getElementById("side-panel"),this.titleElement=document.getElementById("side-panel-title"),this.controlsElement=document.getElementById("side-panel-controls"),this.contentElement=document.getElementById("side-panel-content"),this.currentView=null}open(e,t,s,a){if(this.currentView===e&&this.panel.classList.contains("active")){this.close();return}this.currentView=e,this.titleElement.textContent=t,this.controlsElement.innerHTML="",this.contentElement.innerHTML="",s&&s(this.controlsElement),a&&a(this.contentElement),this.panel.classList.add("active")}close(){this.panel.classList.remove("active"),this.currentView=null,setTimeout(()=>{this.panel.classList.contains("active")||(this.controlsElement.innerHTML="",this.contentElement.innerHTML="")},300)}isActive(e){return this.currentView===e&&this.panel.classList.contains("active")}refresh(e,t,s){this.isActive(e)&&(t&&(this.controlsElement.innerHTML="",t(this.controlsElement)),s&&(this.contentElement.innerHTML="",s(this.contentElement)))}updateContent(e,t){this.isActive(e)&&(this.contentElement.innerHTML="",t(this.contentElement))}}const U=new Cs;class Ct{constructor(e){this.api=e,this.currentLyrics=null,this.syncedLyrics=[],this.lyricsCache=new Map,this.componentLoaded=!1,this.amLyricsElement=null,this.animationFrameId=null,this.currentTrackId=null,this.mutationObserver=null,this.romajiObserver=null,this.isRomajiMode=!1,this.originalLyricsData=null,this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,this.romajiTextCache=new Map,this.convertedTracksCache=new Set}async loadKuroshiro(){if(this.kuroshiroLoaded)return!0;if(this.kuroshiroLoading)return new Promise(e=>{const t=setInterval(()=>{this.kuroshiroLoading||(clearInterval(t),e(this.kuroshiroLoaded))},100)});this.kuroshiroLoading=!0;try{window._originalXHROpen||(window._originalXHROpen=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(s,a,...i){const r=a.toString();if(r.includes("/dict/")&&r.includes(".dat.gz")){const o=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r.split("/").pop()}`;return window._originalXHROpen.call(this,s,o,...i)}return window._originalXHROpen.call(this,s,a,...i)}),window._originalFetch||(window._originalFetch=window.fetch,window.fetch=async(s,a)=>{const i=s.toString();if(i.includes("/dict/")&&i.includes(".dat.gz")){const r=i.split("/").pop(),l=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r}`;return console.log(`Redirecting dict fetch: ${r} -> CDN`),window._originalFetch(l,a)}return window._originalFetch(s,a)}),window.Kuroshiro||await this.loadScript("https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"),window.KuromojiAnalyzer||await this.loadScript("https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js");const e=window.Kuroshiro.default||window.Kuroshiro,t=window.KuromojiAnalyzer.default||window.KuromojiAnalyzer;return this.kuroshiro=new e,await this.kuroshiro.init(new t({dictPath:"/dict/"})),this.kuroshiroLoaded=!0,this.kuroshiroLoading=!1,console.log("✓ Kuroshiro loaded and initialized successfully"),!0}catch(e){return console.error("✗ Failed to load Kuroshiro:",e),this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,!1}}loadScript(e){return new Promise((t,s)=>{if(document.querySelector(`script[src="${e}"]`)){t();return}const a=document.createElement("script");a.src=e,a.onload=t,a.onerror=()=>s(new Error(`Failed to load script: ${e}`)),document.head.appendChild(a)})}containsJapanese(e){return e?/[\u3040-\u30FF\u31F0-\u9FFF]/.test(e):!1}async convertToRomaji(e){if(!e)return e;if(this.romajiTextCache.has(e))return this.romajiTextCache.get(e);if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()||!this.kuroshiro)return console.warn("Kuroshiro not available, skipping conversion"),e;try{const t=await this.kuroshiro.convert(e,{to:"romaji",mode:"spaced",romajiSystem:"hepburn"});return this.romajiTextCache.set(e,t),t}catch(t){return console.warn("Romaji conversion failed for text:",e.substring(0,30),t),e}}setRomajiMode(e){this.isRomajiMode=e;try{localStorage.setItem("lyricsRomajiMode",e?"true":"false")}catch(t){console.warn("Failed to save Romaji mode preference:",t)}}getRomajiMode(){try{return localStorage.getItem("lyricsRomajiMode")==="true"}catch{return!1}}async ensureComponentLoaded(){if(!this.componentLoaded){if(typeof customElements<"u"&&customElements.get("am-lyrics")){this.componentLoaded=!0;return}return new Promise((e,t)=>{const s=document.createElement("script");s.type="module",s.src="https://cdn.jsdelivr.net/npm/@uimaxbai/am-lyrics@0.6.2/dist/src/am-lyrics.min.js",s.onload=()=>{typeof customElements<"u"?customElements.whenDefined("am-lyrics").then(()=>{this.componentLoaded=!0,e()}).catch(t):e()},s.onerror=()=>t(new Error("Failed to load lyrics component")),document.head.appendChild(s)})}}async fetchLyrics(e,t=null){if(t){if(this.lyricsCache.has(e))return this.lyricsCache.get(e);try{const s=Array.isArray(t.artists)?t.artists.map(c=>c.name||c).join(", "):t.artist?.name||"",a=t.title||"",i=t.album?.title||"",r=t.duration?Math.round(t.duration):null;if(!a||!s)return console.warn("Missing required fields for LRCLIB"),null;const l=new URLSearchParams({track_name:a,artist_name:s});i&&l.append("album_name",i),r&&l.append("duration",r.toString());const o=await fetch(`https://lrclib.net/api/get?${l.toString()}`);if(o.ok){const c=await o.json();if(c.syncedLyrics){const d={subtitles:c.syncedLyrics,lyricsProvider:"LRCLIB"};return this.lyricsCache.set(e,d),d}}}catch(s){console.warn("LRCLIB fetch failed:",s)}}return null}parseSyncedLyrics(e){return e?e.split(`
`).filter(s=>s.trim()).map(s=>{const a=s.match(/\[(\d+):(\d+)\.(\d+)\]\s*(.+)/);if(a){const[,i,r,l,o]=a;return{time:parseInt(i)*60+parseInt(r)+parseInt(l)/100,text:o.trim()}}return null}).filter(Boolean):[]}generateLRCContent(e,t){if(!e||!e.subtitles)return null;const s=te(t),a=ee(t);let i=`[ti:${s}]
`;return i+=`[ar:${a}]
`,i+=`[al:${t.album?.title||"Unknown Album"}]
`,i+=`[by:${e.lyricsProvider||"Unknown"}]
`,i+=`
`,i+=e.subtitles,i}downloadLRC(e,t){const s=this.generateLRCContent(e,t);if(!s){alert("No synced lyrics available for this track");return}const a=new Blob([s],{type:"application/octet-stream"}),i=URL.createObjectURL(a),r=document.createElement("a");r.href=i,r.download=je(t,"LOSSLESS").replace(/\.flac$/,".lrc"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}getCurrentLine(e){if(!this.syncedLyrics||this.syncedLyrics.length===0)return-1;let t=-1;for(let s=0;s<this.syncedLyrics.length&&e>=this.syncedLyrics[s].time;s++)t=s;return t}setupLyricsObserver(e){if(this.stopLyricsObserver(),!e)return;const t=e.shadowRoot||e;this.romajiObserver=new MutationObserver(s=>{s.some(i=>i.type==="childList"&&i.addedNodes.length>0?!0:i.type==="characterData"&&i.target.textContent?this.containsJapanese(i.target.textContent):!1)&&(this.observerTimeout&&clearTimeout(this.observerTimeout),this.observerTimeout=setTimeout(async()=>{await this.convertLyricsContent(e)},100))}),this.romajiObserver.observe(t,{childList:!0,subtree:!0,characterData:!0,attributes:!1}),this.isRomajiMode&&this.convertLyricsContent(e)}async convertLyricsContent(e){if(!e||!this.isRomajiMode)return;const t=e.shadowRoot||e;if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()){console.warn("Cannot convert lyrics - Kuroshiro load failed");return}const s=[],a=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);let i;for(;i=a.nextNode();)s.push(i);for(const r of s){if(!r.parentElement)continue;const l=r.parentElement.tagName?.toLowerCase(),o=String(r.parentElement.className||"");if(["script","style","code","input","textarea","time"].includes(l))continue;const d=r.textContent;if(!(o.includes("progress")&&!o.includes("progress-text")||o.includes("time")&&!o.includes("progress-text")||o.includes("timestamp"))&&!(!d||d.trim().length===0)&&this.containsJapanese(d)){const h=await this.convertToRomaji(d);h&&h!==d&&(r.textContent=h)}}this.currentTrackId&&this.convertedTracksCache.add(this.currentTrackId)}stopLyricsObserver(){this.romajiObserver&&(this.romajiObserver.disconnect(),this.romajiObserver=null),this.observerTimeout&&(clearTimeout(this.observerTimeout),this.observerTimeout=null)}async toggleRomajiMode(e){return this.isRomajiMode=!this.isRomajiMode,this.setRomajiMode(this.isRomajiMode),e&&(this.isRomajiMode?(this.setupLyricsObserver(e),await this.convertLyricsContent(e)):this.stopLyricsObserver()),this.isRomajiMode}}async function Ne(n,e,t){const s=t||new Ct;!s.kuroshiroLoaded&&!s.kuroshiroLoading&&(s.getRomajiMode()?await s.loadKuroshiro():s.loadKuroshiro().catch(r=>{console.warn("Failed to load Kuroshiro for Romaji conversion:",r)}));const a=r=>{const l=s.getRomajiMode();s.isRomajiMode=l,r.innerHTML=`
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${Ce}
            </button>
            <button id="romaji-toggle-btn" class="btn-icon" title="Toggle Romaji (Japanese to Latin)" data-enabled="${l}" style="color: ${l?"var(--primary)":""}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </button>
        `,r.querySelector("#close-side-panel-btn").addEventListener("click",()=>{U.close(),Se(e,U.panel)});const o=r.querySelector("#romaji-toggle-btn");if(o){const c=()=>{const d=s.isRomajiMode;o.setAttribute("data-enabled",d),o.style.color=d?"var(--primary)":""};c(),o.addEventListener("click",async()=>{const d=U.panel.querySelector("am-lyrics");d&&(await s.toggleRomajiMode(d),c())})}},i=async r=>{Se(e,U.panel),await Ms(r,n,e,s)};U.open("lyrics","Lyrics",a,i)}async function Ms(n,e,t,s){n.innerHTML='<div class="lyrics-loading">Loading lyrics...</div>';try{await s.ensureComponentLoaded(),s.isRomajiMode=s.getRomajiMode(),s.currentTrackId=e.id;const a=e.title,i=ee(e),r=e.album?.title,l=e.duration?Math.round(e.duration*1e3):void 0,o=e.isrc||"";n.innerHTML="";const c=document.createElement("am-lyrics");c.setAttribute("song-title",a),c.setAttribute("song-artist",i),r&&c.setAttribute("song-album",r),l&&c.setAttribute("song-duration",l),c.setAttribute("query",`${a} ${i}`.trim()),o&&c.setAttribute("isrc",o),c.setAttribute("highlight-color","#93c5fd"),c.setAttribute("hover-background-color","rgba(59, 130, 246, 0.14)"),c.setAttribute("autoscroll",""),c.setAttribute("interpolate",""),c.style.height="100%",c.style.width="100%",n.appendChild(c),s.setupLyricsObserver(c),s.isRomajiMode&&!s.kuroshiroLoaded&&await s.loadKuroshiro(),await new Promise(u=>{const m=()=>c.querySelector(".lyric-line, [class*='lyric']")||c.shadowRoot&&c.shadowRoot.querySelector("[class*='lyric']")||c.textContent&&c.textContent.length>50;if(m()){u();return}let f=0;const g=25,y=setInterval(()=>{f++,(m()||f>=g)&&(clearInterval(y),u())},200)}),s.isRomajiMode&&(await s.convertLyricsContent(c),setTimeout(()=>s.convertLyricsContent(c),500));const h=Bs(e,t,c);return n.lyricsCleanup=h,n.lyricsManager=s,c}catch(a){return console.error("Failed to load lyrics:",a),n.innerHTML='<div class="lyrics-error">Failed to load lyrics</div>',null}}function Bs(n,e,t){let s=0,a=performance.now(),i=null;const r=()=>{const h=e.currentTime*1e3;s=h,a=performance.now(),t.currentTime=h},l=()=>{if(!e.paused){const u=performance.now()-a,m=s+u;t.currentTime=m,i=requestAnimationFrame(l)}},o=()=>{s=e.currentTime*1e3,a=performance.now(),l()},c=()=>{i&&(cancelAnimationFrame(i),i=null)},d=h=>{h.detail&&h.detail.timestamp&&(e.currentTime=h.detail.timestamp/1e3,e.play())};return e.addEventListener("timeupdate",r),e.addEventListener("play",o),e.addEventListener("pause",c),e.addEventListener("seeked",r),t.addEventListener("line-click",d),e.paused||l(),()=>{i&&cancelAnimationFrame(i),e.removeEventListener("timeupdate",r),e.removeEventListener("play",o),e.removeEventListener("pause",c),e.removeEventListener("seeked",r),t.removeEventListener("line-click",d)}}function Se(n,e){e&&e.lyricsCleanup&&(e.lyricsCleanup(),e.lyricsCleanup=null),e&&e.lyricsManager&&e.lyricsManager.stopLyricsObserver()}class Mt{constructor(){this.dbName="MonochromeDB",this.version=5,this.db=null}async open(){return this.db?this.db:new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=a=>{console.error("Database error:",a.target.error),t(a.target.error)},s.onsuccess=a=>{this.db=a.target.result,e(this.db)},s.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains("favorites_tracks")||i.createObjectStore("favorites_tracks",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_albums")||i.createObjectStore("favorites_albums",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_artists")||i.createObjectStore("favorites_artists",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_playlists")||i.createObjectStore("favorites_playlists",{keyPath:"uuid"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_mixes")||i.createObjectStore("favorites_mixes",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("history_tracks")||i.createObjectStore("history_tracks",{keyPath:"timestamp"}).createIndex("timestamp","timestamp",{unique:!0}),i.objectStoreNames.contains("user_playlists")||i.createObjectStore("user_playlists",{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})}})}async performTransaction(e,t,s){const a=await this.open();return new Promise((i,r)=>{const l=a.transaction(e,t),o=l.objectStore(e),c=s(o);l.oncomplete=()=>{i(c?.result)},l.onerror=d=>{r(d.target.error)}})}async addToHistory(e){const t="history_tracks",a={...this._minifyItem("track",e),timestamp:Date.now()};return(await this.open()).transaction(t,"readwrite").objectStore(t).put(a),a}async getHistory(){const e="history_tracks",t=await this.open();return new Promise((s,a)=>{const o=t.transaction(e,"readonly").objectStore(e).index("timestamp").getAll();o.onsuccess=()=>{s(o.result.reverse())},o.onerror=()=>a(o.error)})}async toggleFavorite(e,t){const a=`favorites_${e==="mix"?"mixes":`${e}s`}`,i=e==="playlist"?t.uuid:t.id;if(await this.isFavorite(e,i))return await this.performTransaction(a,"readwrite",l=>l.delete(i)),!1;{const o={...this._minifyItem(e,t),addedAt:Date.now()};return await this.performTransaction(a,"readwrite",c=>c.put(o)),!0}}async isFavorite(e,t){const a=`favorites_${e==="mix"?"mixes":`${e}s`}`;try{return!!await this.performTransaction(a,"readonly",r=>r.get(t))}catch{return!1}}async getFavorites(e){const s=`favorites_${e==="mix"?"mixes":`${e}s`}`,a=await this.open();return new Promise((i,r)=>{const d=a.transaction(s,"readonly").objectStore(s).index("addedAt").getAll();d.onsuccess=()=>{i(d.result.reverse())},d.onerror=()=>r(d.error)})}_minifyItem(e,t){if(!t)return t;const s={id:t.id,addedAt:t.addedAt||null};return e==="track"?{...s,title:t.title,duration:t.duration,explicit:t.explicit,artists:t.artists?.map(a=>({id:a.id,name:a.name}))||[],album:t.album?{id:t.album.id,cover:t.album.cover,releaseDate:t.album.releaseDate||null,vibrantColor:t.album.vibrantColor||null}:null,streamStartDate:t.streamStartDate||null,version:t.version||null}:e==="album"?{...s,title:t.title,cover:t.cover,releaseDate:t.releaseDate||null,explicit:t.explicit,artist:t.artist?{name:t.artist.name,id:t.artist.id}:t.artists?.[0]?{name:t.artists[0].name,id:t.artists[0].id}:null,type:t.type||null,numberOfTracks:t.numberOfTracks}:e==="artist"?{...s,name:t.name,picture:t.picture||t.image||null}:e==="playlist"?{uuid:t.uuid||t.id,addedAt:t.addedAt||t.createdAt||null,title:t.title||t.name,image:t.image||t.squareImage||t.cover||null,numberOfTracks:t.numberOfTracks||(t.tracks?t.tracks.length:0),user:t.user?{name:t.user.name}:null}:e==="mix"?{id:t.id,addedAt:t.addedAt,title:t.title,subTitle:t.subTitle,description:t.description,mixType:t.mixType,cover:t.cover}:t}async exportData(){const e=await this.getFavorites("track"),t=await this.getFavorites("album"),s=await this.getFavorites("artist"),a=await this.getFavorites("playlist"),i=await this.getFavorites("mix"),r=await this.getHistory(),l=await this.getPlaylists();return{favorites_tracks:e.map(c=>this._minifyItem("track",c)),favorites_albums:t.map(c=>this._minifyItem("album",c)),favorites_artists:s.map(c=>this._minifyItem("artist",c)),favorites_playlists:a.map(c=>this._minifyItem("playlist",c)),favorites_mixes:i.map(c=>this._minifyItem("mix",c)),history_tracks:r.map(c=>this._minifyItem("track",c)),user_playlists:l}}async importData(e,t=!1){const s=await this.open(),a=async(i,r)=>{if(r===void 0)return;let l=Array.isArray(r)?r:Object.values(r||{});const c=s.transaction(i,"readwrite").objectStore(i);t&&c.clear();for(const d of l)try{c.put(d)}catch(h){console.warn(`Failed to import item in ${i}:`,d,h)}};await a("favorites_tracks",e.favorites_tracks),await a("favorites_albums",e.favorites_albums),await a("favorites_artists",e.favorites_artists),await a("favorites_playlists",e.favorites_playlists),await a("favorites_mixes",e.favorites_mixes),await a("history_tracks",e.history_tracks),e.user_playlists&&await a("user_playlists",e.user_playlists)}async createPlaylist(e,t=[],s=""){const i={id:crypto.randomUUID(),name:e,tracks:t.map(r=>this._minifyItem("track",r)),cover:s,createdAt:Date.now()};return await this.performTransaction("user_playlists","readwrite",r=>r.put(i)),i}async addTrackToPlaylist(e,t){const s=await this.performTransaction("user_playlists","readonly",i=>i.get(e));if(!s)throw new Error("Playlist not found");s.tracks=s.tracks||[];const a=this._minifyItem("track",t);if(!s.tracks.some(i=>i.id===t.id))return s.tracks.push(a),await this.performTransaction("user_playlists","readwrite",i=>i.put(s)),s}async removeTrackFromPlaylist(e,t){const s=await this.performTransaction("user_playlists","readonly",a=>a.get(e));if(!s)throw new Error("Playlist not found");return s.tracks=s.tracks||[],s.tracks=s.tracks.filter(a=>a.id!==t),await this.performTransaction("user_playlists","readwrite",a=>a.put(s)),s}async deletePlaylist(e){await this.performTransaction("user_playlists","readwrite",t=>t.delete(e))}async getPlaylist(e){return await this.performTransaction("user_playlists","readonly",t=>t.get(e))}async getPlaylists(){const e=await this.open();return new Promise((t,s)=>{const l=e.transaction("user_playlists","readonly").objectStore("user_playlists").index("createdAt").getAll();l.onsuccess=()=>{t(l.result.reverse())},l.onerror=()=>s(l.error)})}async updatePlaylistName(e,t){const s=await this.performTransaction("user_playlists","readonly",a=>a.get(e));if(!s)throw new Error("Playlist not found");return s.name=t,await this.performTransaction("user_playlists","readwrite",a=>a.put(s)),s}async updatePlaylistTracks(e,t){const s=await this.performTransaction("user_playlists","readonly",a=>a.get(e));if(!s)throw new Error("Playlist not found");return s.tracks=t,await this.performTransaction("user_playlists","readwrite",a=>a.put(s)),s}}const C=new Mt,pe=Object.freeze(Object.defineProperty({__proto__:null,MusicDatabase:Mt,db:C},Symbol.toStringTag,{value:"Module"}));function ht(n,e,t){n/=255,e/=255,t/=255;const s=Math.max(n,e,t),a=Math.min(n,e,t);let i,r,l=(s+a)/2;if(s===a)i=r=0;else{const o=s-a;switch(r=l>.5?o/(2-s-a):o/(s+a),s){case n:i=(e-t)/o+(e<t?6:0);break;case e:i=(t-n)/o+2;break;case t:i=(n-e)/o+4;break}i/=6}return[i,r,l]}function $s(n,e,t){let s,a,i;if(e===0)s=a=i=t;else{const l=(d,h,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?d+(h-d)*6*u:u<.5?h:u<.6666666666666666?d+(h-d)*(.6666666666666666-u)*6:d),o=t<.5?t*(1+e):t+e-t*e,c=2*t-o;s=l(c,o,n+1/3),a=l(c,o,n),i=l(c,o,n-1/3)}const r=l=>{const o=Math.round(l*255).toString(16);return o.length===1?"0"+o:o};return`#${r(s)}${r(a)}${r(i)}`}function Ps(n){const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return null;const s=64;let a=n.naturalWidth||n.width,i=n.naturalHeight||n.height;if(a>s||i>s){const d=Math.min(s/a,s/i);a=Math.floor(a*d),i=Math.floor(i*d)}e.width=a,e.height=i,t.drawImage(n,0,0,a,i);const l=t.getImageData(0,0,a,i).data,o=[];for(let d=0;d<l.length;d+=4){const h=l[d],u=l[d+1],m=l[d+2];if(l[d+3]<125)continue;const[g,y,v]=ht(h,u,m);y>=.3&&v>=.3&&v<=.8&&o.push({r:h,g:u,b:m,h:g,s:y,l:v})}if(o.length===0)for(let d=0;d<l.length;d+=4){const h=l[d],u=l[d+1],m=l[d+2];if(l[d+3]<125)continue;const[g,y,v]=ht(h,u,m);v>.1&&v<.95&&o.push({r:h,g:u,b:m,h:g,s:y,l:v})}if(o.length===0)return null;o.sort((d,h)=>h.s-d.s||.5-Math.abs(d.l-.5)-(.5-Math.abs(h.l-.5)));const c=o[0];return $s(c.h,c.s,c.l)}let We=null,X=null,le=null,Bt=null;const Le="monochrome-firebase-config",_s={apiKey:"AIzaSyDPU-unAjuLtQJt4IkGS5faG50UCF7lYyA",authDomain:"monochrome-database.firebaseapp.com",projectId:"monochrome-database",storageBucket:"monochrome-database.firebasestorage.app",messagingSenderId:"895657412760",appId:"1:895657412760:web:e81c5044c7f4e9b799e8ed"};function Rs(){try{const n=localStorage.getItem(Le);return n?JSON.parse(n):null}catch(n){return console.warn("Failed to parse Firebase config from storage",n),null}}const $t=Rs(),ft=$t||_s;if(ft)try{We=qt(ft),X=Qt(We),le=Jt(We),Bt=new zt,console.log("Firebase initialized from "+($t?"saved":"default")+" config")}catch(n){console.error("Error initializing Firebase:",n)}else console.log("No Firebase config found.");function Pt(n){n&&localStorage.setItem(Le,JSON.stringify(n))}function Ds(){localStorage.removeItem(Le)}function Hs(n){if(!n)return null;try{const e=JSON.stringify(n),t=btoa(e),s=new URL(window.location.href);return s.hash=`#setup_firebase=${t}`,s.toString()}catch(e){return console.error("Failed to generate share link:",e),null}}function Os(){const n=window.location.hash;if(!n.startsWith("#setup_firebase="))return!1;const e=n.split("#setup_firebase=")[1];if(!e)return!1;try{const t=atob(e),s=JSON.parse(t);if(!s.apiKey||!s.authDomain)return alert("The shared configuration link appears to be invalid."),!1;if(confirm("A Firebase configuration was detected in the link. Do you want to import it and enable Sync?"))return Pt(s),window.history.replaceState(null,null,window.location.pathname),alert("Configuration imported successfully! The app will now reload."),window.location.reload(),!0;window.history.replaceState(null,null,window.location.pathname+"#settings")}catch(t){console.error("Failed to parse shared config:",t),alert("Failed to read configuration from link. The link might be corrupted.")}return!1}function Fs(){Os();const n=document.getElementById("firebase-config-input"),e=document.getElementById("save-firebase-config-btn"),t=document.getElementById("clear-firebase-config-btn"),s=document.getElementById("share-firebase-config-btn"),a=document.getElementById("toggle-firebase-config-btn"),i=document.getElementById("custom-firebase-config-container");if(a&&i&&a.addEventListener("click",()=>{i.classList.contains("visible")?(i.classList.remove("visible"),a.textContent="Custom Configuration"):(i.classList.add("visible"),a.textContent="Hide Custom Configuration")}),n){const r=localStorage.getItem(Le);if(r)try{n.value=JSON.stringify(JSON.parse(r),null,2),i&&a&&(i.classList.add("visible"),a.textContent="Hide Custom Configuration")}catch{n.value=r}}s&&s.addEventListener("click",()=>{const r=localStorage.getItem(Le);if(!r){alert("No configuration saved to share.");return}try{const l=JSON.parse(r),o=Hs(l);o&&navigator.clipboard.writeText(o).then(()=>{alert("Magic Link copied to clipboard! Send it to your other device.")}).catch(c=>{console.error("Clipboard error:",c),prompt("Copy this link:",o)})}catch{alert("Invalid configuration found.")}}),e&&e.addEventListener("click",()=>{const r=n.value.trim();if(!r){alert("Please enter a valid configuration.");return}try{let l=r;l.includes("=")&&(l=l.substring(l.indexOf("=")+1)),l=l.trim(),l.endsWith(";")&&(l=l.slice(0,-1));const o=l.replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g,'$1"$2":').replace(/:\s*'([^']*)'/g,': "$1"').replace(/,\s*([}\]])/g,"$1"),c=JSON.parse(o);Pt(c),alert("Configuration saved. Reloading..."),window.location.reload()}catch(l){console.error("Invalid Config:",l),alert("Could not parse configuration. Please ensure it looks like a valid JSON or JS object.")}}),t&&t.addEventListener("click",()=>{confirm("Are you sure you want to remove the custom configuration? The app will revert to the shared default database.")&&(Ds(),window.location.reload())})}class _t{constructor(){this.user=null,this.userRef=null,this.unsubscribeFunctions=[],this.isSyncing=!1}initialize(e){!le||!e||(this.user=e,this.userRef=Be(le,`users/${e.uid}`),console.log("Initializing SyncManager for user:",e.uid),this.performInitialSync())}disconnect(){this.userRef&&(this.unsubscribeFunctions.forEach(e=>e()),this.unsubscribeFunctions=[]),this.user=null,this.userRef=null,console.log("SyncManager disconnected")}async performInitialSync(){if(!this.isSyncing){this.isSyncing=!0;try{console.log("Starting initial sync...");const t=(await lt(this.userRef)).val()||{},s=await C.exportData(),a=this.mergeData(s,t);await Xt(this.userRef,a);const i={favorites_tracks:a.library?.tracks?Object.values(a.library.tracks):[],favorites_albums:a.library?.albums?Object.values(a.library.albums):[],favorites_artists:a.library?.artists?Object.values(a.library.artists):[],favorites_playlists:a.library?.playlists?Object.values(a.library.playlists):[],history_tracks:a.history?.recentTracks?Object.values(a.history.recentTracks):[],user_playlists:a.user_playlists?Object.values(a.user_playlists):[]};await C.importData(i,!0),console.log("Initial sync complete."),this.setupListeners()}catch(e){console.error("Initial sync failed:",e)}finally{this.isSyncing=!1}}}mergeData(e,t){const s=(i,r,l="id")=>{const o=new Map;return Array.isArray(i)?i.forEach(c=>o.set(c[l],c)):i&&typeof i=="object"&&Object.values(i).forEach(c=>o.set(c[l],c)),r&&(Array.isArray(r)?r.forEach(c=>o.set(c[l],c)):Object.keys(r).forEach(c=>{const d=r[c];typeof d=="object"&&o.set(d[l]||c,d)})),Array.from(o.values())};return{library:{tracks:this.arrayToObject(s(e.favorites_tracks,t.library?.tracks),"id"),albums:this.arrayToObject(s(e.favorites_albums,t.library?.albums),"id"),artists:this.arrayToObject(s(e.favorites_artists,t.library?.artists),"id"),playlists:this.arrayToObject(s(e.favorites_playlists,t.library?.playlists,"uuid"),"uuid")},history:{recentTracks:this.arrayToObject(s(e.history_tracks,t.history?.recentTracks,"timestamp"),"timestamp")},user_playlists:this.arrayToObject(s(e.user_playlists,t.user_playlists),"id"),lastUpdated:Date.now()}}arrayToObject(e,t){const s={};return e.forEach(a=>{a&&a[t]&&(s[a[t]]=a)}),s}setupListeners(){const e=me(this.userRef,"library"),t=ze(e,l=>{if(this.isSyncing)return;const o=l.val();if(o){const c={favorites_tracks:o.tracks?Object.values(o.tracks):[],favorites_albums:o.albums?Object.values(o.albums):[],favorites_artists:o.artists?Object.values(o.artists):[],favorites_playlists:o.playlists?Object.values(o.playlists):[]};C.importData(c,!0).then(()=>{window.dispatchEvent(new Event("library-changed"))})}});this.unsubscribeFunctions.push(()=>Ke(e,"value",t));const s=me(this.userRef,"history/recentTracks"),a=ze(s,l=>{if(this.isSyncing)return;const o=l.val();if(o){const c={history_tracks:Object.values(o)};C.importData(c,!0).then(()=>{window.dispatchEvent(new Event("history-changed"))})}});this.unsubscribeFunctions.push(()=>Ke(s,"value",a));const i=me(this.userRef,"user_playlists"),r=ze(i,l=>{if(this.isSyncing)return;const o=l.val();if(o){const c={user_playlists:Object.values(o)};C.importData(c,!0).then(()=>{window.dispatchEvent(new Event("library-changed"))})}});this.unsubscribeFunctions.push(()=>Ke(i,"value",r))}async syncLibraryItem(e,t,s){if(!this.user||!this.userRef)return;const i={track:"tracks",album:"albums",artist:"artists",playlist:"playlists"}[e];if(!i)return;const r=e==="playlist"?t.uuid:t.id,l=`library/${i}/${r}`,o=me(this.userRef,l);if(s){const c=C._minifyItem(e,t),d={...c,addedAt:t.addedAt||c.addedAt||Date.now()};await $e(o,d)}else await Pe(o)}async syncHistoryItem(e){if(!this.user||!this.userRef||!e.timestamp)return;const t=me(this.userRef,`history/recentTracks/${e.timestamp}`);try{await $e(t,e)}catch(s){console.error("Failed to sync history item:",s)}}async syncUserPlaylist(e,t){if(!this.user||!this.userRef)return;const a=`user_playlists/${e.id}`,i=me(this.userRef,a);t==="create"||t==="update"?await $e(i,e):t==="delete"&&await Pe(i)}async clearCloudData(){if(!this.user||!this.userRef)throw new Error("Not authenticated");await Pe(this.userRef)}async publishPlaylist(e){if(!this.user)throw new Error("Not authenticated");const t=C._minifyItem("playlist",e),s=e.id||e.uuid;if(!s)throw new Error("Invalid playlist ID");const a={...t,uid:this.user.uid,originalId:s,publishedAt:Date.now(),tracks:e.tracks?e.tracks.map(r=>C._minifyItem("track",r)):[]},i=Be(le,`public_playlists/${s}`);await $e(i,a)}async unpublishPlaylist(e){if(!this.user)throw new Error("Not authenticated");const t=Be(le,`public_playlists/${e}`);await Pe(t)}async getPublicPlaylist(e){if(!le)return console.warn("[Sync] Database not initialized, cannot fetch public playlist"),null;try{const t=Be(le,`public_playlists/${e}`),s=await lt(t);if(!s.exists())return console.warn(`[Sync] Public playlist ${e} not found in database.`),null;const a=s.val();return console.log(`[Sync] Public playlist fetch for ${e}: Found`),a}catch(t){return console.error("[Sync] Failed to fetch public playlist:",t),null}}}const N=new _t,Ve=Object.freeze(Object.defineProperty({__proto__:null,SyncManager:_t,syncManager:N},Symbol.toStringTag,{value:"Module"}));class Ns{constructor(e,t){this.api=e,this.player=t,this.currentTrack=null,this.searchAbortController=null,this.vibrantColorCache=new Map}createHeartIcon(e=!1){return e?ie.replace('class="heart-icon"','class="heart-icon filled"'):ie}async extractAndApplyColor(e){if(!ye.isEnabled()||!e){this.resetVibrantColor();return}if(this.vibrantColorCache.has(e)){const a=this.vibrantColorCache.get(e);if(a){this.setVibrantColor(a);return}}const t=new Image;t.crossOrigin="Anonymous";const s=e.includes("?")?"&":"?";t.src=`${e}${s}not-from-cache-please`,t.onload=()=>{try{const a=Ps(t);a?(this.vibrantColorCache.set(e,a),this.setVibrantColor(a)):(this.vibrantColorCache.set(e,null),this.resetVibrantColor())}catch{this.vibrantColorCache.set(e,null),this.resetVibrantColor()}},t.onerror=()=>{this.vibrantColorCache.set(e,null),this.resetVibrantColor()}}async updateLikeState(e,t,s){const a=await C.isFavorite(t,s),i=e.querySelector(".like-btn");i&&(i.innerHTML=this.createHeartIcon(a),i.classList.toggle("active",a),i.title=a?"Remove from Liked":"Add to Liked")}setCurrentTrack(e){this.currentTrack=e,this.updateGlobalTheme();const t=document.getElementById("now-playing-like-btn"),s=document.getElementById("now-playing-add-playlist-btn"),a=document.getElementById("mobile-add-playlist-btn"),i=document.getElementById("toggle-lyrics-btn");e?(t&&(t.style.display="flex",this.updateLikeState(t.parentElement,"track",e.id)),s&&s.style.removeProperty("display"),a&&a.style.removeProperty("display"),i&&i.style.removeProperty("display")):(t&&(t.style.display="none"),s&&s.style.setProperty("display","none","important"),a&&a.style.setProperty("display","none","important"),i&&(i.style.display="none"))}updateGlobalTheme(){document.getElementById("page-album").classList.contains("active")||(ye.isEnabled()&&this.currentTrack?.album?.cover?this.extractAndApplyColor(this.api.getCoverUrl(this.currentTrack.album.cover,"80")):this.resetVibrantColor())}createExplicitBadge(){return'<span class="explicit-badge" title="Explicit">E</span>'}adjustTitleFontSize(e,t){e.classList.remove("long-title","very-long-title"),t.length>40?e.classList.add("very-long-title"):t.length>25&&e.classList.add("long-title")}createTrackItemHTML(e,t,s=!1,a=!1){const i=s?`<img src="${this.api.getCoverUrl(e.album?.cover)}" alt="Track Cover" class="track-item-cover" loading="lazy">`:"";let r;a&&!s?r=`${e.volumeNumber??e.discNumber??1}-${e.trackNumber}`:r=t+1;const l=`<div class="track-number">${s?i:r}</div>`,o=Ge(e)?this.createExplicitBadge():"",c=ee(e),d=te(e),h=this.player?.currentTrack?.id===e.id;let u="";const m=e.album?.releaseDate||e.streamStartDate;if(m){const g=new Date(m);isNaN(g.getTime())||(u=` • ${g.getFullYear()}`)}const f=`
            <div class="track-actions-inline">
                <button class="track-action-btn like-btn" data-action="toggle-like" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
                <button class="track-action-btn" data-action="play-next" title="Play Next">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 6h6" />
                        <path d="M5 3v6" />
                        <path d="M11 6h10" />
                        <path d="M3 12h18" />
                        <path d="M3 18h18" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="add-to-queue" title="Add to Queue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18" />
                        <path d="M3 12h18" />
                        <path d="M3 18h10" />
                        <path d="M16 18h6" />
                        <path d="M19 15v6" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="download" title="Download">
                    ${fe}
                </button>
            </div>
            <button class="track-menu-btn" type="button" title="More options">
                ${as}
            </button>
        `;return`
            <div class="track-item ${h?"playing":""}" data-track-id="${e.id}">
                ${l}
                <div class="track-item-info">
                    <div class="track-item-details">
                        <div class="title">
                            ${W(d)}
                            ${o}
                        </div>
                        <div class="artist">${W(c)}${u}</div>
                    </div>
                </div>
                <div class="track-item-duration">${Te(e.duration)}</div>
                <div class="track-item-actions">
                    ${f}
                </div>
            </div>
        `}createBaseCardHTML({type:e,id:t,href:s,title:a,subtitle:i,imageHTML:r,actionButtonsHTML:l,isCompact:o,extraClasses:c=""}){const d=e!=="artist"?`
            <button class="play-btn card-play-btn" data-action="play-card" data-type="${e}" data-id="${t}" title="Play">
                ${de}
            </button>
        `:"",h=e==="artist"?`<h4 class="card-title">${a}</h4>`:`<div class="card-info">
                    <h4 class="card-title">${a}</h4>
                    <p class="card-subtitle">${i}</p>
               </div>`;return`
            <div class="card ${c} ${o?"compact":""}" data-${e}-id="${t}" data-href="${s}" style="cursor: pointer;">
                <div class="card-image-wrapper">
                    ${r}
                    ${l}
                    ${o?"":d}
                </div>
                ${h}
                ${o?d:""}
            </div>
        `}createPlaylistCardHTML(e){const t=e.squareImage||e.image||e.uuid,s=ne.isCompactAlbum();return this.createBaseCardHTML({type:"playlist",id:e.uuid,href:`#playlist/${e.uuid}`,title:e.title,subtitle:`${e.numberOfTracks||0} tracks`,imageHTML:`<img src="${this.api.getCoverUrl(t)}" alt="${e.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="playlist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:s})}createMixCardHTML(e){const t=e.cover||"assets/appicon.png",s=e.subTitle||e.description||"",a=ne.isCompactAlbum();return this.createBaseCardHTML({type:"mix",id:e.id,href:`#mix/${e.id}`,title:e.title,subtitle:s,imageHTML:`<img src="${t}" alt="${e.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="mix" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:a})}createUserPlaylistCardHTML(e){let t="";if(e.cover)t=`<img src="${e.cover}" alt="${e.name}" class="card-image" loading="lazy">`;else{const a=e.tracks||[];let i=e.images||[];const r=new Set(i);if(i.length===0)for(const l of a){const o=l.album?.cover;if(o&&!r.has(o)&&(r.add(o),i.push(o),i.length>=4))break}if(i.length>=2){const l=Math.min(i.length,4),o=l<4?`items-${l}`:"",c=i.slice(0,4);t=`
                    <div class="card-image card-collage ${o}">
                        ${c.map(d=>`<img src="${this.api.getCoverUrl(d)}" alt="" loading="lazy">`).join("")}
                    </div>
                `}else i.length>0?t=`<img src="${this.api.getCoverUrl(i[0])}" alt="${e.name}" class="card-image" loading="lazy">`:t=`<img src="assets/appicon.png" alt="${e.name}" class="card-image" loading="lazy">`}const s=ne.isCompactAlbum();return this.createBaseCardHTML({type:"user-playlist",id:e.id,href:`#userplaylist/${e.id}`,title:W(e.name),subtitle:`${e.tracks?e.tracks.length:e.numberOfTracks||0} tracks`,imageHTML:t,actionButtonsHTML:`
                <button class="edit-playlist-btn" data-action="edit-playlist" title="Edit Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                <button class="delete-playlist-btn" data-action="delete-playlist" title="Delete Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            `,isCompact:s,extraClasses:"user-playlist"})}createAlbumCardHTML(e){const t=Ge(e)?this.createExplicitBadge():"";let s="";if(e.releaseDate){const r=new Date(e.releaseDate);isNaN(r.getTime())||(s=`${r.getFullYear()}`)}let a="";e.type==="EP"?a=" • EP":e.type==="SINGLE"&&(a=" • Single");const i=ne.isCompactAlbum();return this.createBaseCardHTML({type:"album",id:e.id,href:`#album/${e.id}`,title:`${W(e.title)} ${t}`,subtitle:`${W(e.artist?.name??"")} • ${s}${a}`,imageHTML:`<img src="${this.api.getCoverUrl(e.cover)}" alt="${W(e.title)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="album" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:i})}createArtistCardHTML(e){const t=ne.isCompactArtist();return this.createBaseCardHTML({type:"artist",id:e.id,href:`#artist/${e.id}`,title:W(e.name),subtitle:"",imageHTML:`<img src="${this.api.getArtistPictureUrl(e.picture)}" alt="${W(e.name)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="artist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:t,extraClasses:"artist"})}createSkeletonTrack(e=!1){return`
            <div class="skeleton-track">
                ${e?'<div class="skeleton skeleton-track-cover"></div>':'<div class="skeleton skeleton-track-number"></div>'}
                <div class="skeleton-track-info">
                    <div class="skeleton-track-details">
                        <div class="skeleton skeleton-track-title"></div>
                        <div class="skeleton skeleton-track-artist"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-track-duration"></div>
            </div>
        `}createSkeletonCard(e=!1){return`
            <div class="skeleton-card ${e?"artist":""}">
                <div class="skeleton skeleton-card-image"></div>
                <div class="skeleton skeleton-card-title"></div>
                ${e?"":'<div class="skeleton skeleton-card-subtitle"></div>'}
            </div>
        `}createSkeletonTracks(e=5,t=!1){return`<div class="skeleton-container">${Array(e).fill(0).map(()=>this.createSkeletonTrack(t)).join("")}</div>`}createSkeletonCards(e=6,t=!1){return`<div class="card-grid">${Array(e).fill(0).map(()=>this.createSkeletonCard(t)).join("")}</div>`}renderListWithTracks(e,t,s){const a=document.createDocumentFragment(),i=document.createElement("div"),r=t.some(l=>(l.volumeNumber||l.discNumber||1)>1);for(i.innerHTML=t.map((l,o)=>this.createTrackItemHTML(l,o,s,r)).join("");i.firstChild;)a.appendChild(i.firstChild);e.innerHTML="",e.appendChild(a),t.forEach(l=>{const o=e.querySelector(`[data-track-id="${l.id}"]`);o&&(O.set(o,l),this.updateLikeState(o,"track",l.id))})}setPageBackground(e){const t=document.getElementById("page-background");ye.isEnabled()&&e?(t.style.backgroundImage=`url('${e}')`,t.classList.add("active"),document.body.classList.add("has-page-background")):(t.classList.remove("active"),document.body.classList.remove("has-page-background"),setTimeout(()=>{t.classList.contains("active")||(t.style.backgroundImage="")},500))}setVibrantColor(e){if(!e)return;const t=document.documentElement,a=t.getAttribute("data-theme")==="light";let i=e.replace("#","");i.length===3&&(i=i.split("").map(m=>m+m).join(""));let r=parseInt(i.substr(0,2),16),l=parseInt(i.substr(2,2),16),o=parseInt(i.substr(4,2),16),c=(r*299+l*587+o*114)/1e3;if(a)for(;c>150;)r=Math.floor(r*.9),l=Math.floor(l*.9),o=Math.floor(o*.9),c=(r*299+l*587+o*114)/1e3;else for(;c<80&&(r=Math.min(255,Math.max(r+1,Math.floor(r*1.15))),l=Math.min(255,Math.max(l+1,Math.floor(l*1.15))),o=Math.min(255,Math.max(o+1,Math.floor(o*1.15))),c=(r*299+l*587+o*114)/1e3,!(r>=255&&l>=255&&o>=255)););const d=`#${r.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`,h=c>128?"#000000":"#ffffff";t.style.setProperty("--primary",d),t.style.setProperty("--primary-foreground",h),t.style.setProperty("--highlight",d),t.style.setProperty("--highlight-rgb",`${r}, ${l}, ${o}`),t.style.setProperty("--active-highlight",d),t.style.setProperty("--ring",d);let u;if(c>200){const m=Math.floor(r*.85),f=Math.floor(l*.85),g=Math.floor(o*.85);u=`rgba(${m}, ${f}, ${g}, 0.25)`}else u=`rgba(${r}, ${l}, ${o}, 0.15)`;t.style.setProperty("--track-hover-bg",u)}resetVibrantColor(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-foreground"),e.style.removeProperty("--highlight"),e.style.removeProperty("--highlight-rgb"),e.style.removeProperty("--active-highlight"),e.style.removeProperty("--ring"),e.style.removeProperty("--track-hover-bg")}async showFullscreenCover(e,t,s,a){if(!e)return;const i=document.getElementById("fullscreen-cover-overlay"),r=document.getElementById("fullscreen-cover-image"),l=document.getElementById("fullscreen-track-title"),o=document.getElementById("fullscreen-track-artist"),c=document.getElementById("fullscreen-next-track");document.getElementById("fullscreen-lyrics-container");const d=document.getElementById("toggle-fullscreen-lyrics-btn"),h=this.api.getCoverUrl(e.album?.cover,"1280");if(r.src=h,l.textContent=e.title,o.textContent=ee(e),t?(c.style.display="flex",c.querySelector(".value").textContent=`${t.title} • ${ee(t)}`,c.classList.remove("animate-in"),c.offsetWidth,c.classList.add("animate-in")):(c.style.display="none",c.classList.remove("animate-in")),i.style.setProperty("--bg-image",`url('${h}')`),s&&a){d.style.display="flex",d.classList.remove("active");const m=()=>{Ne(e,a,s),d.classList.toggle("active")},f=d.cloneNode(!0);d.parentNode.replaceChild(f,d),f.addEventListener("click",m)}else d.style.display="none";i.style.display="flex";const u=document.querySelector(".now-playing-bar");u&&(u.style.display="none")}closeFullscreenCover(){const e=document.getElementById("fullscreen-cover-overlay");e.style.display="none";const t=document.querySelector(".now-playing-bar");t&&(t.style.display="")}showPage(e){document.querySelectorAll(".page").forEach(t=>{t.classList.toggle("active",t.id===`page-${e}`)}),document.querySelectorAll(".sidebar-nav a").forEach(t=>{t.classList.toggle("active",t.hash===`#${e}`)}),document.querySelector(".main-content").scrollTop=0,["album","artist","playlist","mix"].includes(e)||(this.setPageBackground(null),this.updateGlobalTheme()),e==="settings"&&this.renderApiSettings()}async renderLibraryPage(){this.showPage("library");const e=document.getElementById("library-tracks-container"),t=document.getElementById("library-albums-container"),s=document.getElementById("library-artists-container"),a=document.getElementById("library-playlists-container"),i=await C.getFavorites("track");i.length?this.renderListWithTracks(e,i,!0):e.innerHTML=F("No liked tracks yet.");const r=await C.getFavorites("album");r.length?(t.innerHTML=r.map(m=>this.createAlbumCardHTML(m)).join(""),r.forEach(m=>{const f=t.querySelector(`[data-album-id="${m.id}"]`);f&&(O.set(f,m),this.updateLikeState(f,"album",m.id))})):t.innerHTML=F("No liked albums yet.");const l=await C.getFavorites("artist");l.length?(s.innerHTML=l.map(m=>this.createArtistCardHTML(m)).join(""),l.forEach(m=>{const f=s.querySelector(`[data-artist-id="${m.id}"]`);f&&(O.set(f,m),this.updateLikeState(f,"artist",m.id))})):s.innerHTML=F("No liked artists yet.");const o=await C.getFavorites("playlist"),c=await C.getFavorites("mix");let d=[];o.length&&d.push(...o.map(m=>({...m,_type:"playlist"}))),c.length&&d.push(...c.map(m=>({...m,_type:"mix"}))),d.sort((m,f)=>f.addedAt-m.addedAt),d.length?(a.innerHTML=d.map(m=>m._type==="playlist"?this.createPlaylistCardHTML(m):this.createMixCardHTML(m)).join(""),o.forEach(m=>{const f=a.querySelector(`[data-playlist-id="${m.uuid}"]`);f&&(O.set(f,m),this.updateLikeState(f,"playlist",m.uuid))}),c.forEach(m=>{const f=a.querySelector(`[data-mix-id="${m.id}"]`);f&&(O.set(f,m),this.updateLikeState(f,"mix",m.id))})):a.innerHTML=F("No liked playlists or mixes yet.");const h=document.getElementById("my-playlists-container"),u=await C.getPlaylists();u.length?(h.innerHTML=u.map(m=>this.createUserPlaylistCardHTML(m)).join(""),u.forEach(m=>{const f=h.querySelector(`[data-user-playlist-id="${m.id}"]`);f&&O.set(f,m)})):h.innerHTML=F("No playlists yet. Create your first playlist!")}async renderHomePage(){this.showPage("home");const e=he.getRecents(),t=document.getElementById("home-recent-albums"),s=document.getElementById("home-recent-artists"),a=document.getElementById("home-recent-playlists");if(e.albums.length?(t.innerHTML=e.albums.map(i=>this.createAlbumCardHTML(i)).join(""),e.albums.forEach(i=>{const r=t.querySelector(`[data-album-id="${i.id}"]`);r&&(O.set(r,i),this.updateLikeState(r,"album",i.id))})):t.innerHTML=F("You haven't viewed any albums yet."),e.artists.length?(s.innerHTML=e.artists.map(i=>this.createArtistCardHTML(i)).join(""),e.artists.forEach(i=>{const r=s.querySelector(`[data-artist-id="${i.id}"]`);r&&(O.set(r,i),this.updateLikeState(r,"artist",i.id))})):s.innerHTML=F("You haven't viewed any artists yet."),a){const i=e.playlists||[],r=e.mixes||[],l=[...i,...r];l.length?(a.innerHTML=l.map(o=>o.isUserPlaylist?this.createUserPlaylistCardHTML(o):o.mixType?this.createMixCardHTML(o):this.createPlaylistCardHTML(o)).join(""),l.forEach(o=>{if(o.isUserPlaylist){const c=a.querySelector(`[data-user-playlist-id="${o.id}"]`);c&&O.set(c,o)}else if(o.mixType){const c=a.querySelector(`[data-mix-id="${o.id}"]`);c&&(O.set(c,o),this.updateLikeState(c,"mix",o.id))}else{const c=a.querySelector(`[data-playlist-id="${o.uuid}"]`);c&&(O.set(c,o),this.updateLikeState(c,"playlist",o.uuid))}})):a.innerHTML=F("You haven't viewed any playlists or mixes yet.")}}async renderSearchPage(e){this.showPage("search"),document.getElementById("search-results-title").textContent=`Search Results for "${e}"`;const t=document.getElementById("search-tracks-container"),s=document.getElementById("search-artists-container"),a=document.getElementById("search-albums-container"),i=document.getElementById("search-playlists-container");t.innerHTML=this.createSkeletonTracks(8,!0),s.innerHTML=this.createSkeletonCards(6,!0),a.innerHTML=this.createSkeletonCards(6,!1),i.innerHTML=this.createSkeletonCards(6,!1),this.searchAbortController&&this.searchAbortController.abort(),this.searchAbortController=new AbortController;const r=this.searchAbortController.signal;try{const[l,o,c,d]=await Promise.all([this.api.searchTracks(e,{signal:r}),this.api.searchArtists(e,{signal:r}),this.api.searchAlbums(e,{signal:r}),this.api.searchPlaylists(e,{signal:r})]);let h=l.items,u=o.items,m=c.items,f=d.items;if(u.length===0&&h.length>0){const g=new Map;h.forEach(y=>{y.artist&&!g.has(y.artist.id)&&g.set(y.artist.id,y.artist),y.artists&&y.artists.forEach(v=>{g.has(v.id)||g.set(v.id,v)})}),u=Array.from(g.values())}if(m.length===0&&h.length>0){const g=new Map;h.forEach(y=>{y.album&&!g.has(y.album.id)&&g.set(y.album.id,y.album)}),m=Array.from(g.values())}h.length?this.renderListWithTracks(t,h,!0):t.innerHTML=F("No tracks found."),s.innerHTML=u.length?u.map(g=>this.createArtistCardHTML(g)).join(""):F("No artists found."),u.forEach(g=>{const y=s.querySelector(`[data-artist-id="${g.id}"]`);y&&(O.set(y,g),this.updateLikeState(y,"artist",g.id))}),a.innerHTML=m.length?m.map(g=>this.createAlbumCardHTML(g)).join(""):F("No albums found."),m.forEach(g=>{const y=a.querySelector(`[data-album-id="${g.id}"]`);y&&(O.set(y,g),this.updateLikeState(y,"album",g.id))}),i.innerHTML=f.length?f.map(g=>this.createPlaylistCardHTML(g)).join(""):F("No playlists found."),f.forEach(g=>{const y=i.querySelector(`[data-playlist-id="${g.uuid}"]`);y&&(O.set(y,g),this.updateLikeState(y,"playlist",g.uuid))})}catch(l){if(l.name==="AbortError")return;console.error("Search failed:",l);const o=F(`Error during search. ${l.message}`);t.innerHTML=o,s.innerHTML=o,a.innerHTML=o,i.innerHTML=o}}async renderAlbumPage(e){this.showPage("album");const t=document.getElementById("album-detail-image"),s=document.getElementById("album-detail-title"),a=document.getElementById("album-detail-meta"),i=document.getElementById("album-detail-producer"),r=document.getElementById("album-detail-tracklist"),l=document.getElementById("play-album-btn");l&&(l.innerHTML=`${de}<span>Play Album</span>`);const o=document.getElementById("download-album-btn");o&&(o.innerHTML=`${fe}<span>Download Album</span>`);const c=document.getElementById("album-mix-btn");c&&(c.style.display="none"),t.src="",t.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!1)}
        `;try{const{album:d,tracks:h}=await this.api.getAlbum(e),u=this.api.getCoverUrl(d.cover);t.src=u,t.style.backgroundColor="",this.setPageBackground(u),ye.isEnabled()&&d.cover&&this.extractAndApplyColor(this.api.getCoverUrl(d.cover,"80"));const m=Ge(d)?this.createExplicitBadge():"";s.innerHTML=`${W(d.title)} ${m}`,this.adjustTitleFontSize(s,d.title);const f=Re(h);let g="";if(d.releaseDate){const A=new Date(d.releaseDate);if(!isNaN(A.getTime())){const $=A.getFullYear();g=window.innerWidth>768?A.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):$}}const y=h.find(A=>A.copyright)?.copyright;a.innerHTML=(g?`${g} • `:"")+`${h.length} tracks • ${De(f)}`,i.innerHTML=`By <a href="#artist/${d.artist.id}">${d.artist.name}</a>`+(y?` • ${y}`:""),r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,h.sort((A,$)=>{const _=A.volumeNumber??A.discNumber??1,B=$.volumeNumber??$.discNumber??1;return _!==B?_-B:A.trackNumber-$.trackNumber}),this.renderListWithTracks(r,h,!1),he.addAlbum(d);const v=document.getElementById("like-album-btn");if(v){const A=await C.isFavorite("album",d.id);v.innerHTML=this.createHeartIcon(A),v.classList.toggle("active",A)}document.title=`${d.title} - ${d.artist.name}`;const I=document.getElementById("album-section-more-albums"),p=document.getElementById("album-detail-more-albums"),b=document.getElementById("album-title-more-albums"),w=document.getElementById("album-section-eps"),T=document.getElementById("album-detail-eps"),k=document.getElementById("album-title-eps"),L=document.getElementById("album-section-similar-artists"),S=document.getElementById("album-detail-similar-artists"),x=document.getElementById("album-section-similar-albums"),P=document.getElementById("album-detail-similar-albums");[I,w,L,x].forEach(A=>{A&&(A.style.display="none")});try{const A=await this.api.getArtist(d.artist.id),$=document.getElementById("album-mix-btn");$&&A.mixes&&A.mixes.ARTIST_MIX&&($.style.display="flex",$.onclick=()=>window.location.hash=`#mix/${A.mixes.ARTIST_MIX}`);const _=(B,D,j,J,G)=>{if(!D||!j)return;const se=(B||[]).filter(q=>q.id!=d.id).filter((q,E,M)=>E===M.findIndex(R=>R.title===q.title)).slice(0,12);se.length!==0&&(D.innerHTML=se.map(q=>this.createAlbumCardHTML(q)).join(""),J&&G&&(J.textContent=G),j.style.display="block",se.forEach(q=>{const E=D.querySelector(`[data-album-id="${q.id}"]`);E&&(O.set(E,q),this.updateLikeState(E,"album",q.id))}))};_(A.albums,p,I,b,`More albums from ${d.artist.name}`),_(A.eps,T,w,k,`EPs and Singles from ${d.artist.name}`),this.api.getSimilarArtists(d.artist.id).then(B=>{B&&B.length>0&&S&&L&&(S.innerHTML=B.map(D=>this.createArtistCardHTML(D)).join(""),L.style.display="block")}).catch(B=>console.warn("Failed to load similar artists:",B)),this.api.getSimilarAlbums(e).then(B=>{B&&B.length>0&&P&&x&&(P.innerHTML=B.map(D=>this.createAlbumCardHTML(D)).join(""),x.style.display="block",B.forEach(D=>{const j=P.querySelector(`[data-album-id="${D.id}"]`);j&&(O.set(j,D),this.updateLikeState(j,"album",D.id))}))}).catch(B=>console.warn("Failed to load similar albums:",B))}catch(A){console.warn('Failed to load "More from artist":',A)}}catch(d){console.error("Failed to load album:",d),r.innerHTML=F(`Could not load album details. ${d.message}`)}}async renderPlaylistPage(e,t=null){this.showPage("playlist");const s=document.getElementById("playlist-detail-image"),a=document.getElementById("playlist-detail-title"),i=document.getElementById("playlist-detail-meta"),r=document.getElementById("playlist-detail-description"),l=document.getElementById("playlist-detail-tracklist"),o=document.getElementById("play-playlist-btn");o&&(o.innerHTML=`${de}<span>Play</span>`);const c=document.getElementById("download-playlist-btn");c&&(c.innerHTML=`${fe}<span>Download</span>`),s.src="",s.style.backgroundColor="var(--muted)",a.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',l.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const d=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e);let h=null,u=null;if((t==="user"||!t&&d)&&(u=await C.getPlaylist(e),h=u,!h))try{h=await N.getPublicPlaylist(e)}catch(m){console.warn("Failed to check public Firebase playlists:",m)}if(h){s.src=h.cover||"assets/appicon.png",s.style.backgroundColor="",a.textContent=h.name||h.title,this.adjustTitleFontSize(a,a.textContent);const m=h.tracks||[],f=Re(m);i.textContent=`${m.length} tracks • ${De(f)}`,r.textContent=h.description||"",l.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(l,m,!0),u&&(l.querySelectorAll(".track-item").forEach((b,w)=>{const T=b.querySelector(".track-item-actions"),k=document.createElement("button");k.className="track-action-btn remove-from-playlist-btn",k.title="Remove from playlist",k.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',k.dataset.trackIndex=w;const L=T.querySelector(".track-menu-btn");T.insertBefore(k,L)}),this.enableTrackReordering(l,m,e,N));const g=document.getElementById("like-playlist-btn");g&&(g.style.display="none"),this.updatePlaylistHeaderActions(h,!!u,m);const y=[],v=new Set,I=h.tracks||[];for(const p of I){const b=p.album?.cover;if(b&&!v.has(b)&&(v.add(b),y.push(b),y.length>=4))break}he.addPlaylist({id:h.id||h.uuid,name:h.name||h.title,title:h.title||h.name,uuid:h.uuid||h.id,cover:h.cover,images:y,numberOfTracks:h.tracks?h.tracks.length:0,isUserPlaylist:!0}),document.title=`${h.name||h.title} - Monochrome`}else{if(t==="user")throw new Error("Playlist not found. If this is a custom playlist, make sure it is set to Public.");let m=await this.api.getPlaylist(e);const{playlist:f,tracks:g}=m,y=f.squareImage||f.image;y?(s.src=this.api.getCoverUrl(y,"1080"),this.setPageBackground(s.src),this.extractAndApplyColor(this.api.getCoverUrl(y,"160"))):(s.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),a.textContent=f.title,this.adjustTitleFontSize(a,f.title);const v=Re(g);i.textContent=`${f.numberOfTracks} tracks • ${De(v)}`,r.textContent=f.description||"",l.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(l,g,!0);const I=document.getElementById("like-playlist-btn");if(I){const b=await C.isFavorite("playlist",f.uuid);I.innerHTML=this.createHeartIcon(b),I.classList.toggle("active",b),I.style.display="flex"}const p=document.getElementById("delete-playlist-btn");p&&(p.style.display="none"),this.updatePlaylistHeaderActions(f,!1,g,!1),he.addPlaylist(f),document.title=f.title||"Artist Mix"}}catch(d){console.error("Failed to load playlist:",d),l.innerHTML=F(`Could not load playlist details. ${d.message}`)}}async renderMixPage(e){this.showPage("mix");const t=document.getElementById("mix-detail-image"),s=document.getElementById("mix-detail-title"),a=document.getElementById("mix-detail-meta"),i=document.getElementById("mix-detail-description"),r=document.getElementById("mix-detail-tracklist"),l=document.getElementById("play-mix-btn");l&&(l.innerHTML=`${de}<span>Play</span>`);const o=document.getElementById("download-mix-btn");o&&(o.innerHTML=`${fe}<span>Download</span>`),t.src="",t.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const{mix:c,tracks:d}=await this.api.getMix(e);c.cover?(t.src=c.cover,this.setPageBackground(c.cover),this.extractAndApplyColor(c.cover)):d.length>0&&d[0].album?.cover?(t.src=this.api.getCoverUrl(d[0].album.cover),this.setPageBackground(t.src),this.extractAndApplyColor(this.api.getCoverUrl(d[0].album.cover,"160"))):(t.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),t.style.backgroundColor="";const h=c.title||"Mix";s.textContent=h,this.adjustTitleFontSize(s,h);const u=Re(d);a.textContent=`${d.length} tracks • ${De(u)}`,i.innerHTML=`${c.subTitle}`,r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,this.renderListWithTracks(r,d,!0),l.onclick=()=>{this.player.setQueue(d,0),this.player.playTrackFromQueue()},he.addMix(c);const m=document.getElementById("like-mix-btn");if(m){m.style.display="flex";const f=await C.isFavorite("mix",c.id);m.innerHTML=this.createHeartIcon(f),m.classList.toggle("active",f)}document.title=h}catch(c){console.error("Failed to load mix:",c),r.innerHTML=F(`Could not load mix details. ${c.message}`)}}async renderArtistPage(e){this.showPage("artist");const t=document.getElementById("artist-detail-image"),s=document.getElementById("artist-detail-name"),a=document.getElementById("artist-detail-meta"),i=document.getElementById("artist-detail-tracks"),r=document.getElementById("artist-detail-albums"),l=document.getElementById("artist-detail-eps"),o=document.getElementById("artist-section-eps"),c=document.getElementById("artist-detail-similar"),d=document.getElementById("artist-section-similar"),h=document.getElementById("download-discography-btn");h&&(h.innerHTML=`${fe}<span>Download Discography</span>`),t.src="",t.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 150px;"></div>',i.innerHTML=this.createSkeletonTracks(5,!0),r.innerHTML=this.createSkeletonCards(6,!1),l&&(l.innerHTML=this.createSkeletonCards(6,!1)),o&&(o.style.display="none"),c&&(c.innerHTML=this.createSkeletonCards(6,!0)),d&&(d.style.display="block");try{const u=await this.api.getArtist(e),m=document.getElementById("artist-mix-btn");m&&(u.mixes&&u.mixes.ARTIST_MIX?(m.style.display="flex",m.onclick=()=>window.location.hash=`#mix/${u.mixes.ARTIST_MIX}`):m.style.display="none"),c&&d&&this.api.getSimilarArtists(e).then(y=>{y&&y.length>0?(c.innerHTML=y.map(v=>this.createArtistCardHTML(v)).join(""),d.style.display="block"):d.style.display="none"}).catch(()=>{d.style.display="none"}),t.src=this.api.getArtistPictureUrl(u.picture),t.style.backgroundColor="",s.textContent=u.name,this.setPageBackground(t.src);const f=this.api.getArtistPictureUrl(u.picture,"160");this.extractAndApplyColor(f),this.adjustTitleFontSize(s,u.name),a.innerHTML=`
                <span>${u.popularity}% popularity</span>
                <div class="artist-tags">
                    ${(u.artistRoles||[]).filter(y=>y.category).map(y=>`<span class="artist-tag">${y.category}</span>`).join("")}
                </div>
            `,this.renderListWithTracks(i,u.tracks,!0);const g=document.getElementById("like-artist-btn");if(g){const y=await C.isFavorite("artist",u.id);g.innerHTML=this.createHeartIcon(y),g.classList.toggle("active",y)}r.innerHTML=u.albums.map(y=>this.createAlbumCardHTML(y)).join(""),r.innerHTML=u.albums.length?u.albums.map(y=>this.createAlbumCardHTML(y)).join(""):F("No albums found."),l&&o&&(u.eps&&u.eps.length>0?(l.innerHTML=u.eps.map(y=>this.createAlbumCardHTML(y)).join(""),o.style.display="block"):o.style.display="none"),u.albums.forEach(y=>{const v=r.querySelector(`[data-album-id="${y.id}"]`);v&&(O.set(v,y),this.updateLikeState(v,"album",y.id))}),he.addArtist(u),document.title=u.name}catch(u){console.error("Failed to load artist:",u),i.innerHTML=r.innerHTML=F(`Could not load artist details. ${u.message}`)}}async renderRecentPage(){this.showPage("recent");const e=document.getElementById("recent-tracks-container");e.innerHTML=this.createSkeletonTracks(10,!0);try{const t=await C.getHistory();if(t.length===0){e.innerHTML=F("You haven't played any tracks yet.");return}const s={},a=new Date().setHours(0,0,0,0),i=new Date(a-864e5).setHours(0,0,0,0);t.forEach(r=>{const l=new Date(r.timestamp),o=new Date(l).setHours(0,0,0,0);let c;o===a?c="Today":o===i?c="Yesterday":c=l.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),s[c]||(s[c]=[]),s[c].push(r)}),e.innerHTML="";for(const[r,l]of Object.entries(s)){const o=document.createElement("h3");o.className="track-list-header-group",o.textContent=r,o.style.margin="1.5rem 0 0.5rem 0",o.style.fontSize="1.1rem",o.style.fontWeight="600",o.style.color="var(--foreground)",o.style.paddingLeft="0.5rem",e.appendChild(o);const c=document.createElement("div");for(this.renderListWithTracks(c,l,!0);c.firstChild;)e.appendChild(c.firstChild)}}catch(t){console.error("Failed to load history:",t),e.innerHTML=F("Failed to load history.")}}updatePlaylistHeaderActions(e,t,s,a=!1){const i=document.getElementById("page-playlist").querySelector(".detail-header-actions");["shuffle-playlist-btn","edit-playlist-btn","delete-playlist-btn","share-playlist-btn"].forEach(c=>{const d=i.querySelector(`#${c}`);d&&d.remove()});const r=document.createDocumentFragment(),l=document.createElement("button");if(l.id="shuffle-playlist-btn",l.className="btn-primary",l.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 14 4 4-4 4"/><path d="m18 2 4 4-4 4"/><path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22"/><path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"/><path d="M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45"/></svg><span>Shuffle</span>',l.onclick=()=>{const c=[...s].sort(()=>Math.random()-.5);this.player.setQueue(c,0),this.player.playTrackFromQueue()},r.appendChild(l),t){const c=document.createElement("button");c.id="edit-playlist-btn",c.className="btn-secondary",c.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><span>Edit</span>',r.appendChild(c);const d=document.createElement("button");d.id="delete-playlist-btn",d.className="btn-secondary danger",d.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span>Delete</span>',r.appendChild(d)}if(a||t&&e.isPublic){const c=document.createElement("button");c.id="share-playlist-btn",c.className="btn-secondary",c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg><span>Share</span>',c.onclick=()=>{const d=`${window.location.origin}${window.location.pathname}#userplaylist/${e.id||e.uuid}`;navigator.clipboard.writeText(d).then(()=>alert("Link copied to clipboard!"))},r.appendChild(c)}const o=i.querySelector("#download-playlist-btn");if(o)for(i.insertBefore(l,o);r.firstChild;)i.appendChild(r.firstChild);else i.appendChild(r)}enableTrackReordering(e,t,s,a){let i=null,r=-1;Array.from(e.querySelectorAll(".track-item")).forEach((m,f)=>{m.draggable=!0,m.dataset.index=f});const o=m=>{i=m.target,r=parseInt(m.target.dataset.index),m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",r),i.classList.add("dragging")},c=()=>{i&&(i.classList.remove("dragging"),i=null)},d=m=>{if(m.preventDefault(),m.dataTransfer.dropEffect="move",!i)return;const f=u(e,m.clientY);f!==i&&(f?e.insertBefore(i,f):e.appendChild(i))},h=async m=>{if(m.preventDefault(),!i)return;const f=Array.from(e.querySelectorAll(".track-item")),g=f.map(y=>{const v=parseInt(y.dataset.index);return t[v]});f.forEach((y,v)=>{y.dataset.index=v}),t.length=0,t.push(...g),await C.updatePlaylistTracks(s,g),a.syncUserPlaylist({id:s,tracks:g},"update"),i=null,r=-1};e.addEventListener("dragstart",o),e.addEventListener("dragend",c),e.addEventListener("dragover",d),e.addEventListener("drop",h);function u(m,f){return[...m.querySelectorAll(".track-item:not(.dragging)")].reduce((y,v)=>{const I=v.getBoundingClientRect(),p=f-I.top-I.height/2;return p<0&&p>y.offset?{offset:p,element:v}:y},{offset:Number.NEGATIVE_INFINITY}).element}}getDragAfterElement(e,t){return[...e.querySelectorAll(".track-item:not(.dragging)")].reduce((a,i)=>{const r=i.getBoundingClientRect(),l=t-r.top-r.height/2;return l<0&&l>a.offset?{offset:l,element:i}:a},{offset:Number.NEGATIVE_INFINITY}).element}renderApiSettings(){const e=document.getElementById("api-instance-list");Promise.all([this.api.settings.getInstances("api"),this.api.settings.getInstances("streaming")]).then(([t,s])=>{const i=this.api.settings.getCachedSpeedTests()?.speeds||{},r=(c,d)=>{if(!c||c.length===0)return"";const h=c.map((u,m)=>{const f=d==="streaming"?`${u}#streaming`:u,g=i[f],y=g?g.speed===1/0||typeof g.speed!="number"?'<span style="color: var(--muted-foreground); font-size: 0.8rem;">Failed</span>':`<span style="color: var(--muted-foreground); font-size: 0.8rem;">${g.speed.toFixed(0)}ms</span>`:"";return`
                        <li data-index="${m}" data-type="${d}">
                            <div style="flex: 1; min-width: 0;">
                                <div class="instance-url">${u}</div>
                                ${y}
                            </div>
                            <div class="controls">
                                <button class="move-up" title="Move Up" ${m===0?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 19V5M5 12l7-7 7 7"/>
                                    </svg>
                                </button>
                                <button class="move-down" title="Move Down" ${m===c.length-1?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `}).join("");return`
                    <li class="group-header" style="font-weight: bold; padding: 1rem 0 0.5rem; background: transparent; border: none; pointer-events: none;">
                        ${d==="api"?"API Instances":"Streaming Instances"}
                    </li>
                    ${h}
                `};e.innerHTML=r(t,"api")+r(s,"streaming");const l=this.api.getCacheStats(),o=document.getElementById("cache-info");o&&(o.textContent=`Cache: ${l.memoryEntries}/${l.maxSize} entries`)})}}class Us{constructor(e,t,s="LOSSLESS"){this.audio=e,this.api=t,this.quality=s,this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.shuffleActive=!1,this.repeatMode=V.OFF,this.preloadCache=new Map,this.preloadAbortController=null,this.currentTrack=null,this.currentRgValues=null,this.userVolume=parseFloat(localStorage.getItem("volume")||"0.7"),this.sleepTimer=null,this.sleepTimerEndTime=null,this.sleepTimerInterval=null,this.loadQueueState(),this.setupMediaSession(),window.addEventListener("beforeunload",()=>{this.saveQueueState()})}setVolume(e){this.userVolume=Math.max(0,Math.min(1,e)),localStorage.setItem("volume",this.userVolume),this.applyReplayGain()}applyReplayGain(){const e=be.getMode();let t=0,s=1;if(e!=="off"&&this.currentRgValues){const{trackReplayGain:r,trackPeakAmplitude:l,albumReplayGain:o,albumPeakAmplitude:c}=this.currentRgValues;e==="album"&&o!==void 0?(t=o,s=c||1):r!==void 0&&(t=r,s=l||1),t+=be.getPreamp()}let a=Math.pow(10,t/20);a*s>1&&(a=1/s);const i=this.userVolume*a;this.audio.volume=Math.max(0,Math.min(1,i))}loadQueueState(){const e=mt.getQueue();if(e){this.queue=e.queue||[],this.shuffledQueue=e.shuffledQueue||[],this.originalQueueBeforeShuffle=e.originalQueueBeforeShuffle||[],this.currentQueueIndex=e.currentQueueIndex??-1,this.shuffleActive=e.shuffleActive||!1,this.repeatMode=e.repeatMode||V.OFF;const t=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex>=0&&this.currentQueueIndex<t.length){this.currentTrack=t[this.currentQueueIndex];const s=this.currentTrack,a=te(s),i=dt(s);let r="";const l=s.album?.releaseDate||s.streamStartDate;if(l){const m=new Date(l);isNaN(m.getTime())||(r=` • ${m.getFullYear()}`)}const o=document.querySelector(".now-playing-bar .cover"),c=document.querySelector(".now-playing-bar .title"),d=document.querySelector(".now-playing-bar .artist");o&&(o.src=this.api.getCoverUrl(s.album?.cover)),c&&(c.textContent=a),d&&(d.innerHTML=i+r);const h=document.getElementById("now-playing-mix-btn");h&&(h.style.display=s.mixes&&s.mixes.TRACK_MIX?"flex":"none");const u=document.getElementById("total-duration");u&&(u.textContent=Te(s.duration)),document.title=`${a} • ${ee(s)}`,this.updatePlayingTrackIndicator(),this.updateMediaSession(s)}}}saveQueueState(){mt.saveQueue({queue:this.queue,shuffledQueue:this.shuffledQueue,originalQueueBeforeShuffle:this.originalQueueBeforeShuffle,currentQueueIndex:this.currentQueueIndex,shuffleActive:this.shuffleActive,repeatMode:this.repeatMode})}setupMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{this.audio.play().catch(console.error)}),navigator.mediaSession.setActionHandler("pause",()=>{this.audio.pause()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.playPrev()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.playNext()}),navigator.mediaSession.setActionHandler("seekbackward",e=>{const t=e.seekOffset||10;this.seekBackward(t)}),navigator.mediaSession.setActionHandler("seekforward",e=>{const t=e.seekOffset||10;this.seekForward(t)}),navigator.mediaSession.setActionHandler("seekto",e=>{e.seekTime!==void 0&&(this.audio.currentTime=Math.max(0,e.seekTime),this.updateMediaSessionPositionState())}),navigator.mediaSession.setActionHandler("stop",()=>{this.audio.pause(),this.audio.currentTime=0,this.updateMediaSessionPlaybackState()}))}setQuality(e){this.quality=e}async preloadNextTracks(){this.preloadAbortController&&this.preloadAbortController.abort(),this.preloadAbortController=new AbortController;const e=this.shuffleActive?this.shuffledQueue:this.queue,t=[];for(let s=1;s<=2;s++){const a=this.currentQueueIndex+s;a<e.length&&t.push({track:e[a],index:a})}for(const{track:s}of t){if(this.preloadCache.has(s.id))continue;const a=te(s);try{const i=await this.api.getStreamUrl(s.id,this.quality);if(this.preloadAbortController.signal.aborted)break;this.preloadCache.set(s.id,i),fetch(i,{method:"HEAD",signal:this.preloadAbortController.signal}).catch(()=>{})}catch(i){i.name!=="AbortError"&&console.debug("Failed to get stream URL for preload:",a)}}}async playTrackFromQueue(e=0){const t=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex<0||this.currentQueueIndex>=t.length)return;this.saveQueueState();const s=t[this.currentQueueIndex];this.currentTrack=s;const a=te(s),i=dt(s);let r="";const l=s.album?.releaseDate||s.streamStartDate;if(l){const c=new Date(l);isNaN(c.getTime())||(r=` • ${c.getFullYear()}`)}document.querySelector(".now-playing-bar .cover").src=this.api.getCoverUrl(s.album?.cover),document.querySelector(".now-playing-bar .title").textContent=a,document.querySelector(".now-playing-bar .artist").innerHTML=i+r;const o=document.getElementById("now-playing-mix-btn");o&&(o.style.display=s.mixes&&s.mixes.TRACK_MIX?"flex":"none"),document.title=`${a} • ${ee(s)}`,this.updatePlayingTrackIndicator();try{const c=await this.api.getTrack(s.id,this.quality);c&&c.info?this.currentRgValues={trackReplayGain:c.info.trackReplayGain,trackPeakAmplitude:c.info.trackPeakAmplitude,albumReplayGain:c.info.albumReplayGain,albumPeakAmplitude:c.info.albumPeakAmplitude}:this.currentRgValues=null,this.applyReplayGain();let d;this.preloadCache.has(s.id)?d=this.preloadCache.get(s.id):c.originalTrackUrl?d=c.originalTrackUrl:d=this.api.extractStreamUrlFromManifest(c.info.manifest),this.audio.src=d,e>0&&(this.audio.currentTime=e),await this.audio.play(),this.updateMediaSession(s),this.updateMediaSessionPlaybackState(),this.preloadNextTracks()}catch(c){console.error(`Could not play track: ${a}`,c),document.querySelector(".now-playing-bar .title").textContent=`Error: ${a}`,document.querySelector(".now-playing-bar .artist").textContent=c.message||"Could not load track"}}playAtIndex(e){const t=this.shuffleActive?this.shuffledQueue:this.queue;e>=0&&e<t.length&&(this.currentQueueIndex=e,this.playTrackFromQueue())}playNext(){const e=this.shuffleActive?this.shuffledQueue:this.queue,t=this.currentQueueIndex>=e.length-1;if(this.repeatMode===V.ONE){this.audio.currentTime=0,this.audio.play();return}if(!t)this.currentQueueIndex++;else if(this.repeatMode===V.ALL)this.currentQueueIndex=0;else return;this.playTrackFromQueue()}playPrev(){this.audio.currentTime>3?(this.audio.currentTime=0,this.updateMediaSessionPositionState()):this.currentQueueIndex>0&&(this.currentQueueIndex--,this.playTrackFromQueue())}handlePlayPause(){if(!this.audio.src||this.audio.error){this.currentTrack&&this.playTrackFromQueue();return}this.audio.paused?this.audio.play().catch(e=>{e.name==="NotAllowedError"||e.name==="AbortError"||(console.error("Play failed, reloading track:",e),this.currentTrack&&this.playTrackFromQueue())}):(this.audio.pause(),this.saveQueueState())}seekBackward(e=10){const t=Math.max(0,this.audio.currentTime-e);this.audio.currentTime=t,this.updateMediaSessionPositionState()}seekForward(e=10){const t=this.audio.duration||0,s=Math.min(t,this.audio.currentTime+e);this.audio.currentTime=s,this.updateMediaSessionPositionState()}toggleShuffle(){if(this.shuffleActive=!this.shuffleActive,this.shuffleActive){this.originalQueueBeforeShuffle=[...this.queue];const e=this.queue[this.currentQueueIndex];this.shuffledQueue=[...this.queue].sort(()=>Math.random()-.5),this.currentQueueIndex=this.shuffledQueue.findIndex(t=>t.id===e?.id),this.currentQueueIndex===-1&&e&&(this.shuffledQueue.unshift(e),this.currentQueueIndex=0)}else{const e=this.shuffledQueue[this.currentQueueIndex];this.queue=[...this.originalQueueBeforeShuffle],this.currentQueueIndex=this.queue.findIndex(t=>t.id===e?.id)}this.preloadCache.clear(),this.preloadNextTracks(),this.saveQueueState()}toggleRepeat(){return this.repeatMode=(this.repeatMode+1)%3,this.saveQueueState(),this.repeatMode}setQueue(e,t=0){this.queue=e,this.currentQueueIndex=t,this.shuffleActive=!1,this.preloadCache.clear(),this.saveQueueState()}addToQueue(e){this.queue.push(e),(!this.currentTrack||this.currentQueueIndex===-1)&&(this.currentQueueIndex=this.queue.length-1,this.playTrackFromQueue()),this.saveQueueState()}addNextToQueue(e){const t=this.shuffleActive?this.shuffledQueue:this.queue,s=this.currentQueueIndex+1;t.splice(s,0,e),this.shuffleActive&&this.originalQueueBeforeShuffle.push(e),this.saveQueueState(),this.preloadNextTracks()}removeFromQueue(e){const t=this.shuffleActive?this.shuffledQueue:this.queue;this.currentQueueIndex,e<this.currentQueueIndex&&this.currentQueueIndex--;const s=t.splice(e,1)[0];if(this.shuffleActive){const a=this.originalQueueBeforeShuffle.findIndex(i=>i.id===s.id);a!==-1&&this.originalQueueBeforeShuffle.splice(a,1)}this.saveQueueState(),this.preloadNextTracks()}clearQueue(){this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.preloadCache.clear(),this.saveQueueState()}moveInQueue(e,t){const s=this.shuffleActive?this.shuffledQueue:this.queue;if(e<0||e>=s.length||t<0||t>=s.length)return;const[a]=s.splice(e,1);s.splice(t,0,a),this.currentQueueIndex===e?this.currentQueueIndex=t:e<this.currentQueueIndex&&t>=this.currentQueueIndex?this.currentQueueIndex--:e>this.currentQueueIndex&&t<=this.currentQueueIndex&&this.currentQueueIndex++,this.saveQueueState()}getCurrentQueue(){return this.shuffleActive?this.shuffledQueue:this.queue}getNextTrack(){const e=this.getCurrentQueue();if(this.currentQueueIndex===-1||e.length===0)return null;const t=this.currentQueueIndex+1;return t<e.length?e[t]:this.repeatMode===V.ALL?e[0]:null}updatePlayingTrackIndicator(){const e=this.getCurrentQueue()[this.currentQueueIndex];document.querySelectorAll(".track-item").forEach(t=>{t.classList.toggle("playing",e&&t.dataset.trackId==e.id)}),document.querySelectorAll(".queue-track-item").forEach(t=>{const s=parseInt(t.dataset.queueIndex);t.classList.toggle("playing",s===this.currentQueueIndex)})}updateMediaSession(e){if(!("mediaSession"in navigator))return;navigator.mediaSession.metadata=null;const t=[],s=["320"],a=e.album?.cover,i=te(e);a&&s.forEach(r=>{t.push({src:this.api.getCoverUrl(a,r),sizes:`${r}x${r}`,type:"image/jpeg"})}),navigator.mediaSession.metadata=new MediaMetadata({title:i||"Unknown Title",artist:ee(e)||"Unknown Artist",album:e.album?.title||"Unknown Album",artwork:t.length>0?t:void 0}),this.updateMediaSessionPlaybackState(),this.updateMediaSessionPositionState()}updateMediaSessionPlaybackState(){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=this.audio.paused?"paused":"playing")}updateMediaSessionPositionState(){if(!("mediaSession"in navigator)||!("setPositionState"in navigator.mediaSession))return;const e=this.audio.duration;if(!(!e||isNaN(e)||!isFinite(e)))try{navigator.mediaSession.setPositionState({duration:e,playbackRate:this.audio.playbackRate||1,position:Math.min(this.audio.currentTime,e)})}catch(t){console.debug("Failed to update Media Session position:",t)}}setSleepTimer(e){this.clearSleepTimer(),this.sleepTimerEndTime=Date.now()+e*60*1e3,this.sleepTimer=setTimeout(()=>{this.audio.pause(),this.clearSleepTimer(),this.updateSleepTimerUI()},e*60*1e3),this.sleepTimerInterval=setInterval(()=>{this.updateSleepTimerUI()},1e3),this.updateSleepTimerUI()}clearSleepTimer(){this.sleepTimer&&(clearTimeout(this.sleepTimer),this.sleepTimer=null),this.sleepTimerInterval&&(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null),this.sleepTimerEndTime=null,this.updateSleepTimerUI()}getSleepTimerRemaining(){if(!this.sleepTimerEndTime)return null;const e=Math.max(0,this.sleepTimerEndTime-Date.now());return Math.ceil(e/1e3)}isSleepTimerActive(){return this.sleepTimer!==null}updateSleepTimerUI(){const e=document.getElementById("sleep-timer-btn"),t=document.getElementById("sleep-timer-btn-desktop"),s=a=>{if(a)if(this.isSleepTimerActive()){const i=this.getSleepTimerRemaining();if(i>0){const r=Math.floor(i/60),l=i%60;a.innerHTML=`<span style="font-size: 12px; font-weight: bold;">${r}:${l.toString().padStart(2,"0")}</span>`,a.title=`Sleep Timer: ${r}:${l.toString().padStart(2,"0")} remaining`,a.classList.add("active"),a.style.color="var(--primary)"}else a.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    `,a.title="Sleep Timer",a.classList.remove("active"),a.style.color=""}else a.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                `,a.title="Sleep Timer",a.classList.remove("active"),a.style.color=""};s(e),s(t)}}const js="modulepreload",qs=function(n,e){return new URL(n,e).href},gt={},Q=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){let c=function(d){return Promise.all(d.map(h=>Promise.resolve(h).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const r=document.getElementsByTagName("link"),l=document.querySelector("meta[property=csp-nonce]"),o=l?.nonce||l?.getAttribute("nonce");a=c(t.map(d=>{if(d=qs(d,s),d in gt)return;gt[d]=!0;const h=d.endsWith(".css"),u=h?'[rel="stylesheet"]':"";if(s)for(let f=r.length-1;f>=0;f--){const g=r[f];if(g.href===d&&(!h||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${u}`))return;const m=document.createElement("link");if(m.rel=h?"stylesheet":js,h||(m.as="script"),m.crossOrigin="",m.href=d,o&&m.setAttribute("nonce",o),document.head.appendChild(m),h)return new Promise((f,g)=>{m.addEventListener("load",f),m.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(r){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=r,window.dispatchEvent(l),!l.defaultPrevented)throw r}return a.then(r=>{for(const l of r||[])l.status==="rejected"&&i(l.reason);return e().catch(i)})};class Qs{constructor(){this.API_KEY="0ecf01914957b40c17030db822845a76",this.API_SECRET="bd37e61e0b16b8c7bf8de2862de5493c",this.API_URL="https://ws.audioscrobbler.com/2.0/",this.sessionKey=null,this.username=null,this.currentTrack=null,this.scrobbleTimer=null,this.scrobbleThreshold=0,this.hasScrobbled=!1,this.loadSession()}loadSession(){try{const e=localStorage.getItem("lastfm-session");if(e){const t=JSON.parse(e);this.sessionKey=t.key,this.username=t.name}}catch(e){console.error("Failed to load Last.fm session:",e)}}saveSession(e,t){this.sessionKey=e,this.username=t,localStorage.setItem("lastfm-session",JSON.stringify({key:e,name:t}))}clearSession(){this.sessionKey=null,this.username=null,localStorage.removeItem("lastfm-session")}isAuthenticated(){return!!this.sessionKey}async generateSignature(e){const t={...e};delete t.format,delete t.callback;const a=Object.keys(t).sort().map(i=>`${i}${t[i]}`).join("")+this.API_SECRET;console.log("Signature string:",a);try{const{default:i}=await Q(async()=>{const{default:r}=await import("https://cdn.jsdelivr.net/npm/md5@2.3.0/+esm");return{default:r}},[],import.meta.url);return i(a)}catch{throw console.error("MD5 library not available"),new Error("MD5 library required for Last.fm")}}async makeRequest(e,t={},s=!1){const a={method:e,api_key:this.API_KEY,...t};s&&this.sessionKey&&(a.sk=this.sessionKey);const i=await this.generateSignature(a),r=new URLSearchParams({...a,api_sig:i,format:"json"});try{const o=await(await fetch(this.API_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r})).json();if(o.error)throw new Error(o.message||"Last.fm API error");return o}catch(l){throw console.error("Last.fm API request failed:",l),l}}async getAuthUrl(){try{const t=(await this.makeRequest("auth.getToken")).token;return{token:t,url:`https://www.last.fm/api/auth/?api_key=${this.API_KEY}&token=${t}`}}catch(e){throw console.error("Failed to get auth URL:",e),e}}async completeAuthentication(e){try{const t=await this.makeRequest("auth.getSession",{token:e});if(t.session)return this.saveSession(t.session.key,t.session.name),{success:!0,username:t.session.name};throw new Error("No session returned")}catch(t){throw console.error("Authentication failed:",t),t}}async updateNowPlaying(e){if(this.isAuthenticated()){this.currentTrack=e,this.hasScrobbled=!1,this.clearScrobbleTimer();try{const t={artist:e.artist?.name||e.artists?.[0]?.name||"Unknown Artist",track:e.title};e.album?.title&&(t.album=e.album.title),e.duration&&(t.duration=Math.floor(e.duration)),e.trackNumber&&(t.trackNumber=e.trackNumber),await this.makeRequest("track.updateNowPlaying",t,!0),console.log("Now playing updated:",e.title),this.scrobbleThreshold=Math.min(e.duration/2,240),this.scheduleScrobble(this.scrobbleThreshold*1e3)}catch(t){console.error("Failed to update now playing:",t)}}}scheduleScrobble(e){this.clearScrobbleTimer(),this.scrobbleTimer=setTimeout(()=>{this.scrobbleCurrentTrack()},e)}clearScrobbleTimer(){this.scrobbleTimer&&(clearTimeout(this.scrobbleTimer),this.scrobbleTimer=null)}async scrobbleCurrentTrack(){if(!(!this.isAuthenticated()||!this.currentTrack||this.hasScrobbled))try{const e=Math.floor(Date.now()/1e3),t={artist:this.currentTrack.artist?.name||this.currentTrack.artists?.[0]?.name||"Unknown Artist",track:this.currentTrack.title,timestamp:e};this.currentTrack.album?.title&&(t.album=this.currentTrack.album.title),this.currentTrack.duration&&(t.duration=Math.floor(this.currentTrack.duration)),this.currentTrack.trackNumber&&(t.trackNumber=this.currentTrack.trackNumber),await this.makeRequest("track.scrobble",t,!0),this.hasScrobbled=!0,console.log("Scrobbled:",this.currentTrack.title)}catch(e){console.error("Failed to scrobble:",e)}}async loveTrack(e){if(this.isAuthenticated())try{const t={artist:e.artist?.name||e.artists?.[0]?.name||"Unknown Artist",track:e.title};await this.makeRequest("track.love",t,!0),console.log("Loved track on Last.fm:",e.title)}catch(t){console.error("Failed to love track on Last.fm:",t)}}onTrackChange(e){this.isAuthenticated()&&this.updateNowPlaying(e)}onPlaybackStop(){this.clearScrobbleTimer()}disconnect(){this.clearSession(),this.clearScrobbleTimer(),this.currentTrack=null}}function zs(n){return()=>{const t=window.location.hash.substring(1)||"home",[s,a]=t.split("/");switch(s){case"search":n.renderSearchPage(decodeURIComponent(a));break;case"album":n.renderAlbumPage(a);break;case"artist":n.renderArtistPage(a);break;case"playlist":n.renderPlaylistPage(a,"api");break;case"userplaylist":n.renderPlaylistPage(a,"user");break;case"mix":n.renderMixPage(a);break;case"library":n.renderLibraryPage();break;case"recent":n.renderRecentPage();break;case"home":n.renderHomePage();break;default:n.showPage(s);break}}}function Rt(n){if(n.currentTrack){const e=n.currentTrack;document.title=`${e.title} • ${ee(e)}`}else{const e=window.location.hash;if(e.includes("#album/")||e.includes("#playlist/"))return;document.title="Monochrome Music"}}class Ks{constructor(){this.user=null,this.unsubscribe=null,this.init()}init(){X&&(this.unsubscribe=Kt(X,e=>{this.user=e,this.updateUI(e),e?(console.log("User logged in:",e.uid),N.initialize(e)):(console.log("User logged out"),N.disconnect())}))}async signInWithGoogle(){if(!X){alert("Firebase is not configured. Please check console.");return}try{return(await Gt(X,Bt)).user}catch(e){throw console.error("Login failed:",e),alert(`Login failed: ${e.message}`),e}}async signInWithEmail(e,t){if(!X){alert("Firebase is not configured.");return}try{return(await Wt(X,e,t)).user}catch(s){throw console.error("Email Login failed:",s),alert(`Login failed: ${s.message}`),s}}async signUpWithEmail(e,t){if(!X){alert("Firebase is not configured.");return}try{return(await Vt(X,e,t)).user}catch(s){throw console.error("Sign Up failed:",s),alert(`Sign Up failed: ${s.message}`),s}}async signOut(){if(X)try{await Yt(X)}catch(e){throw console.error("Logout failed:",e),e}}updateUI(e){const t=document.getElementById("firebase-connect-btn"),s=document.getElementById("firebase-clear-cloud-btn"),a=document.getElementById("firebase-status"),i=document.getElementById("email-auth-container"),r=document.getElementById("toggle-email-auth-btn");t&&(e?(t.textContent="Sign Out",t.classList.add("danger"),t.onclick=()=>this.signOut(),s&&(s.style.display="block"),i&&(i.style.display="none"),r&&(r.style.display="none"),a&&(a.textContent=`Signed in as ${e.email}`)):(t.textContent="Connect with Google",t.classList.remove("danger"),t.onclick=()=>this.signInWithGoogle(),s&&(s.style.display="none"),r&&(r.style.display="inline-block"),a&&(a.textContent="Sync your library across devices")))}}const ke=new Ks;function Gs(n,e,t,s){ke.updateUI(ke.user),Fs();const a=document.getElementById("toggle-email-auth-btn"),i=document.getElementById("cancel-email-auth-btn"),r=document.getElementById("email-auth-container"),l=document.getElementById("auth-buttons-container"),o=document.getElementById("auth-email"),c=document.getElementById("auth-password"),d=document.getElementById("email-signin-btn"),h=document.getElementById("email-signup-btn");a&&r&&l&&a.addEventListener("click",()=>{r.style.display="flex",l.style.display="none"}),i&&r&&l&&i.addEventListener("click",()=>{r.style.display="none",l.style.display="flex"}),d&&d.addEventListener("click",async()=>{const E=o.value,M=c.value;if(!E||!M){alert("Please enter both email and password.");return}try{await ke.signInWithEmail(E,M),r.style.display="none",l.style.display="flex",o.value="",c.value=""}catch{}}),h&&h.addEventListener("click",async()=>{const E=o.value,M=c.value;if(!E||!M){alert("Please enter both email and password.");return}try{await ke.signUpWithEmail(E,M),r.style.display="none",l.style.display="flex",o.value="",c.value=""}catch{}});const u=document.getElementById("lastfm-connect-btn"),m=document.getElementById("lastfm-status"),f=document.getElementById("lastfm-toggle"),g=document.getElementById("lastfm-toggle-setting"),y=document.getElementById("lastfm-love-toggle"),v=document.getElementById("lastfm-love-setting");function I(){n.isAuthenticated()?(m.textContent=`Connected as ${n.username}`,u.textContent="Disconnect",u.classList.add("danger"),g.style.display="flex",v.style.display="flex",f.checked=oe.isEnabled(),y.checked=oe.shouldLoveOnLike()):(m.textContent="Connect your Last.fm account to scrobble tracks",u.textContent="Connect Last.fm",u.classList.remove("danger"),g.style.display="none",v.style.display="none")}I(),u?.addEventListener("click",async()=>{if(n.isAuthenticated()){confirm("Disconnect from Last.fm?")&&(n.disconnect(),I());return}const E=window.open("","_blank");u.disabled=!0,u.textContent="Opening Last.fm...";try{const{token:M,url:R}=await n.getAuthUrl();if(E)E.location.href=R;else{alert("Popup blocked! Please allow popups."),u.textContent="Connect Last.fm",u.disabled=!1;return}u.textContent="Waiting for authorization...";let H=0;const ae=30,z=setInterval(async()=>{if(H++,H>ae){clearInterval(z),u.textContent="Connect Last.fm",u.disabled=!1,E&&!E.closed&&E.close(),alert("Authorization timed out. Please try again.");return}try{const Qe=await n.completeAuthentication(M);Qe.success&&(clearInterval(z),E&&!E.closed&&E.close(),I(),u.disabled=!1,oe.setEnabled(!0),f.checked=!0,alert(`Successfully connected to Last.fm as ${Qe.username}!`))}catch{}},2e3)}catch(M){console.error("Last.fm connection failed:",M),alert("Failed to connect to Last.fm: "+M.message),u.textContent="Connect Last.fm",u.disabled=!1,E&&!E.closed&&E.close()}}),f?.addEventListener("change",E=>{oe.setEnabled(E.target.checked)}),y?.addEventListener("change",E=>{oe.setLoveOnLike(E.target.checked)});const p=document.getElementById("theme-picker"),b=re.getTheme();p.querySelectorAll(".theme-option").forEach(E=>{E.dataset.theme===b&&E.classList.add("active"),E.addEventListener("click",()=>{const M=E.dataset.theme;p.querySelectorAll(".theme-option").forEach(R=>R.classList.remove("active")),E.classList.add("active"),M==="custom"?(document.getElementById("custom-theme-editor").classList.add("show"),w(),re.setTheme("custom")):(document.getElementById("custom-theme-editor").classList.remove("show"),re.setTheme(M))})});function w(){const E=document.getElementById("theme-color-grid"),M=re.getCustomTheme()||{background:"#000000",foreground:"#fafafa",primary:"#ffffff",secondary:"#27272a",muted:"#27272a",border:"#27272a",highlight:"#ffffff"};E.innerHTML=Object.entries(M).map(([R,H])=>`
            <div class="theme-color-input">
                <label>${R}</label>
                <input type="color" data-color="${R}" value="${H}">
            </div>
        `).join("")}document.getElementById("apply-custom-theme")?.addEventListener("click",()=>{const E={};document.querySelectorAll('#theme-color-grid input[type="color"]').forEach(M=>{E[M.dataset.color]=M.value}),re.setCustomTheme(E)}),document.getElementById("reset-custom-theme")?.addEventListener("click",()=>{w()});const T=document.getElementById("streaming-quality-setting");if(T){const E=localStorage.getItem("playback-quality")||"LOSSLESS";T.value=E,e.setQuality(E),T.addEventListener("change",M=>{const R=M.target.value;e.setQuality(R),localStorage.setItem("playback-quality",R)})}const k=document.getElementById("download-quality-setting");k&&(k.value=ue.getQuality(),k.addEventListener("change",E=>{ue.setQuality(E.target.value)}));const L=document.getElementById("replay-gain-mode");L&&(L.value=be.getMode(),L.addEventListener("change",E=>{be.setMode(E.target.value),e.applyReplayGain()}));const S=document.getElementById("replay-gain-preamp");S&&(S.value=be.getPreamp(),S.addEventListener("change",E=>{be.setPreamp(parseFloat(E.target.value)||3),e.applyReplayGain()}));const x=document.getElementById("now-playing-mode");x&&(x.value=Ye.getMode(),x.addEventListener("change",E=>{Ye.setMode(E.target.value)}));const P=document.getElementById("track-list-actions-mode");P&&(P.value=Je.getMode(),P.addEventListener("change",E=>{Je.setMode(E.target.value)}));const A=document.getElementById("compact-artist-toggle");A&&(A.checked=ne.isCompactArtist(),A.addEventListener("change",E=>{ne.setCompactArtist(E.target.checked)}));const $=document.getElementById("compact-album-toggle");$&&($.checked=ne.isCompactAlbum(),$.addEventListener("change",E=>{ne.setCompactAlbum(E.target.checked)}));const _=document.getElementById("download-lyrics-toggle");_&&(_.checked=Ee.shouldDownloadLyrics(),_.addEventListener("change",E=>{Ee.setDownloadLyrics(E.target.checked)}));const B=document.getElementById("romaji-lyrics-toggle");B&&(B.checked=localStorage.getItem("lyricsRomajiMode")==="true",B.addEventListener("change",E=>{localStorage.setItem("lyricsRomajiMode",E.target.checked?"true":"false")}));const D=document.getElementById("album-background-toggle");D&&(D.checked=ye.isEnabled(),D.addEventListener("change",E=>{ye.setEnabled(E.target.checked)}));const j=document.getElementById("waveform-toggle");j&&(j.checked=Xe.isEnabled(),j.addEventListener("change",E=>{Xe.setEnabled(E.target.checked),window.dispatchEvent(new CustomEvent("waveform-toggle",{detail:{enabled:E.target.checked}}))}));const J=document.getElementById("smooth-scrolling-toggle");J&&(J.checked=Ze.isEnabled(),J.addEventListener("change",E=>{Ze.setEnabled(E.target.checked),window.dispatchEvent(new CustomEvent("smooth-scrolling-toggle",{detail:{enabled:E.target.checked}}))}));const G=document.getElementById("filename-template");G&&(G.value=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",G.addEventListener("change",E=>{localStorage.setItem("filename-template",E.target.value)}));const se=document.getElementById("zip-folder-template");se&&(se.value=localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",se.addEventListener("change",E=>{localStorage.setItem("zip-folder-template",E.target.value)})),document.getElementById("refresh-speed-test-btn")?.addEventListener("click",async()=>{const E=document.getElementById("refresh-speed-test-btn"),M=E.textContent;E.textContent="Testing...",E.disabled=!0;try{await t.settings.refreshSpeedTests(),s.renderApiSettings(),E.textContent="Done!",setTimeout(()=>{E.textContent=M,E.disabled=!1},1500)}catch(R){console.error("Failed to refresh speed tests:",R),E.textContent="Error",setTimeout(()=>{E.textContent=M,E.disabled=!1},1500)}}),document.getElementById("api-instance-list")?.addEventListener("click",async E=>{const M=E.target.closest("button");if(!M)return;const R=M.closest("li"),H=parseInt(R.dataset.index,10),ae=R.dataset.type||"api",z=await t.settings.getInstances(ae);M.classList.contains("move-up")&&H>0?[z[H],z[H-1]]=[z[H-1],z[H]]:M.classList.contains("move-down")&&H<z.length-1&&([z[H],z[H+1]]=[z[H+1],z[H]]),t.settings.saveInstances(z,ae),s.renderApiSettings()}),document.getElementById("clear-cache-btn")?.addEventListener("click",async()=>{const E=document.getElementById("clear-cache-btn"),M=E.textContent;E.textContent="Clearing...",E.disabled=!0;try{await t.clearCache(),E.textContent="Cleared!",setTimeout(()=>{E.textContent=M,E.disabled=!1,window.location.hash.includes("settings")&&s.renderApiSettings()},1500)}catch(R){console.error("Failed to clear cache:",R),E.textContent="Error",setTimeout(()=>{E.textContent=M,E.disabled=!1},1500)}}),document.getElementById("firebase-clear-cloud-btn")?.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete ALL your data from the cloud? This cannot be undone."))try{await N.clearCloudData(),alert("Cloud data cleared successfully."),ke.signOut()}catch(E){console.error("Failed to clear cloud data:",E),alert("Failed to clear cloud data: "+E.message)}}),document.getElementById("export-library-btn")?.addEventListener("click",async()=>{const E=await C.exportData(),M=new Blob([JSON.stringify(E,null,2)],{type:"application/json"}),R=URL.createObjectURL(M),H=document.createElement("a");H.href=R,H.download=`monochrome-library-${new Date().toISOString().split("T")[0]}.json`,H.click(),URL.revokeObjectURL(R)});const q=document.getElementById("import-library-input");document.getElementById("import-library-btn")?.addEventListener("click",()=>{q.click()}),q?.addEventListener("change",async E=>{const M=E.target.files[0];if(!M)return;const R=new FileReader;R.onload=async H=>{try{const ae=JSON.parse(H.target.result);await C.importData(ae),alert("Library imported successfully!"),window.location.reload()}catch(ae){console.error("Import failed:",ae),alert("Failed to import library. Please check the file format.")}},R.readAsText(M)})}const Ie=new Map,xe=new Map;let K=null;function st(n,e,t){if(!t)return;const s=e?`${e}/cover.jpg`:"cover.jpg";n.file(s)||n.file(s,t)}async function Ws(){try{return(await Q(()=>import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm"),[],import.meta.url)).default}catch(n){throw console.error("Failed to load JSZip:",n),new Error("Failed to load ZIP library")}}function nt(){return K||(K=document.createElement("div"),K.id="download-notifications",document.body.appendChild(K)),K}function Y(n){const e=nt(),t=document.createElement("div");t.className="download-task",t.innerHTML=`
        <div style="display: flex; align-items: start;">
            ${n}
        </div>
    `,e.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.3s ease",setTimeout(()=>t.remove(),300)},1500)}function Dt(n,e,t,s,a){const i=nt(),r=document.createElement("div");r.className="download-task",r.dataset.trackId=n;const l=te(e),o=ee(e);return r.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <img src="${s.getCoverUrl(e.album?.cover)}"
                 style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${l}</div>
                <div style="font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">${o}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${Ce}
            </button>
        </div>
    `,i.appendChild(r),Ie.set(n,{taskEl:r,abortController:a}),r.querySelector(".download-cancel").addEventListener("click",()=>{a.abort(),Ue(n)}),{taskEl:r,abortController:a}}function Ht(n,e){const t=Ie.get(n);if(!t)return;const{taskEl:s}=t,a=s.querySelector(".download-progress-fill"),i=s.querySelector(".download-status");if(e.stage==="downloading"){const r=e.totalBytes?Math.round(e.receivedBytes/e.totalBytes*100):0;a.style.width=`${r}%`;const l=(e.receivedBytes/(1024*1024)).toFixed(1),o=e.totalBytes?(e.totalBytes/(1024*1024)).toFixed(1):"?";i.textContent=`Downloading: ${l}MB / ${o}MB (${r}%)`}}function et(n,e=!0,t=null){const s=Ie.get(n);if(!s)return;const{taskEl:a}=s,i=a.querySelector(".download-progress-fill"),r=a.querySelector(".download-status"),l=a.querySelector(".download-cancel");e?(i.style.width="100%",i.style.background="#10b981",r.textContent="✓ Downloaded",r.style.color="#10b981",l.remove(),setTimeout(()=>Ue(n),3e3)):(i.style.background="#ef4444",r.textContent=t||"✗ Download failed",r.style.color="#ef4444",l.innerHTML=`
            ${Ce}
        `,l.onclick=()=>Ue(n),setTimeout(()=>Ue(n),5e3))}function Ue(n){const e=Ie.get(n);if(!e)return;const{taskEl:t}=e;t.style.animation="slideOut 0.3s ease",setTimeout(()=>{t.remove(),Ie.delete(n),K&&K.children.length===0&&(K.remove(),K=null)},300)}function Vs(n){xe.get(n)&&(n.style.animation="slideOut 0.3s ease",setTimeout(()=>{n.remove(),xe.delete(n),K&&K.children.length===0&&(K.remove(),K=null)},300))}async function Ot(n,e,t,s=null,a=null){const i=await t.getTrack(n.id,e);let r;if(i.originalTrackUrl)r=i.originalTrackUrl;else if(r=t.extractStreamUrlFromManifest(i.info.manifest),!r)throw new Error("Could not resolve stream URL");const l=await fetch(r,{signal:a});if(!l.ok)throw new Error(`Failed to fetch track: ${l.status}`);let o=await l.blob();return o=await It(o,n,t,e),o}async function at(n,e,t,s,a=null){ot(t,s,s,"Creating ZIP...");try{if(a){const i=await a.createWritable();await new Promise((r,l)=>{n.generateInternalStream({type:"uint8array",compression:"STORE",streamFiles:!0}).on("data",(o,c)=>{i.write(o)}).on("error",o=>{i.close(),l(o)}).on("end",()=>{i.close(),r()}).resume()})}else{const i=await n.generateAsync({type:"blob",compression:"STORE",streamFiles:!0}),r=URL.createObjectURL(i),l=document.createElement("a");l.href=r,l.download=`${e}.zip`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r)}Ae(t,!0)}catch(i){console.error("ZIP generation failed:",i),Ae(t,!1,"ZIP creation failed")}}async function it(n,e=!1){const t=await Ws(),s=new t;let a=null;if(e&&window.showSaveFilePicker)try{a=await window.showSaveFilePicker({suggestedName:`${n}.zip`,types:[{description:"ZIP Archive",accept:{"application/zip":[".zip"]}}]})}catch(i){if(i.name==="AbortError")return null;throw i}return{zip:s,fileHandle:a}}async function Ft(n,e,t,s,a,i,r,l=0,o=e.length){const{abortController:c}=xe.get(r),d=c.signal;for(let h=0;h<e.length;h++){const u=e[h],m=l+h,f=je(u,a),g=te(u);ot(r,m,o,g);try{const y=await Ot(u,a,s,null,d);if(n.file(`${t}/${f}`,y),i&&Ee.shouldDownloadLyrics())try{const v=await i.fetchLyrics(u.id,u);if(v){const I=i.generateLRCContent(v,u);if(I){const p=f.replace(/\.[^.]+$/,".lrc");n.file(`${t}/${p}`,I)}}}catch{console.log("Could not add lyrics for:",g)}}catch(y){if(y.name==="AbortError")throw y;console.error(`Failed to download track ${g}:`,y)}}}async function Nt(n,e,t,s,a=null){const i=n.releaseDate||(e[0]?.streamStartDate?e[0].streamStartDate.split("T")[0]:""),r=i?new Date(i):null,l=r&&!isNaN(r.getTime())?r.getFullYear():"",o=qe(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:n.title,albumArtist:n.artist?.name,year:l}),c=await it(o,e.length>=20);if(!c)return;const{zip:d,fileHandle:h}=c,u=await Me(t,n.cover||n.album?.cover||n.coverId),m=rt("album",n.title,e.length);try{st(d,o,u),await Ft(d,e,o,t,s,a,m),await at(d,o,m,e.length,h)}catch(f){if(f.name==="AbortError")return;throw Ae(m,!1,f.message),f}}async function tt(n,e,t,s,a=null){const i=qe(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:n.title,albumArtist:"Playlist",year:new Date().getFullYear()}),r=await it(i,e.length>=20);if(!r)return;const{zip:l,fileHandle:o}=r,c=rt("playlist",n.title,e.length);try{const d=e.find(u=>u.album?.cover),h=await Me(t,d?.album?.cover);st(l,i,h),await Ft(l,e,i,t,s,a,c),await at(l,i,c,e.length,o)}catch(d){if(d.name==="AbortError")return;throw Ae(c,!1,d.message),d}}async function Ut(n,e,t,s,a=null){const i=`${ge(n.name)} discography`,r=await it(i,!0);if(!r)return;const{zip:l,fileHandle:o}=r,c=rt("discography",n.name,e.length),{abortController:d}=xe.get(c),h=d.signal;try{for(let u=0;u<e.length;u++){const m=e[u];ot(c,u,e.length,m.title);try{const{album:f,tracks:g}=await t.getAlbum(m.id),y=await Me(t,f.cover||m.cover),v=f.releaseDate||(g[0]?.streamStartDate?g[0].streamStartDate.split("T")[0]:""),I=v?new Date(v):null,p=I&&!isNaN(I.getTime())?I.getFullYear():"",b=qe(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:f.title,albumArtist:f.artist?.name,year:p}),w=`${i}/${b}`;st(l,w,y);for(const T of g){const k=je(T,s);try{const L=await Ot(T,s,t,null,h);if(l.file(`${w}/${k}`,L),a&&Ee.shouldDownloadLyrics())try{const S=await a.fetchLyrics(T.id,T);if(S){const x=a.generateLRCContent(S,T);if(x){const P=k.replace(/\.[^.]+$/,".lrc");l.file(`${w}/${P}`,x)}}}catch{}}catch(L){if(L.name==="AbortError")throw L;console.error(`Failed to download track ${T.title}:`,L)}}}catch(f){if(f.name==="AbortError")throw f;console.error(`Failed to download album ${m.title}:`,f)}}await at(l,i,c,e.length,o)}catch(u){if(u.name==="AbortError")return;throw Ae(c,!1,u.message),u}}function rt(n,e,t){const s=nt(),a=document.createElement("div");a.className="download-task bulk-download",a.dataset.bulkType=n,a.dataset.bulkName=e;const i=n==="album"?"Album":n==="playlist"?"Playlist":"Discography";a.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">
                    Downloading ${i}
                </div>
                <div style="font-size: 0.85rem; color: var(--muted-foreground); margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${Ce}
            </button>
        </div>
    `,s.appendChild(a);const r=new AbortController;return xe.set(a,{abortController:r}),a.querySelector(".download-cancel").addEventListener("click",()=>{r.abort(),Vs(a)}),a}function ot(n,e,t,s){const a=n.querySelector(".download-progress-fill"),i=n.querySelector(".download-status"),r=t>0?Math.round(e/t*100):0;a.style.width=`${r}%`,i.textContent=`${e}/${t} - ${s}`}function Ae(n,e=!0,t=null){const s=n.querySelector(".download-progress-fill"),a=n.querySelector(".download-status");e?(s.style.width="100%",s.style.background="#10b981",a.textContent="✓ Download complete",a.style.color="#10b981",setTimeout(()=>{n.style.animation="slideOut 0.3s ease",setTimeout(()=>n.remove(),300)},3e3)):(s.style.background="#ef4444",a.textContent=t||"✗ Download failed",a.style.color="#ef4444",setTimeout(()=>{n.style.animation="slideOut 0.3s ease",setTimeout(()=>n.remove(),300)},5e3))}async function jt(n,e,t,s=null,a=null){if(!n){alert("No track is currently playing");return}const i=je(n,e),r=a||new AbortController;try{const{taskEl:l}=Dt(n.id,n,i,t,r);if(await t.downloadTrack(n.id,e,i,{signal:r.signal,track:n,onProgress:o=>{Ht(n.id,o)}}),et(n.id,!0),s&&Ee.shouldDownloadLyrics())try{const o=await s.fetchLyrics(n.id,n);o&&s.downloadLRC(o,n)}catch{console.log("Could not download lyrics for track")}}catch(l){if(l.name!=="AbortError"){const o=l.message===Tt?l.message:"Download failed. Please try again.";et(n.id,!1,o)}}}const He=Object.freeze(Object.defineProperty({__proto__:null,addDownloadTask:Dt,completeDownloadTask:et,downloadAlbumAsZip:Nt,downloadDiscography:Ut,downloadPlaylistAsZip:tt,downloadTrackWithMetadata:jt,showNotification:Y,updateDownloadProgress:Ht},Symbol.toStringTag,{value:"Module"}));class Ys{constructor(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.cache=new Map}async getWaveform(e,t){if(this.cache.has(t))return this.cache.get(t);try{const a=await(await fetch(e)).arrayBuffer(),i=await this.audioContext.decodeAudioData(a),l={peaks:this.extractPeaks(i),duration:i.duration};return this.cache.set(t,l),l}catch(s){return console.error("Waveform generation failed:",s),null}}extractPeaks(e){const{length:t,duration:s}=e,a=Math.min(Math.floor(4*s),1e3),i=new Float32Array(a),r=e.getChannelData(0),l=Math.floor(t/a),o=8;for(let d=0;d<a;d++){let h=0;const u=d*l,m=u+l;for(let f=u;f<m;f+=o){const g=r[f];g>h?h=g:-g>h&&(h=-g)}i[d]=h}let c=0;for(let d=0;d<a;d++)i[d]>c&&(c=i[d]);if(c>0)for(let d=0;d<a;d++)i[d]/=c;return i}drawWaveform(e,t){if(!e||!t)return;const s=e.getContext("2d"),a=e.width,i=e.height;s.clearRect(0,0,a,i);const r=a/t.length,l=i/2;s.fillStyle="#000",s.beginPath(),s.moveTo(0,l);for(let o=0;o<t.length;o++){const c=t[o],d=Math.max(1.5,c*i*.9);s.lineTo(o*r,l-d/2)}for(let o=t.length-1;o>=0;o--){const c=t[o],d=Math.max(1.5,c*i*.9);s.lineTo(o*r,l+d/2)}s.closePath(),s.fill()}}const Oe=new Ys;let Fe=null;function Js(n,e,t,s){const a=document.querySelector(".play-pause-btn"),i=document.getElementById("next-btn"),r=document.getElementById("prev-btn"),l=document.getElementById("shuffle-btn"),o=document.getElementById("repeat-btn"),c=document.getElementById("sleep-timer-btn-desktop"),d=document.getElementById("sleep-timer-btn");let h=null;n.shuffleActive&&l.classList.add("active"),n.repeatMode!==V.OFF?(o.classList.add("active"),n.repeatMode===V.ONE&&o.classList.add("repeat-one"),o.title=n.repeatMode===V.ALL?"Repeat Queue":"Repeat One"):o.title="Repeat",e.addEventListener("play",()=>{n.currentTrack&&(t.isAuthenticated()&&oe.isEnabled()&&t.updateNowPlaying(n.currentTrack),Oe.audioContext.state==="suspended"&&Oe.audioContext.resume(),g()),a.innerHTML=ts,n.updateMediaSessionPlaybackState(),n.updateMediaSessionPositionState(),Rt(n)}),e.addEventListener("playing",()=>{n.updateMediaSessionPlaybackState(),n.updateMediaSessionPositionState()}),e.addEventListener("pause",()=>{a.innerHTML=de,n.updateMediaSessionPlaybackState(),n.updateMediaSessionPositionState()}),e.addEventListener("ended",()=>{n.playNext()}),e.addEventListener("timeupdate",async()=>{const{currentTime:p,duration:b}=e;if(b){const w=document.getElementById("progress-fill"),T=document.getElementById("current-time");if(w.style.width=`${p/b*100}%`,T.textContent=Te(p),p>=10&&n.currentTrack&&n.currentTrack.id!==h){h=n.currentTrack.id;const k=await C.addToHistory(n.currentTrack);N.syncHistoryItem(k),window.location.hash==="#recent"&&s.renderRecentPage()}}}),e.addEventListener("loadedmetadata",()=>{const p=document.getElementById("total-duration");p.textContent=Te(e.duration),n.updateMediaSessionPositionState()}),e.addEventListener("error",p=>{console.error("Audio playback error:",p),document.querySelector(".now-playing-bar .artist").textContent="Playback error. Try another track.",a.innerHTML=de}),a.addEventListener("click",()=>n.handlePlayPause()),i.addEventListener("click",()=>n.playNext()),r.addEventListener("click",()=>n.playPrev()),l.addEventListener("click",()=>{n.toggleShuffle(),l.classList.toggle("active",n.shuffleActive),window.renderQueueFunction&&window.renderQueueFunction()}),o.addEventListener("click",()=>{const p=n.toggleRepeat();o.classList.toggle("active",p!==V.OFF),o.classList.toggle("repeat-one",p===V.ONE),o.title=p===V.OFF?"Repeat":p===V.ALL?"Repeat Queue":"Repeat One"}),c&&c.addEventListener("click",()=>{n.isSleepTimerActive()?(n.clearSleepTimer(),Y("Sleep timer cancelled")):yt(n)}),d&&d.addEventListener("click",()=>{n.isSleepTimerActive()?(n.clearSleepTimer(),Y("Sleep timer cancelled")):yt(n)});const u=document.getElementById("volume-bar"),m=document.getElementById("volume-fill"),f=document.getElementById("volume-btn"),g=async()=>{const p=document.getElementById("progress-bar"),b=document.querySelector(".player-controls");if(!Xe.isEnabled()||!n.currentTrack){p&&(p.style.webkitMaskImage="",p.style.maskImage="",p.classList.remove("has-waveform","waveform-loaded")),b&&b.classList.remove("waveform-loaded"),Fe=null;return}if(p&&Fe!==n.currentTrack.id){Fe=n.currentTrack.id,p.classList.add("has-waveform"),p.classList.remove("waveform-loaded"),b&&b.classList.remove("waveform-loaded"),p.style.webkitMaskImage="",p.style.maskImage="";try{const w=await n.api.getStreamUrl(n.currentTrack.id,"LOW"),T=await Oe.getWaveform(w,n.currentTrack.id);if(T&&Fe===n.currentTrack.id){let{peaks:k,duration:L}=T;const S=n.currentTrack.duration;if(S&&L&&L<S){const $=S-L;if($>.5){const _=k.length/L,B=Math.floor($*_);if(B>0){const D=new Float32Array(k.length+B);D.set(k,B),k=D}}}const x=document.createElement("canvas"),P=p.getBoundingClientRect();x.width=P.width||500,x.height=28,Oe.drawWaveform(x,k);const A=x.toDataURL();p.style.webkitMaskImage=`url(${A})`,p.style.webkitMaskSize="100% 100%",p.style.webkitMaskRepeat="no-repeat",p.style.maskImage=`url(${A})`,p.style.maskSize="100% 100%",p.style.maskRepeat="no-repeat",p.classList.add("waveform-loaded"),b&&b.classList.add("waveform-loaded")}}catch(w){console.error("Failed to load waveform mask:",w)}}};window.addEventListener("waveform-toggle",p=>{if(!p.detail.enabled){const b=document.getElementById("progress-bar"),w=document.querySelector(".player-controls");b&&(b.style.webkitMaskImage="",b.style.maskImage="",b.classList.remove("has-waveform","waveform-loaded")),w&&w.classList.remove("waveform-loaded")}g()});const y=()=>{const{muted:p}=e,b=n.userVolume;f.innerHTML=p||b===0?ns:ss;const w=p?0:b*100;m.style.setProperty("--volume-level",`${w}%`),m.style.width=`${w}%`};f.addEventListener("click",()=>{e.muted=!e.muted,localStorage.setItem("muted",e.muted)}),e.addEventListener("volumechange",y);const v=parseFloat(localStorage.getItem("volume")||"0.7"),I=localStorage.getItem("muted")==="true";n.setVolume(v),e.muted=I,m.style.width=`${v*100}%`,u.style.setProperty("--volume-level",`${v*100}%`),y(),Xs(e,n)}function Xs(n,e){const t=document.getElementById("progress-bar"),s=document.getElementById("progress-fill"),a=document.getElementById("volume-bar"),i=document.getElementById("volume-fill"),r=document.getElementById("volume-btn");let l=!1,o=!1,c=!1;const d=(h,u,m)=>{const f=h.getBoundingClientRect(),g=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));m(g)};t.addEventListener("mousedown",h=>{l=!0,o=!n.paused,o&&n.pause(),d(t,h,u=>{isNaN(n.duration)||(n.currentTime=u*n.duration,s.style.width=`${u*100}%`)})}),t.addEventListener("touchstart",h=>{h.preventDefault(),l=!0,o=!n.paused,o&&n.pause();const u=h.touches[0],m=t.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));isNaN(n.duration)||(n.currentTime=f*n.duration,s.style.width=`${f*100}%`)}),document.addEventListener("mousemove",h=>{l&&d(t,h,u=>{isNaN(n.duration)||(n.currentTime=u*n.duration,s.style.width=`${u*100}%`)}),c&&d(a,h,u=>{e.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),document.addEventListener("touchmove",h=>{if(l){const u=h.touches[0],m=t.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));isNaN(n.duration)||(n.currentTime=f*n.duration,s.style.width=`${f*100}%`)}if(c){const u=h.touches[0],m=a.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));e.setVolume(f),i.style.width=`${f*100}%`,a.style.setProperty("--volume-level",`${f*100}%`)}}),document.addEventListener("mouseup",h=>{l&&(d(t,h,u=>{isNaN(n.duration)||(n.currentTime=u*n.duration,e.updateMediaSessionPositionState(),o&&n.play())}),l=!1),c&&(c=!1)}),document.addEventListener("touchend",h=>{l&&(isNaN(n.duration)||(e.updateMediaSessionPositionState(),o&&n.play()),l=!1),c&&(c=!1)}),t.addEventListener("click",h=>{l||d(t,h,u=>{if(!isNaN(n.duration)&&n.duration>0&&n.duration!==1/0)n.currentTime=u*n.duration,e.updateMediaSessionPositionState();else if(e.currentTrack&&e.currentTrack.duration){const m=u*e.currentTrack.duration,f=document.querySelector(".progress-fill");f&&(f.style.width=`${u*100}%`),e.playTrackFromQueue(m)}})}),a.addEventListener("mousedown",h=>{c=!0,d(a,h,u=>{e.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),a.addEventListener("touchstart",h=>{h.preventDefault(),c=!0;const u=h.touches[0],m=a.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));e.setVolume(f),i.style.width=`${f*100}%`,a.style.setProperty("--volume-level",`${f*100}%`)}),a.addEventListener("click",h=>{c||d(a,h,u=>{e.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),a.addEventListener("wheel",h=>{h.preventDefault();const u=h.deltaY>0?-.05:.05,m=Math.max(0,Math.min(1,e.userVolume+u));u>0&&n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(m),i.style.width=`${m*100}%`,a.style.setProperty("--volume-level",`${m*100}%`)},{passive:!1}),r?.addEventListener("wheel",h=>{h.preventDefault();const u=h.deltaY>0?-.05:.05,m=Math.max(0,Math.min(1,e.userVolume+u));u>0&&n.muted&&(n.muted=!1,localStorage.setItem("muted",!1)),e.setVolume(m),i.style.width=`${m*100}%`,a.style.setProperty("--volume-level",`${m*100}%`)},{passive:!1})}async function ce(n,e,t,s,a,i="track",r=null,l=null){if(e){if(n==="add-to-queue")t.addToQueue(e),window.renderQueueFunction&&window.renderQueueFunction(),Y(`Added to queue: ${e.title}`);else if(n==="play-next")t.addNextToQueue(e),window.renderQueueFunction&&window.renderQueueFunction(),Y(`Playing next: ${e.title}`);else if(n==="track-mix")e.mixes&&e.mixes.TRACK_MIX&&(window.location.hash=`#mix/${e.mixes.TRACK_MIX}`);else if(n==="play-card")try{let o=[];if(i==="album")o=(await s.getAlbum(e.id)).tracks;else if(i==="playlist")o=(await s.getPlaylist(e.uuid)).tracks;else if(i==="user-playlist"){let c=await C.getPlaylist(e.id);if(!c)try{c=await N.getPublicPlaylist(e.id)}catch{}o=c?c.tracks:e.tracks||[]}if(o.length>0){t.setQueue(o,0);const c=document.getElementById("shuffle-btn");c&&c.classList.remove("active"),t.playAtIndex(0);const d=i==="user-playlist"?e.name:e.title;Y(`Playing ${i.replace("user-","")}: ${d}`)}else Y(`No tracks found in this ${i}`)}catch(o){console.error("Failed to play card:",o),Y(`Failed to play ${i}`)}else if(n==="download")await jt(e,ue.getQuality(),s,a);else if(n==="toggle-like"){const o=await C.toggleFavorite(i,e);N.syncLibraryItem(i,e,o),o&&i==="track"&&l&&oe.isEnabled()&&oe.shouldLoveOnLike()&&l.loveTrack(e);const c=i==="playlist"?e.uuid:e.id,d=i==="track"?`[data-track-id="${c}"] .like-btn`:`.card[data-${i}-id="${c}"] .like-btn, .card[data-playlist-id="${c}"] .like-btn`,h=document.getElementById(`like-${i}-btn`),u=[...document.querySelectorAll(d)];h&&u.push(h);const m=document.getElementById("now-playing-like-btn");if(m&&i==="track"&&t?.currentTrack?.id===e.id&&u.push(m),u.forEach(f=>{const g=f.querySelector("svg");g&&(g.classList.toggle("filled",o),g.hasAttribute("fill")&&g.setAttribute("fill",o?"currentColor":"none")),f.classList.toggle("active",o),f.title=o?"Remove from Favorites":"Add to Favorites"}),window.location.hash==="#library"){const f=i==="track"?`.track-item[data-track-id="${c}"]`:`.card[data-${i}-id="${c}"], .card[data-playlist-id="${c}"]`,g=document.querySelector(f);if(!o&&g){const y=g.parentElement;if(g.remove(),y&&y.children.length===0){const v=i==="track"?"No liked tracks yet.":`No liked ${i}s yet.`;y.innerHTML=`<div class="placeholder-text">${v}</div>`}}else if(o&&!g&&r&&i==="track"){const y=document.getElementById("library-tracks-container");if(y){const v=y.querySelector(".placeholder-text");v&&v.remove();const I=y.children.length,p=r.createTrackItemHTML(e,I,!0,!1),b=document.createElement("div");b.innerHTML=p;const w=b.firstElementChild;w&&(y.appendChild(w),O.set(w,e),r.updateLikeState(w,"track",e.id))}}}}else if(n==="add-to-playlist"){const o=await C.getPlaylists();if(o.length===0){Y("No playlists yet. Create one first.");return}const c=document.getElementById("playlist-select-modal"),d=document.getElementById("playlist-select-list"),h=document.getElementById("playlist-select-cancel"),u=c.querySelector(".modal-overlay"),m=e.id,f=new Set;for(const p of o)p.tracks&&p.tracks.some(b=>b.id===m)&&f.add(p.id);const g='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';d.innerHTML=o.map(p=>{const b=f.has(p.id);return`
                <div class="modal-option ${b?"already-contains":""}" data-id="${p.id}">
                    <span>${p.name}</span>
                    ${b?`<span class="checkmark">${g}</span>`:""}
                </div>
            `}).join("");const y=()=>{c.classList.remove("active"),I()},v=async p=>{const b=p.target.closest(".modal-option");if(b){const w=b.dataset.id;if(f.has(w))return;await C.addTrackToPlaylist(w,e);const k=await C.getPlaylist(w);N.syncUserPlaylist(k,"update"),Y(`Added to playlist: ${b.querySelector("span").textContent}`),y()}},I=()=>{h.removeEventListener("click",y),u.removeEventListener("click",y),d.removeEventListener("click",v)};h.addEventListener("click",y),u.addEventListener("click",y),d.addEventListener("click",v),c.classList.add("active")}}}async function pt(n,e){if(!n||!e)return;const t=n.querySelector('li[data-action="toggle-like"]');if(t){const{db:a}=await Q(async()=>{const{db:r}=await Promise.resolve().then(()=>pe);return{db:r}},void 0,import.meta.url),i=await a.isFavorite("track",e.id);t.textContent=i?"Unlike":"Like"}const s=n.querySelector('li[data-action="track-mix"]');if(s){const a=e.mixes&&e.mixes.TRACK_MIX;s.style.display=a?"block":"none"}}function Zs(n,e,t,s,a,i,r){let l=null;t.addEventListener("click",async u=>{const m=u.target.closest(".track-action-btn, .like-btn, .play-btn");if(m&&m.dataset.action){u.preventDefault(),u.stopPropagation();const v=m.closest(".track-item, .card"),I=m.dataset.action,p=m.dataset.type||"track";let b=v?O.get(v):null;if(!b&&I==="toggle-like"){const w=window.location.hash.split("/")[1];if(w)try{p==="album"?b=(await e.getAlbum(w)).album:p==="artist"?b=await e.getArtist(w):p==="playlist"?b=(await e.getPlaylist(w)).playlist:p==="mix"&&(b=(await e.getMix(w)).mix)}catch(T){console.error(T)}}b&&await ce(I,b,n,e,a,p,i,r);return}const f=u.target.closest(".track-menu-btn");if(f){u.stopPropagation();const v=f.closest(".track-item");if(v&&!v.dataset.queueIndex){const I=O.get(v);if(s.style.display==="block"&&l&&I&&l.id===I.id){s.style.display="none";return}if(l=I,l){await pt(s,l);const p=f.getBoundingClientRect();bt(s,p.left,p.bottom+5,p)}}return}const g=u.target.closest(".track-item");if(g&&!g.dataset.queueIndex&&!u.target.closest(".remove-from-playlist-btn")){const v=g.closest(".track-list"),p=Array.from(v.querySelectorAll(".track-item")).map(b=>O.get(b)).filter(Boolean);if(p.length>0){const b=g.dataset.trackId,w=p.findIndex(T=>T.id==b);n.setQueue(p,w),document.getElementById("shuffle-btn").classList.remove("active"),n.playTrackFromQueue()}}const y=u.target.closest(".card");if(y){if(u.target.closest(".edit-playlist-btn")||u.target.closest(".delete-playlist-btn"))return;const v=y.dataset.href;if(v){if(u.target.closest("a"))return;u.preventDefault(),window.location.hash=v}}}),t.addEventListener("contextmenu",async u=>{const m=u.target.closest(".track-item, .queue-track-item");if(m){if(u.preventDefault(),m.classList.contains("queue-track-item")){const f=parseInt(m.dataset.queueIndex);l=n.getCurrentQueue()[f]}else l=O.get(m);l&&(await pt(s,l),bt(s,u.pageX,u.pageY))}}),document.addEventListener("click",()=>{s.style.display="none"}),s.addEventListener("click",async u=>{u.stopPropagation();const m=u.target.dataset.action,f=s._contextTrack||l;m&&f&&await ce(m,f,n,e,a,"track",i,r),s.style.display="none"}),document.querySelector(".now-playing-bar .title").addEventListener("click",()=>{const u=n.currentTrack;u?.album?.id&&(window.location.hash=`#album/${u.album.id}`)}),document.querySelector(".now-playing-bar .artist").addEventListener("click",u=>{const m=u.target.closest(".artist-link");if(m){u.stopPropagation();const g=m.dataset.artistId;g&&(window.location.hash=`#artist/${g}`);return}const f=n.currentTrack;f?.artist?.id&&(window.location.hash=`#artist/${f.artist.id}`)});const o=document.getElementById("now-playing-like-btn");o&&o.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await ce("toggle-like",n.currentTrack,n,e,a,"track",i,r)});const c=document.getElementById("now-playing-mix-btn");c&&c.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await ce("track-mix",n.currentTrack,n,e,a,"track",i,r)});const d=document.getElementById("now-playing-add-playlist-btn");d&&d.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await ce("add-to-playlist",n.currentTrack,n,e,a,"track",i,r)});const h=document.getElementById("mobile-add-playlist-btn");h&&h.addEventListener("click",async u=>{u.stopPropagation(),n.currentTrack&&await ce("add-to-playlist",n.currentTrack,n,e,a,"track",i,r)})}function yt(n){const e=document.getElementById("sleep-timer-modal");if(!e)return;const t=()=>{e.classList.remove("active"),i()},s=r=>{const l=r.target.closest(".timer-option");if(l){let o;if(l.id==="custom-timer-btn"){const c=document.getElementById("custom-minutes");if(o=parseInt(c.value),!o||o<1){Y("Please enter a valid number of minutes");return}}else o=parseInt(l.dataset.minutes);o&&(n.setSleepTimer(o),Y(`Sleep timer set for ${o} minute${o===1?"":"s"}`),t())}},a=r=>{(r.target.id==="cancel-sleep-timer"||r.target.classList.contains("modal-overlay"))&&t()},i=()=>{e.removeEventListener("click",s),e.removeEventListener("click",a)};e.addEventListener("click",s),e.addEventListener("click",a),e.classList.add("active")}function bt(n,e,t,s=null){n.style.visibility="hidden",n.style.display="block";const a=n.offsetWidth,i=n.offsetHeight,r=window.innerWidth,l=window.innerHeight;let o=e,c=t;s?(o+a>r-10&&(o=s.right-a,o<10&&(o=10)),c+i>l-10&&(c=s.top-i-5)):(o+a>r-10&&(o=r-a-10),c+i>l-10&&(c=t-i)),n.style.top=`${c}px`,n.style.left=`${o}px`,n.style.visibility="visible"}function en(n,e){const t=document.querySelector(".sidebar"),s=document.getElementById("sidebar-overlay"),a=document.getElementById("hamburger-btn"),i=document.getElementById("queue-btn");let r=null;a.addEventListener("click",()=>{t.classList.add("is-open"),s.classList.add("is-visible")});const l=()=>{t.classList.remove("is-open"),s.classList.remove("is-visible")};s.addEventListener("click",l),t.addEventListener("click",u=>{u.target.closest("a")&&l()});const o=u=>{const m=n.getCurrentQueue(),f=m.length>0;u.innerHTML=`
            <button id="download-queue-btn" class="btn-icon" title="Download Queue" style="display: ${f?"flex":"none"}">
                ${fe}
            </button>
            <button id="like-queue-btn" class="btn-icon" title="Add Queue to Liked" style="display: ${f?"flex":"none"}">
                ${ie}
            </button>
            <button id="add-queue-to-playlist-btn" class="btn-icon" title="Add Queue to Playlist" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            <button id="clear-queue-btn" class="btn-icon" title="Clear Queue" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${Ce}
            </button>
        `,u.querySelector("#close-side-panel-btn").addEventListener("click",()=>{U.close()});const g=u.querySelector("#download-queue-btn");g&&g.addEventListener("click",async()=>{const{downloadTracks:p}=await Q(async()=>{const{downloadTracks:b}=await Promise.resolve().then(()=>He);return{downloadTracks:b}},void 0,import.meta.url);p(m)});const y=u.querySelector("#like-queue-btn");y&&y.addEventListener("click",async()=>{const{db:p}=await Q(async()=>{const{db:k}=await Promise.resolve().then(()=>pe);return{db:k}},void 0,import.meta.url),{syncManager:b}=await Q(async()=>{const{syncManager:k}=await Promise.resolve().then(()=>Ve);return{syncManager:k}},void 0,import.meta.url),{showNotification:w}=await Q(async()=>{const{showNotification:k}=await Promise.resolve().then(()=>He);return{showNotification:k}},void 0,import.meta.url);let T=0;for(const k of m)await p.toggleFavorite("track",k)&&(b.syncLibraryItem("track",k,!0),T++);T>0?w(`Added ${T} track${T>1?"s":""} to Liked`):w("All tracks in queue are already liked"),d()});const v=u.querySelector("#add-queue-to-playlist-btn");v&&v.addEventListener("click",async()=>{const{db:p}=await Q(async()=>{const{db:S}=await Promise.resolve().then(()=>pe);return{db:S}},void 0,import.meta.url),{syncManager:b}=await Q(async()=>{const{syncManager:S}=await Promise.resolve().then(()=>Ve);return{syncManager:S}},void 0,import.meta.url),{showNotification:w}=await Q(async()=>{const{showNotification:S}=await Promise.resolve().then(()=>He);return{showNotification:S}},void 0,import.meta.url),T=await p.getPlaylists();if(T.length===0){w("No playlists yet. Create one first.");return}const k=document.createElement("div");k.className="modal active",k.innerHTML=`
                    <div class="modal-overlay"></div>
                    <div class="modal-content">
                        <h3>Add Queue to Playlist</h3>
                        <div class="modal-list">
                            ${T.map(S=>`
                                <div class="modal-option" data-id="${S.id}">${W(S.name)}</div>
                            `).join("")}
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary cancel-btn">Cancel</button>
                        </div>
                    </div>
                `,document.body.appendChild(k);const L=()=>{k.remove()};k.addEventListener("click",async S=>{if(S.target.classList.contains("modal-overlay")||S.target.classList.contains("cancel-btn")){L();return}const x=S.target.closest(".modal-option");if(x){const P=x.dataset.id,A=x.textContent;try{let $=0;for(const B of m){const D=await p.addTrackToPlaylist(P,B);$++}const _=await p.getPlaylist(P);b.syncUserPlaylist(_,"update"),w(`Added ${$} tracks to playlist: ${A}`)}catch($){console.error("Failed to add tracks to playlist:",$),w("Failed to add tracks to playlist")}L()}})});const I=u.querySelector("#clear-queue-btn");I&&I.addEventListener("click",()=>{n.clearQueue(),d()})},c=u=>{const m=n.getCurrentQueue();if(m.length===0){u.innerHTML='<div class="placeholder-text">Queue is empty.</div>';return}const f=m.map((g,y)=>{const v=y===n.currentQueueIndex,I=te(g),p=ee(g,{fallback:"Unknown"});return`
                <div class="queue-track-item ${v?"playing":""}" data-queue-index="${y}" data-track-id="${g.id}" draggable="true">
                    <div class="drag-handle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="8" x2="19" y2="8"></line>
                            <line x1="5" y1="16" x2="19" y2="16"></line>
                        </svg>
                    </div>
                    <div class="track-item-info">
                        <img src="${e.getCoverUrl(g.album?.cover)}"
                             class="track-item-cover" loading="lazy">
                        <div class="track-item-details">
                            <div class="title">${W(I)}</div>
                            <div class="artist">${W(p)}</div>
                        </div>
                    </div>
                    <div class="track-item-duration">${Te(g.duration)}</div>
                    <button class="queue-like-btn" data-action="toggle-like" title="Add to Liked">
                        ${ie}
                    </button>
                    <button class="queue-remove-btn" data-track-index="${y}" title="Remove from queue">
                        ${is}
                    </button>
                </div>
            `}).join("");u.innerHTML=f,u.querySelectorAll(".queue-track-item").forEach(async g=>{const y=parseInt(g.dataset.queueIndex),v=n.getCurrentQueue()[y],I=g.querySelector(".queue-like-btn");if(I&&v){const{db:p}=await Q(async()=>{const{db:w}=await Promise.resolve().then(()=>pe);return{db:w}},void 0,import.meta.url),b=await p.isFavorite("track",v.id);I.classList.toggle("active",b),I.innerHTML=b?ie.replace('class="heart-icon"','class="heart-icon filled"'):ie}g.addEventListener("click",async p=>{if(p.target.closest(".queue-remove-btn")){p.stopPropagation(),n.removeFromQueue(y),d();return}const w=p.target.closest(".queue-like-btn");if(w&&w.dataset.action==="toggle-like"){p.stopPropagation();const T=n.getCurrentQueue()[y];if(T){const{db:k}=await Q(async()=>{const{db:P}=await Promise.resolve().then(()=>pe);return{db:P}},void 0,import.meta.url),{syncManager:L}=await Q(async()=>{const{syncManager:P}=await Promise.resolve().then(()=>Ve);return{syncManager:P}},void 0,import.meta.url),{showNotification:S}=await Q(async()=>{const{showNotification:P}=await Promise.resolve().then(()=>He);return{showNotification:P}},void 0,import.meta.url),x=await k.toggleFavorite("track",T);L.syncLibraryItem("track",T,x),w.classList.toggle("active",x),w.innerHTML=x?ie.replace('class="heart-icon"','class="heart-icon filled"'):ie,S(x?`Added to Liked: ${T.title}`:`Removed from Liked: ${T.title}`)}return}n.playAtIndex(y),d()}),g.addEventListener("contextmenu",async p=>{p.preventDefault();const b=document.getElementById("context-menu");if(b){const w=n.getCurrentQueue()[y];if(w){const{db:T}=await Q(async()=>{const{db:_}=await Promise.resolve().then(()=>pe);return{db:_}},void 0,import.meta.url),k=await T.isFavorite("track",w.id),L=b.querySelector('li[data-action="toggle-like"]');L&&(L.textContent=k?"Unlike":"Like");const S=b.querySelector('li[data-action="track-mix"]');if(S){const _=w.mixes&&w.mixes.TRACK_MIX;S.style.display=_?"block":"none"}g.getBoundingClientRect();const x=150,P=200;let A=p.clientX,$=p.clientY;A+x>window.innerWidth&&(A=window.innerWidth-x-10),$+P>window.innerHeight&&($=p.clientY-P-10),b.style.left=`${A}px`,b.style.top=`${$}px`,b.style.display="block",b._contextTrack=w}}}),g.addEventListener("dragstart",p=>{r=y,g.style.opacity="0.5"}),g.addEventListener("dragend",()=>{g.style.opacity="1"}),g.addEventListener("dragover",p=>{p.preventDefault()}),g.addEventListener("drop",p=>{p.preventDefault(),r!==null&&r!==y&&(n.moveInQueue(r,y),d())})})},d=()=>{U.refresh("queue",o,c)},h=()=>{U.open("queue","Queue",o,c)};i.addEventListener("click",h),window.renderQueueFunction=()=>{U.isActive("queue")&&d()},document.querySelectorAll(".search-tab").forEach(u=>{u.addEventListener("click",()=>{const m=u.closest(".page");if(!m)return;m.querySelectorAll(".search-tab").forEach(y=>y.classList.remove("active")),m.querySelectorAll(".search-tab-content").forEach(y=>y.classList.remove("active")),u.classList.add("active");const g=`${m.id==="page-library"?"library-tab-":"search-tab-"}${u.dataset.tab}`;document.getElementById(g)?.classList.add("active")})})}function tn(n={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:s,onRegistered:a,onRegisteredSW:i,onRegisterError:r}=n;let l,o,c;const d=async(u=!0)=>{await o,c?.()};async function h(){if("serviceWorker"in navigator){if(l=await Q(async()=>{const{Workbox:u}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:u}},[],import.meta.url).then(({Workbox:u})=>new u("./sw.js",{scope:"./",type:"classic"})).catch(u=>{r?.(u)}),!l)return;c=()=>{l?.messageSkipWaiting()};{let u=!1;const m=()=>{u=!0,l?.addEventListener("controlling",f=>{f.isUpdate&&window.location.reload()}),t?.()};l.addEventListener("installed",f=>{typeof f.isUpdate>"u"?typeof f.isExternal<"u"&&f.isExternal?m():!u&&s?.():f.isUpdate||s?.()}),l.addEventListener("waiting",m)}l.register({immediate:e}).then(u=>{i?i("./sw.js",u):a?.(u)}).catch(u=>{r?.(u)})}}return o=h(),d}let we=null;function wt(){if(we)return;we=new Lenis({wrapper:document.querySelector(".main-content"),content:document.querySelector(".main-content"),lerp:.1,smoothWheel:!0,smoothTouch:!1,normalizeWheel:!0,wheelMultiplier:.8});function n(e){we.raf(e),requestAnimationFrame(n)}requestAnimationFrame(n)}function sn(){we&&(we.destroy(),we=null)}function vt(){Ze.isEnabled()&&wt(),window.addEventListener("smooth-scrolling-toggle",function(e){e.detail.enabled?wt():sn()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",vt):vt();function nn(n,e){e&&("remote"in n?(n.remote.watchAvailability(t=>{t&&(e.style.display="flex",e.classList.add("available"))}).catch(t=>{console.log("Remote playback not available:",t),window.innerWidth>768&&(e.style.display="flex")}),e.addEventListener("click",()=>{if(!n.src){alert("Please play a track first to enable casting.");return}n.remote.prompt().catch(t=>{if(t.name!=="NotAllowedError"){if(t.name==="NotFoundError"){alert("No remote playback devices (Chromecast/AirPlay) were found on your network.");return}console.log("Cast prompt error:",t)}})}),n.addEventListener("playing",()=>{n.remote&&n.remote.state==="connected"&&e.classList.add("connected")}),n.addEventListener("pause",()=>{n.remote&&n.remote.state==="disconnected"&&e.classList.remove("connected")})):n.webkitShowPlaybackTargetPicker?(e.style.display="flex",e.classList.add("available"),e.addEventListener("click",()=>{n.webkitShowPlaybackTargetPicker()}),n.addEventListener("webkitplaybacktargetavailabilitychanged",t=>{t.availability==="available"&&e.classList.add("available")}),n.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",()=>{n.webkitCurrentPlaybackTargetIsWireless?e.classList.add("connected"):e.classList.remove("connected")})):window.innerWidth>768&&(e.style.display="flex",e.addEventListener("click",()=>{alert("Casting is not supported in this browser. Try Chrome for Chromecast or Safari for AirPlay.")})))}function an(n,e){document.addEventListener("keydown",t=>{if(!t.target.matches("input, textarea"))switch(t.key.toLowerCase()){case" ":t.preventDefault(),n.handlePlayPause();break;case"arrowright":t.shiftKey?n.playNext():e.currentTime=Math.min(e.duration,e.currentTime+10);break;case"arrowleft":t.shiftKey?n.playPrev():e.currentTime=Math.max(0,e.currentTime-10);break;case"arrowup":t.preventDefault(),n.setVolume(n.userVolume+.1);break;case"arrowdown":t.preventDefault(),n.setVolume(n.userVolume-.1);break;case"m":e.muted=!e.muted;break;case"s":document.getElementById("shuffle-btn")?.click();break;case"r":document.getElementById("repeat-btn")?.click();break;case"q":document.getElementById("queue-btn")?.click();break;case"/":t.preventDefault(),document.getElementById("search-input")?.focus();break;case"escape":document.getElementById("search-input")?.blur(),U.close(),Se(e,U.panel);break;case"l":document.querySelector(".now-playing-bar .cover")?.click();break}})}function rn(){const n=document.createElement("div");n.className="offline-notification",n.innerHTML=`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>You are offline. Some features may not work.</span>
    `,document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>n.remove(),300)},5e3)}function on(){const n=document.querySelector(".offline-notification");n&&(n.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>n.remove(),300))}document.addEventListener("DOMContentLoaded",async()=>{const n=new xs(As),e=document.getElementById("audio-player"),t=localStorage.getItem("playback-quality")||"LOSSLESS",s=new Us(e,n,t),a=new Ns(n,s),i=new Qs,r=new Ct(n);r.loadKuroshiro().catch(p=>{console.warn("Failed to pre-load Kuroshiro:",p)});const l=re.getTheme();re.setTheme(l),Je.getMode(),Gs(i,s,n,a),Js(s,e,i,a),Zs(s,n,document.querySelector(".main-content"),document.getElementById("context-menu"),r,a,i),en(s,n),an(s,e);const o=document.getElementById("cast-btn");nn(e,o),s.currentTrack&&a.setCurrentTrack(s.currentTrack),document.querySelector(".now-playing-bar .cover").addEventListener("click",async()=>{if(!s.currentTrack){alert("No track is currently playing");return}const p=Ye.getMode();if(p==="lyrics")U.isActive("lyrics")?(U.close(),Se(e,U.panel)):Ne(s.currentTrack,e,r);else if(p==="cover"){const b=document.getElementById("fullscreen-cover-overlay");if(b&&b.style.display==="flex")a.closeFullscreenCover();else{const w=s.getNextTrack();a.showFullscreenCover(s.currentTrack,w,r,e)}}else s.currentTrack.album?.id&&(window.location.hash=`#album/${s.currentTrack.album.id}`)}),document.getElementById("playlist-public-toggle")?.addEventListener("change",p=>{const b=document.getElementById("playlist-share-btn");b&&(b.style.display=p.target.checked?"flex":"none")}),document.getElementById("close-fullscreen-cover-btn")?.addEventListener("click",()=>{a.closeFullscreenCover()}),document.getElementById("fullscreen-cover-image")?.addEventListener("click",()=>{a.closeFullscreenCover()}),document.getElementById("nav-back")?.addEventListener("click",()=>{window.history.back()}),document.getElementById("nav-forward")?.addEventListener("click",()=>{window.history.forward()}),document.getElementById("toggle-lyrics-btn")?.addEventListener("click",async p=>{if(p.stopPropagation(),!s.currentTrack){alert("No track is currently playing");return}U.isActive("lyrics")?(U.close(),Se(e,U.panel)):Ne(s.currentTrack,e,r)}),document.getElementById("download-current-btn")?.addEventListener("click",()=>{s.currentTrack&&ce("download",s.currentTrack,s,n,r,"track",a)});let c=null;e.addEventListener("play",async()=>{if(!s.currentTrack)return;a.setCurrentTrack(s.currentTrack);const p=s.currentTrack.id;if(p===c)return;c=p,U.isActive("lyrics")&&Ne(s.currentTrack,e,r);const b=document.getElementById("fullscreen-cover-overlay");if(b&&getComputedStyle(b).display!=="none"){const w=s.getNextTrack();a.showFullscreenCover(s.currentTrack,w,r,e)}}),document.addEventListener("click",async p=>{if(p.target.closest("#play-album-btn")){if(p.target.closest("#play-album-btn").disabled)return;const w=window.location.hash.split("/")[1];if(!w)return;try{const{tracks:T}=await n.getAlbum(w);T.length>0&&(s.setQueue(T,0),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue())}catch(T){console.error("Failed to play album:",T),alert("Failed to play album: "+T.message)}}if(p.target.closest("#download-mix-btn")){const b=p.target.closest("#download-mix-btn");if(b.disabled)return;const w=window.location.hash.split("#mix/")[1];if(!w)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{mix:k,tracks:L}=await n.getMix(w);await tt(k,L,n,ue.getQuality(),r)}catch(k){console.error("Mix download failed:",k),alert("Failed to download mix: "+k.message)}finally{b.disabled=!1,b.innerHTML=T}}if(p.target.closest("#download-playlist-btn")){const b=p.target.closest("#download-playlist-btn");if(b.disabled)return;const w=window.location.hash.split("/")[1];if(!w)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{let k,L,S=await C.getPlaylist(w);if(!S)try{S=await N.getPublicPlaylist(w)}catch{}if(S)k={...S,title:S.name||S.title},L=S.tracks||[];else{const x=await n.getPlaylist(w);k=x.playlist,L=x.tracks}await tt(k,L,n,ue.getQuality(),r)}catch(k){console.error("Playlist download failed:",k),alert("Failed to download playlist: "+k.message)}finally{b.disabled=!1,b.innerHTML=T}}if(p.target.closest("#create-playlist-btn")){const b=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Create Playlist",document.getElementById("playlist-name-input").value="",document.getElementById("playlist-cover-input").value="",b.dataset.editingId="",document.getElementById("csv-import-section").style.display="block",document.getElementById("csv-file-input").value="";const w=document.getElementById("playlist-public-toggle"),T=document.getElementById("playlist-share-btn");w&&(w.checked=!1),T&&(T.style.display="none"),b.classList.add("active"),document.getElementById("playlist-name-input").focus()}if(p.target.closest("#playlist-modal-save")){const b=document.getElementById("playlist-name-input").value.trim(),w=document.getElementById("playlist-public-toggle")?.checked;if(b){const T=document.getElementById("playlist-modal"),k=T.dataset.editingId,L=async S=>{if(S.isPublic=w,w)try{await N.publishPlaylist(S)}catch(x){console.error("Failed to publish playlist:",x),alert("Failed to publish playlist. Please ensure you are logged in.")}else try{await N.unpublishPlaylist(S.id)}catch{}return S};if(k){const S=document.getElementById("playlist-cover-input").value.trim();C.getPlaylist(k).then(async x=>{x&&(x.name=b,x.cover=S,await L(x),await C.performTransaction("user_playlists","readwrite",P=>P.put(x)),N.syncUserPlaylist(x,"update"),a.renderLibraryPage(),window.location.hash===`#userplaylist/${k}`&&a.renderPlaylistPage(k,"user"),T.classList.remove("active"),delete T.dataset.editingId)})}else{const S=document.getElementById("csv-file-input");let x=[];if(S.files.length>0){const A=S.files[0],$=document.getElementById("csv-import-progress"),_=document.getElementById("csv-progress-fill"),B=document.getElementById("csv-progress-current"),D=document.getElementById("csv-progress-total"),j=$.querySelector(".current-track"),J=$.querySelector(".current-artist");try{$.style.display="block",_.style.width="0%",B.textContent="0",j.textContent="Reading CSV file...",J&&(J.textContent="");const G=await A.text(),se=G.trim().split(`
`),q=Math.max(0,se.length-1);D.textContent=q.toString();const E=await un(G,n,R=>{const H=q>0?R.current/q*100:0;_.style.width=`${Math.min(H,100)}%`,B.textContent=R.current.toString(),j.textContent=R.currentTrack,J&&(J.textContent=R.currentArtist||"")});x=E.tracks;const M=E.missingTracks;if(x.length===0){alert("No valid tracks found in the CSV file! Please check the format."),$.style.display="none";return}console.log(`Imported ${x.length} tracks from CSV`),M.length>0&&setTimeout(()=>{dn(M)},500)}catch(G){console.error("Failed to parse CSV!",G),alert("Failed to parse CSV file! "+G.message),$.style.display="none";return}finally{setTimeout(()=>{$.style.display="none"},1e3)}}const P=document.getElementById("playlist-cover-input").value.trim();C.createPlaylist(b,x,P).then(async A=>{await L(A),await C.performTransaction("user_playlists","readwrite",$=>$.put(A)),N.syncUserPlaylist(A,"create"),a.renderLibraryPage(),T.classList.remove("active")})}}}if(p.target.closest("#playlist-modal-cancel")&&document.getElementById("playlist-modal").classList.remove("active"),p.target.closest(".edit-playlist-btn")){const w=p.target.closest(".user-playlist").dataset.userPlaylistId;C.getPlaylist(w).then(async T=>{if(T){const k=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=T.name,document.getElementById("playlist-cover-input").value=T.cover||"";const L=document.getElementById("playlist-public-toggle"),S=document.getElementById("playlist-share-btn");L&&(L.checked=!!T.isPublic),S&&(S.style.display=T.isPublic?"flex":"none",S.onclick=()=>{const x=`${window.location.origin}${window.location.pathname}#userplaylist/${T.id}`;navigator.clipboard.writeText(x).then(()=>alert("Link copied to clipboard!"))}),k.dataset.editingId=w,document.getElementById("csv-import-section").style.display="none",k.classList.add("active"),document.getElementById("playlist-name-input").focus()}})}if(p.target.closest(".delete-playlist-btn")){const w=p.target.closest(".user-playlist").dataset.userPlaylistId;confirm("Are you sure you want to delete this playlist?")&&C.deletePlaylist(w).then(()=>{N.syncUserPlaylist({id:w},"delete"),a.renderLibraryPage()})}if(p.target.closest("#edit-playlist-btn")){const b=window.location.hash.split("/")[1];C.getPlaylist(b).then(w=>{if(w){const T=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=w.name,document.getElementById("playlist-cover-input").value=w.cover||"";const k=document.getElementById("playlist-public-toggle"),L=document.getElementById("playlist-share-btn");k&&(k.checked=!!w.isPublic),L&&(L.style.display=w.isPublic?"flex":"none",L.onclick=()=>{const S=`${window.location.origin}${window.location.pathname}#userplaylist/${w.id}`;navigator.clipboard.writeText(S).then(()=>alert("Link copied to clipboard!"))}),T.dataset.editingId=b,document.getElementById("csv-import-section").style.display="none",T.classList.add("active"),document.getElementById("playlist-name-input").focus()}})}if(p.target.closest("#delete-playlist-btn")){const b=window.location.hash.split("/")[1];confirm("Are you sure you want to delete this playlist?")&&C.deletePlaylist(b).then(()=>{N.syncUserPlaylist({id:b},"delete"),window.location.hash="#library"})}if(p.target.closest(".remove-from-playlist-btn")){p.stopPropagation();const b=p.target.closest(".remove-from-playlist-btn"),w=parseInt(b.dataset.trackIndex),T=window.location.hash.split("/")[1];C.getPlaylist(T).then(async k=>{if(k&&k.tracks[w]){const L=k.tracks[w].id,S=await C.removeTrackFromPlaylist(T,L);N.syncUserPlaylist(S,"update"),a.renderPlaylistPage(T,"user")}})}if(p.target.closest("#play-playlist-btn")){if(p.target.closest("#play-playlist-btn").disabled)return;const w=window.location.hash.split("/")[1];if(!w)return;try{let T;const k=await C.getPlaylist(w);if(k)T=k.tracks;else try{const{tracks:L}=await n.getPlaylist(w);T=L}catch(L){const S=await N.getPublicPlaylist(w);if(S)T=S.tracks;else throw L}T.length>0&&(s.setQueue(T,0),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue())}catch(T){console.error("Failed to play playlist:",T),alert("Failed to play playlist: "+T.message)}}if(p.target.closest("#download-album-btn")){const b=p.target.closest("#download-album-btn");if(b.disabled)return;const w=window.location.hash.split("/")[1];if(!w)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{album:k,tracks:L}=await n.getAlbum(w);await Nt(k,L,n,ue.getQuality(),r)}catch(k){console.error("Album download failed:",k),alert("Failed to download album: "+k.message)}finally{b.disabled=!1,b.innerHTML=T}}if(p.target.closest("#play-artist-radio-btn")){const b=p.target.closest("#play-artist-radio-btn");if(b.disabled)return;const w=window.location.hash.split("/")[1];if(!w)return;b.disabled=!0;const T=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Loading...</span>';try{const k=await n.getArtist(w),L=[...k.albums||[],...k.eps||[]];if(L.length===0)throw new Error("No albums or EPs found for this artist");const S=new Set,x=[],P=[],A=3,$=L;for(let _=0;_<$.length;_+=A)P.push($.slice(_,_+A));for(const _ of P)await Promise.all(_.map(async B=>{try{const{tracks:D}=await n.getAlbum(B.id);D.forEach(j=>{S.has(j.id)||(S.add(j.id),x.push(j))})}catch(D){console.warn(`Failed to fetch tracks for album ${B.title}:`,D)}}));if(x.length>0){for(let _=x.length-1;_>0;_--){const B=Math.floor(Math.random()*(_+1));[x[_],x[B]]=[x[B],x[_]]}s.setQueue(x,0),s.playTrackFromQueue()}else throw new Error("No tracks found across all albums")}catch(k){console.error("Artist radio failed:",k),alert("Failed to start artist radio: "+k.message)}finally{document.body.contains(b)&&(b.disabled=!1,b.innerHTML=T)}}if(p.target.closest("#download-discography-btn")){const b=p.target.closest("#download-discography-btn");if(b.disabled)return;const w=window.location.hash.split("/")[1];if(!w)return;try{const T=await n.getArtist(w);mn(T,n,ue.getQuality(),r,b)}catch(T){console.error("Failed to load artist for discography download:",T),alert("Failed to load artist: "+T.message)}}});const d=document.getElementById("search-form"),h=document.getElementById("search-input"),u=ls(p=>{p&&(window.location.hash=`#search/${encodeURIComponent(p)}`)},300);h.addEventListener("input",p=>{const b=p.target.value.trim();b.length>2&&u(b)}),d.addEventListener("submit",p=>{p.preventDefault();const b=h.value.trim();b&&(window.location.hash=`#search/${encodeURIComponent(b)}`)}),window.addEventListener("online",()=>{on(),console.log("Back online")}),window.addEventListener("offline",()=>{rn(),console.log("Gone offline")}),document.querySelector(".play-pause-btn").innerHTML=de;const m=zs(a);m(),window.addEventListener("hashchange",m);const f=[window.location.hash];let g=0;const y=()=>{const p=document.getElementById("nav-back"),b=document.getElementById("nav-forward");p&&(p.disabled=g<=0),b&&(b.disabled=g>=f.length-1)};window.addEventListener("hashchange",()=>{const p=window.location.hash;p!==f[g]&&(g>0&&p===f[g-1]?g--:g<f.length-1&&p===f[g+1]?g++:(g++,f.splice(g),f.push(p)),y())}),y(),e.addEventListener("play",()=>{Rt(s)});const v=tn({onNeedRefresh(){ln(()=>v(!0))},onOfflineReady(){console.log("App ready to work offline")}});let I;window.addEventListener("beforeinstallprompt",p=>{p.preventDefault(),I=p,localStorage.getItem("installPromptDismissed")||cn(I)}),document.getElementById("show-shortcuts-btn")?.addEventListener("click",()=>{kt()}),!localStorage.getItem("shortcuts-shown")&&window.innerWidth>768&&setTimeout(()=>{kt(),localStorage.setItem("shortcuts-shown","true")},3e3),window.addEventListener("library-changed",()=>{const p=window.location.hash;p==="#library"?a.renderLibraryPage():(p==="#home"||p==="")&&a.renderHomePage()}),window.addEventListener("history-changed",()=>{window.location.hash==="#recent"&&a.renderRecentPage()})});function ln(n){const e=document.createElement("div");e.className="update-notification",e.innerHTML=`
        <div>
            <strong>Update Available</strong>
            <p>A new version of Monochrome is available.</p>
        </div>
        <button class="btn-secondary" id="update-now-btn">Update Now</button>
    `,document.body.appendChild(e),document.getElementById("update-now-btn").addEventListener("click",()=>{typeof n=="function"?n():n&&n.postMessage?n.postMessage({action:"skipWaiting"}):window.location.reload()})}function cn(n){if(!n)return;const e=document.createElement("div");e.className="install-prompt",e.innerHTML=`
        <div>
            <strong>Install Monochrome</strong>
            <p>Install this app for a better experience.</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" id="install-btn">Install</button>
            <button class="btn-secondary" id="dismiss-install">Dismiss</button>
        </div>
    `,document.body.appendChild(e),document.getElementById("install-btn").addEventListener("click",async()=>{e.remove(),n.prompt();const{outcome:t}=await n.userChoice;console.log(`User response to install prompt: ${t}`),n=null}),document.getElementById("dismiss-install").addEventListener("click",()=>{e.remove(),localStorage.setItem("installPromptDismissed","true")})}function dn(n){const e=document.getElementById("missing-tracks-modal"),t=document.getElementById("missing-tracks-list-ul");t.innerHTML=n.map(i=>`<li>${i}</li>`).join("");const s=()=>e.classList.remove("active"),a=i=>{(i.target===e||i.target.closest(".close-missing-tracks")||i.target.id==="close-missing-tracks-btn"||i.target.classList.contains("modal-overlay"))&&(s(),e.removeEventListener("click",a))};e.addEventListener("click",a),e.classList.add("active")}async function un(n,e,t){const s=n.trim().split(`
`);if(s.length<2)return[];const a=d=>{const h=[];let u="",m=!1;for(let f=0;f<d.length;f++){const g=d[f];g==='"'?m=!m:g===","&&!m?(h.push(u),u=""):u+=g}return h.push(u),h.map(f=>f.trim().replace(/^"|"$/g,"").replace(/""/g,'"').trim())},i=a(s[0]),r=s.slice(1),l=[],o=[],c=r.length;for(let d=0;d<r.length;d++){const h=r[d];if(!h.trim())continue;const u=a(h);if(u.length>=i.length){let m="",f="",g="";if(i.forEach((y,v)=>{const I=u[v];if(I)switch(y.toLowerCase()){case"track name":case"title":case"song":m=I;break;case"artist name(s)":case"artist name":case"artist":case"artists":f=I;break;case"album":case"album name":g=I;break}}),t&&t({current:d,total:c,currentTrack:m||"Unknown track",currentArtist:f||""}),m&&f){await new Promise(y=>setTimeout(y,300));try{let y=null;const v=p=>p.toLowerCase().replace(/[^\w\s]/g,"").trim(),I=(p,b,w,T)=>{if(!p)return!1;const k=v(p.title||""),L=(p.artists||[]).map(B=>v(B.name||"")).join(" "),S=v(p.album?.name||""),x=v(b),P=v(w),A=v(T||"");return!(k===x||k.includes(x)||x.includes(k))||!(L.includes(P.split(" ")[0])||P.includes(L.split(" ")[0]))?!1:A?S===A||S.includes(A)||A.includes(S):!0};if(!y){let p=`${m} ${f}`;g&&(p+=` ${g}`);const b=await e.searchTracks(p);if(b.items&&b.items.length>0){for(const w of b.items)if(I(w,m,f,g)){y=w;break}if(!y&&g){const w=b.items[0];I(w,m,f,g)&&(y=w)}}}if(!y&&f){const p=f.split(",")[0].trim();if(p&&p!==f){let b=`${m} ${p}`;g&&(b+=` ${g}`);const w=await e.searchTracks(b);if(w.items&&w.items.length>0){for(const T of w.items)if(I(T,m,p,g)){y=T,console.log(`Found (Retry 1 - Main Artist): ${m}`);break}}}}if(!y&&g){const p=`${m} ${g}`,b=await e.searchTracks(p);if(b.items&&b.items.length>0){for(const w of b.items)if(I(w,m,f,g)){y=w,console.log(`Found (Retry 2 - Album): ${m}`);break}}}if(!y&&m.includes(" - ")){const p=(f||"").split(",")[0].trim(),b=m.split(" - ")[0].trim();if(b){let w=`${b} ${p}`;g&&(w+=` ${g}`);const T=await e.searchTracks(w);if(T.items&&T.items.length>0){for(const k of T.items)if(I(k,b,p,g)){y=k,console.log(`Found (Retry 3 - Cleaned Title): ${m}`);break}}}}if(!y){const p=(f||"").split(",")[0].trim(),b=`${m} ${p}`,w=await e.searchTracks(b);if(w.items&&w.items.length>0)for(const T of w.items){const k=v(T.title||""),L=v(m);if(k===L){y=T,console.log(`Found (Retry 4 - Title Match): ${m}`);break}}}y?(l.push(y),console.log(`✓ "${m}" by ${f}${g?" ["+g+"]":""}`)):(console.warn(`✗ Track not found: "${m}" by ${f}${g?" ["+g+"]":""}`),o.push(`${m} - ${f}${g?" (album: "+g+")":""}`))}catch(y){console.error(`Error searching for track "${m}":`,y),o.push(`${m} - ${f}${g?" (album: "+g+")":""}`)}}}}return t&&t({current:c,total:c,currentTrack:"Import complete"}),{tracks:l,missingTracks:o}}function mn(n,e,t,s,a){const i=document.getElementById("discography-download-modal");document.getElementById("discography-artist-name").textContent=n.name,document.getElementById("albums-count").textContent=n.albums?.length||0,document.getElementById("eps-count").textContent=(n.eps||[]).filter(o=>o.type==="EP").length,document.getElementById("singles-count").textContent=(n.eps||[]).filter(o=>o.type==="SINGLE").length,document.getElementById("download-albums").checked=!0,document.getElementById("download-eps").checked=!0,document.getElementById("download-singles").checked=!0;const r=()=>{i.classList.remove("active")},l=o=>{(o.target===i||o.target.classList.contains("modal-overlay")||o.target.closest(".close-modal-btn")||o.target.id==="cancel-discography-download")&&r()};i.addEventListener("click",l),document.getElementById("start-discography-download").onclick=async()=>{const o=document.getElementById("download-albums").checked,c=document.getElementById("download-eps").checked,d=document.getElementById("download-singles").checked;if(!o&&!c&&!d){alert("Please select at least one type of release to download.");return}r();let h=[];o&&(h=h.concat(n.albums||[])),c&&(h=h.concat((n.eps||[]).filter(m=>m.type==="EP"))),d&&(h=h.concat((n.eps||[]).filter(m=>m.type==="SINGLE"))),a.disabled=!0;const u=a.innerHTML;a.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{await Ut(n,h,e,t,s)}catch(m){console.error("Discography download failed:",m),alert("Failed to download discography: "+m.message)}finally{a.disabled=!1,a.innerHTML=u}},i.classList.add("active")}function kt(){const n=document.getElementById("shortcuts-modal"),e=()=>{n.classList.remove("active"),n.removeEventListener("click",t)},t=s=>{(s.target===n||s.target.classList.contains("close-shortcuts")||s.target.classList.contains("modal-overlay"))&&e()};n.addEventListener("click",t),n.classList.add("active")}
